var BAM_MAGIC=21840194,BAI_MAGIC=21578050;function BamFile(){}function Vob(a,b){this.block=a;this.offset=b}Vob.prototype.toString=function(){return""+this.block+":"+this.offset};function Chunk(a,b){this.minv=a;this.maxv=b}
function makeBam(a,b,c){var d=new BamFile;d.data=a;d.bai=b;d.data.slice(0,65536).fetch(function(a){if(!a)return dlog("Couldn't access BAM");a=unbgzf(a);a=new Uint8Array(a);readInt(a,0);for(var b=readInt(a,4),h="",g=0;g<b;++g)h+=String.fromCharCode(a[g+8]);h=readInt(a,b+8);b+=12;d.chrToIndex={};d.indexToChr=[];for(g=0;g<h;++g){for(var m=readInt(a,b),p="",v=0;v<m-1;++v)p+=String.fromCharCode(a[b+4+v]);readInt(a,b+m+4);d.chrToIndex[p]=g;0==p.indexOf("chr")?d.chrToIndex[p.substring(3)]=g:d.chrToIndex["chr"+
p]=g;d.indexToChr.push(p);b=b+8+m}if(d.indices)return c(d)});d.bai.fetch(function(a){if(!a)return dlog("Couldn't access BAI");var b=new Uint8Array(a);if(readInt(b,0)!=BAI_MAGIC)return dlog("Not a BAI file");var h=readInt(b,4);d.indices=[];for(var g=8,m=0;m<h;++m){for(var p=g,v=readInt(b,g),g=g+4,u=0;u<v;++u){readInt(b,g);var q=readInt(b,g+4),g=g+(8+16*q)}u=readInt(b,g);g+=4;g+=8*u;0<v&&(d.indices[m]=new Uint8Array(a,p,g-p))}if(d.chrToIndex)return c(d)})}
BamFile.prototype.blocksForRange=function(a,b,c){var d=this.indices[a];if(!d)return[];a=reg2bins(b,c);for(var e=[],f=0;f<a.length;++f)e[a[f]]=!0;a=[];for(var h=[],f=readInt(d,0),g=4,m=0;m<f;++m){var p=readInt(d,g),v=readInt(d,g+4),g=g+8;if(e[p])for(var u=0;u<v;++u){var q=readVob(d,g),r=readVob(d,g+8);(4681>p?h:a).push(new Chunk(q,r));g+=16}else g+=16*v}f=readInt(d,g);e=null;b=Math.min(b>>14,f-1);c=Math.min(c>>14,f-1);for(f=b;f<=c;++f)if((b=readVob(d,g+4+8*f))&&(!e||b.block<e.block||b.offset<e.offset))e=
b;d=[];if(null!=e)for(f=0;f<h.length;++f)c=h[f],c.maxv.block>=e.block&&c.maxv.offset>=e.offset&&d.push(c);h=d;d=[];for(f=0;f<h.length;++f)d.push(h[f]);for(f=0;f<a.length;++f)d.push(a[f]);d.sort(function(a,b){var c=a.minv.block-b.minv.block;return 0!=c?c:a.minv.offset-b.minv.offset});a=[];if(0<d.length){h=d[0];for(f=1;f<d.length;++f)c=d[f],c.minv.block==h.maxv.block?h=new Chunk(h.minv,c.maxv):(a.push(h),h=c);a.push(h)}return a};
BamFile.prototype.fetch=function(a,b,c,d){function e(){if(p>=g.length)return d(m);if(v){var a=new Uint8Array(v);f.readBamRecords(a,g[p].minv.offset,m,b,c,h);v=null;++p;return e()}var q=g[p],a=q.minv.block;f.data.slice(a,q.maxv.block+65536-a).fetch(function(a){v=unbgzf(a,q.maxv.block-q.minv.block+1);return e()})}var f=this,h=this.chrToIndex[a],g;void 0===h?g=[]:(g=this.blocksForRange(h,b,c))||d(null,"Error in index fetch");var m=[],p=0,v;e()};
var SEQRET_DECODER="=ACxGxxxTxxxxxxN".split(""),CIGAR_DECODER="MIDNSHP=X???????".split("");function BamRecord(){}
BamFile.prototype.readBamRecords=function(a,b,c,d,e,f){for(;;){var h=readInt(a,b),h=b+h+4;if(h>=a.length)return c;var g=new BamRecord,m=readInt(a,b+4),p=readInt(a,b+8),v=readInt(a,b+12),u=(v&65280)>>8,q=v&255,r=readInt(a,b+16)&65535,v=readInt(a,b+20);readInt(a,b+24);readInt(a,b+28);readInt(a,b+32);for(var t="",y=0;y<q-1;++y)t+=String.fromCharCode(a[b+36+y]);b=b+36+q;y="";for(q=0;q<r;++q){var x=readInt(a,b),y=y+(x>>4)+CIGAR_DECODER[x&15];b+=4}g.cigar=y;r="";q=v+1>>1;for(y=0;y<q;++y)x=a[b+y],r+=SEQRET_DECODER[(x&
240)>>4],r+=SEQRET_DECODER[x&15];b+=q;g.seq=r;r="";for(y=0;y<v;++y)r+=String.fromCharCode(a[b+y]);b+=v;g.quals=r;g.pos=p;g.mq=u;g.readName=t;for(g.segment=this.indexToChr[m];b<h;){p=String.fromCharCode(a[b])+String.fromCharCode(a[b+1]);u=String.fromCharCode(a[b+2]);if("A"==u)u=String.fromCharCode(a[b+3]),b+=4;else if("i"==u||"I"==u)u=readInt(a,b+3),b+=7;else if("c"==u||"C"==u)u=a[b+3],b+=4;else if("s"==u||"S"==u)u=readShort(a,b+3),b+=5;else{if("f"==u)throw"FIXME need floats";if("Z"==u){b+=3;for(u=
"";!(t=a[b++],0==t);)u+=String.fromCharCode(t)}else throw"Unknown type "+u;}g[p]=u}if(!d||g.pos<=e&&g.pos+v>=d)(void 0===f||m==f)&&c.push(g);b=h}};function readInt(a,b){return a[b+3]<<24|a[b+2]<<16|a[b+1]<<8|a[b]}function readShort(a,b){return a[b+1]<<8|a[b]}function readVob(a,b){var c=4294967296*(a[b+6]&255)+16777216*(a[b+5]&255)+65536*(a[b+4]&255)+256*(a[b+3]&255)+(a[b+2]&255),d=a[b+1]<<8|a[b];return 0==c&&0==d?null:new Vob(c,d)}
function unbgzf(a,b){b=Math.min(b||1,a.byteLength-100);for(var c=[],d=[0],e=0;d[0]<b;){var f=new Uint8Array(a,d[0],100),f=f[11]<<8|f[10],f=jszlib_inflate_buffer(a,12+f+d[0],Math.min(65536,a.byteLength-12-f-d[0]),d);d[0]+=8;e+=f.byteLength;c.push(f)}if(1==c.length)return c[0];d=new Uint8Array(e);for(f=e=0;f<c.length;++f){var h=new Uint8Array(c[f]);arrayCopy(h,0,d,e,h.length);e+=h.length}return d.buffer}
function reg2bin(a,b){--b;return a>>14==b>>14?4681+(a>>14):a>>17==b>>17?585+(a>>17):a>>20==b>>20?73+(a>>20):a>>23==b>>23?9+(a>>23):a>>26==b>>26?1+(a>>26):0}var MAX_BIN=37449;function reg2bins(a,b){var c,d=[];--b;d.push(0);for(c=1+(a>>26);c<=1+(b>>26);++c)d.push(c);for(c=9+(a>>23);c<=9+(b>>23);++c)d.push(c);for(c=73+(a>>20);c<=73+(b>>20);++c)d.push(c);for(c=585+(a>>17);c<=585+(b>>17);++c)d.push(c);for(c=4681+(a>>14);c<=4681+(b>>14);++c)d.push(c);return d}
var BIG_WIG_MAGIC=-2003829722,BIG_BED_MAGIC=-2021002517,BIG_WIG_TYPE_GRAPH=1,BIG_WIG_TYPE_VSTEP=2,BIG_WIG_TYPE_FSTEP=3;function BigWig(){}
BigWig.prototype.readChromTree=function(a){var b=this;this.chromsToIDs={};this.idsToChroms={};for(var c=this.unzoomedDataOffset;0!=c%4;)++c;this.data.slice(this.chromTreeOffset,c-this.chromTreeOffset).fetch(function(c){var e=new Uint8Array(c),f=new Int16Array(c),h=new Int32Array(c),g=h[2],m=function(a){var c=e[a],d=f[a/2+1];a+=4;for(var q=0;q<d;++q)if(0==c){a+=g;var r=h[a/4]<<32|h[a/4+1];a+=8;r-=b.chromTreeOffset;m(r)}else{for(var r="",t=0;t<g;++t){var y=e[a++];0!=y&&(r+=String.fromCharCode(y))}t=
e[a+3]<<24|e[a+2]<<16|e[a+1]<<8|e[a+0];a+=8;b.chromsToIDs[r]=t;0==r.indexOf("chr")&&(b.chromsToIDs[r.substr(3)]=t);b.idsToChroms[t]=r}};m(32);a(b)})};function BigWigView(a,b,c,d){this.bwg=a;this.cirTreeOffset=b;this.cirTreeLength=c;this.isSummary=d}BED_COLOR_REGEXP=/^[0-9]+,[0-9]+,[0-9]+/;BigWigView.prototype.readWigData=function(a,b,c,d){a=this.bwg.chromsToIDs[a];if(void 0===a)return d([]);this.readWigDataById(a,b,c,d)};
BigWigView.prototype.readWigDataById=function(a,b,c,d){var e=this;if(this.cirHeader){var f=[],h=0;Date.now();var g=function(a,b){h+=a.length;for(var c=4+32*e.cirBlockSize,d,f=0;f<a.length;++f){var g=new Range(a[f],Math.min(a[f]+c,e.cirTreeOffset+e.cirTreeLength));d=d?union(d,g):g}c=d.ranges();for(d=0;d<c.length;++d)m(a,c[d],b)},m=function(d,m,q,r){m.max();m.min();e.bwg.data.slice(m.min(),m.max()-m.min()).fetch(function(e){for(var r=0;r<d.length;++r)if(m.contains(d[r])){var x=e,w=d[r]-m.min(),s=q,
z=new Int8Array(x),B=new Int16Array(x),x=new Int32Array(x),z=z[w],B=B[w/2+1],w=w+4;if(0!=z)for(z=0;z<B;++z){var C=w/4,H=x[C],D=x[C+1],G=x[C+2],F=x[C+3],E=x[C+4]<<32|x[C+5],s=x[C+6]<<32|x[C+7];(H<a||H==a&&D<=c)&&(G>a||G==a&&F>=b)&&f.push({offset:E,size:s});w+=32}else{for(var A=[],z=0;z<B;++z)C=w/4,H=x[C],D=x[C+1],G=x[C+2],F=x[C+3],E=x[C+4]<<32|x[C+5],(H<a||H==a&&D<=c)&&(G>a||G==a&&F>=b)&&A.push(E),w+=24;0<A.length&&g(A,s+1)}--h;0==h&&p()}})},p=function(){f.sort(function(a,b){return(a.offset|0)-(b.offset|
0)});if(0==f.length)d([]);else{var g=[],h=function(b,c,d){d||(d={});var f=new DASFeature;f.segment=e.bwg.idsToChroms[a];f.min=b;f.max=c;f.type="bigwig";for(k in d)f[k]=d[k];g.push(f)},m=function(a,e,d){a<=c&&e>=b&&h(a,e,d)},p=function(){if(0==f.length)Date.now(),d(g);else{var t=f[0];if(t.data){var y=new Uint8Array(t.data);if(e.isSummary)for(var x=new Int16Array(t.data),w=new Int32Array(t.data),s=new Float32Array(t.data),y=t.data.byteLength/32,x=0;x<y;++x){var z=w[8*x],t=w[8*x+1],B=w[8*x+2],C=w[8*
x+3],H=s[8*x+6];z==a&&(z={type:"bigwig",score:H/C},"bigbed"==e.bwg.type&&(z.type="density"),m(t,B,z))}else if("bigwig"==e.bwg.type)if(x=new Int16Array(t.data),w=new Int32Array(t.data),s=new Float32Array(t.data),z=w[0],t=w[1],z=w[3],B=w[4],C=y[20],y=x[11],C==BIG_WIG_TYPE_FSTEP)for(x=0;x<y;++x)C=s[x+6],m(t+x*z,t+x*z+B,{score:C});else if(C==BIG_WIG_TYPE_VSTEP)for(x=0;x<y;++x)t=w[2*x+6],C=s[2*x+7],m(t,t+B,{score:C});else if(C==BIG_WIG_TYPE_GRAPH)for(x=0;x<y;++x)t=w[3*x+6]+1,B=w[3*x+7],C=s[3*x+8],t>B&&
(t=B),m(t,B,{score:C});else dlog("Currently not handling bwgType="+C);else if("bigbed"==e.bwg.type)for(w=0;w<y.length;){z=y[w+3]<<24|y[w+2]<<16|y[w+1]<<8|y[w+0];t=y[w+7]<<24|y[w+6]<<16|y[w+5]<<8|y[w+4];B=y[w+11]<<24|y[w+10]<<16|y[w+9]<<8|y[w+8];w+=12;for(x="";;)if(s=y[w++],0!=s)x+=String.fromCharCode(s);else break;var s={},D=x.split("\t");0<D.length&&(s.label=D[0]);1<D.length&&(s.score=stringToInt(D[1]));2<D.length&&(s.orientation=D[2]);5<D.length&&(x=D[5],BED_COLOR_REGEXP.test(x)&&(s.override_color=
"rgb("+x+")"));if(9>D.length)z==a&&m(t+1,B,s);else if(z==a&&t<=c&&B>=b){B=D[3]|0;z=D[4]|0;x=D[6]|0;C=D[7].split(",");H=D[8].split(",");s.type="bb-transcript";var G=new DASGroup;G.id=D[0];G.type="bb-transcript";G.notes=[];s.groups=[G];if(10<D.length){var G=D[9],D=D[10],F=new DASGroup;F.id=G;F.label=D;F.type="gene";s.groups.push(F)}D=null;for(G=0;G<x;++G)F=(H[G]|0)+t,F=new Range(F,F+(C[G]|0)),D=D?union(D,F):F;C=D.ranges();for(t=0;t<C.length;++t)x=C[t],h(x.min()+1,x.max(),s);if(z>B&&(t=intersection(D,
new Range(B,z)))){s.type="bb-translation";B=t.ranges();for(t=0;t<B.length;++t)x=B[t],h(x.min()+1,x.max(),s)}}}else dlog("Don't know what to do with "+e.bwg.type);f.splice(0,1);p()}else{for(var y=t.offset,E=t.size,t=1;t<f.length&&f[t].offset==y+E;)E+=f[t].size,++t;e.bwg.data.slice(y,E).fetch(function(a){for(var b=0,c=0;b<E;){var d=f[c],g;0<e.bwg.uncompressBufSize?g=jszlib_inflate_buffer(a,b+2,d.size-2):(g=new Uint8Array(d.size),arrayCopy(new Uint8Array(a,b,d.size),0,g,0,d.size),g=g.buffer);d.data=
g;b+=d.size;++c}p()})}}};p()}};g([e.cirTreeOffset+48],1)}else this.bwg.data.slice(this.cirTreeOffset,48).fetch(function(f){e.cirHeader=f;f=new Int32Array(e.cirHeader);e.cirBlockSize=f[1];e.readWigDataById(a,b,c,d)})};BigWigView.prototype.getFirstAdjacent=function(a,b,c,d){a=this.bwg.chromsToIDs[a];if(void 0===a)return d([]);this.getFirstAdjacentById(a,b,c,d)};
BigWigView.prototype.getFirstAdjacentById=function(a,b,c,d){var e=this;if(this.cirHeader){var f=null,h=-1,g=-1,m=0;Date.now();var p=function(a,b){m+=a.length;for(var c=4+32*e.cirBlockSize,d,f=0;f<a.length;++f){var g=new Range(a[f],Math.min(a[f]+c,e.cirTreeOffset+e.cirTreeLength));d=d?union(d,g):g}c=d.ranges();for(d=0;d<c.length;++d)v(a,c[d],b)},v=function(d,r,t,v){r.max();r.min();e.bwg.data.slice(r.min(),r.max()-r.min()).fetch(function(v){for(var w=0;w<d.length;++w)if(r.contains(d[w])){var s=v,y=
d[w]-r.min(),B=t,C=new Int8Array(s),H=new Int16Array(s),s=new Int32Array(s),C=C[y],H=H[y/2+1],y=y+4;if(0!=C)for(C=0;C<H;++C){var D=y/4,G=s[D],F=s[D+1],E=s[D+2],A=s[D+3],M=s[D+4]<<32|s[D+5],B=s[D+6]<<32|s[D+7];if((0>c&&(G<a||G==a&&F<=b)||0<c&&(E>a||E==a&&A>=b))&&!/_random/.exec(e.bwg.idsToChroms[G]))if(null==f||0>c&&(E>h||E==h&&A>g)||0<c&&(G<h||G==h&&F<g))f={offset:M,size:B},g=0>c?A:F,h=0>c?E:G;y+=32}else{for(var L=-1,N=-1,C=0;C<H;++C){D=y/4;G=s[D];F=s[D+1];E=s[D+2];A=s[D+3];M=s[D+4]<<32|s[D+5];if(0>
c&&(G<a||G==a&&F<=b)&&E>=a||0<c&&(E>a||E==a&&A>=b)&&G<=a)if(0>L||A>N)L=M,N=0>c?A:F;y+=24}0<=L&&p([L],B+1)}--m;0==m&&u()}})},u=function(){if(null==f)return dlog("got nothing");var g=[f];g.sort(function(a,b){return(a.offset|0)-(b.offset|0)});if(0==g.length)d([]);else{var h=null,m=-1,p=-1,u=function(d,f,g,q){if(0>c&&(d<a||g<b)||0<c&&(d>a||f>b)){q||(q={});var u=new DASFeature;u.segment=e.bwg.idsToChroms[d];u.min=f;u.max=g;u.type="bigwig";for(k in q)u[k]=q[k];if(null==h||0>c&&(d>m||g>p)||0<c&&(d<m||f<
p))h=u,p=0>c?g:f,m=d}},v=function(){if(0==g.length)Date.now(),d([h]);else{var a=g[0];if(a.data){var b=new Uint8Array(a.data);if(e.isSummary)for(var c=new Int16Array(a.data),f=new Int32Array(a.data),m=new Float32Array(a.data),b=a.data.byteLength/32,c=0;c<b;++c){var a=f[8*c],p=f[8*c+1],t=f[8*c+2],y={type:"bigwig",score:m[8*c+6]/f[8*c+3]};"bigbed"==e.bwg.type&&(y.type="density");u(a,p,t,y)}else if("bigwig"==e.bwg.type){var c=new Int16Array(a.data),f=new Int32Array(a.data),m=new Float32Array(a.data),
a=f[0],p=f[1],y=f[3],t=f[4],E=b[20],b=c[11];if(E==BIG_WIG_TYPE_FSTEP)for(c=0;c<b;++c)E=m[c+6],u(a,p+c*y,p+c*y+t,{score:E});else if(E==BIG_WIG_TYPE_VSTEP)for(c=0;c<b;++c)p=f[2*c+6],E=m[2*c+7],u(p,p+t,{score:E});else if(E==BIG_WIG_TYPE_GRAPH)for(c=0;c<b;++c)p=f[3*c+6]+1,t=f[3*c+7],E=m[3*c+8],p>t&&(p=t),u(p,t,{score:E});else dlog("Currently not handling bwgType="+E)}else if("bigbed"==e.bwg.type)for(f=0;f<b.length;){a=b[f+3]<<24|b[f+2]<<16|b[f+1]<<8|b[f+0];p=b[f+7]<<24|b[f+6]<<16|b[f+5]<<8|b[f+4];t=b[f+
11]<<24|b[f+10]<<16|b[f+9]<<8|b[f+8];f+=12;for(m="";;)if(c=b[f++],0!=c)m+=String.fromCharCode(c);else break;c={};m=m.split("\t");0<m.length&&(c.label=m[0]);1<m.length&&(c.score=100);2<m.length&&(c.orientation=m[2]);u(a,p+1,t,c)}else dlog("Don't know what to do with "+e.bwg.type);g.splice(0,1);v()}else{for(var b=a.offset,A=a.size,a=1;a<g.length&&g[a].offset==b+A;)A+=g[a].size,++a;e.bwg.data.slice(b,A).fetch(function(a){for(var b=0,c=0;b<A;){var d=g[c],f;0<e.bwg.uncompressBufSize?f=jszlib_inflate_buffer(a,
b+2,d.size-2):(f=new Uint8Array(d.size),arrayCopy(new Uint8Array(a,b,d.size),0,f,0,d.size),f=f.buffer);d.data=f;b+=d.size;++c}v()})}}};v()}};p([e.cirTreeOffset+48],1)}else this.bwg.data.slice(this.cirTreeOffset,48).fetch(function(b){e.cirHeader=b;b=new Int32Array(e.cirHeader);e.cirBlockSize=b[1];e.readWigDataById(a,min,max,d)})};BigWig.prototype.readWigData=function(a,b,c,d){this.getUnzoomedView().readWigData(a,b,c,d)};
BigWig.prototype.getUnzoomedView=function(){if(!this.unzoomedView){var a=4E3;this.zoomLevels[0]&&(a=this.zoomLevels[0].dataOffset-this.unzoomedIndexOffset);this.unzoomedView=new BigWigView(this,this.unzoomedIndexOffset,a,!1)}return this.unzoomedView};BigWig.prototype.getZoomedView=function(a){var b=this.zoomLevels[a];b.view||(b.view=new BigWigView(this,b.indexOffset,this.zoomLevels[a+1].dataOffset-b.indexOffset,!0));return b.view};
function makeBwgFromURL(a,b,c){makeBwg(new URLFetchable(a,{credentials:c}),b,a)}function makeBwgFromFile(a,b){makeBwg(new BlobFetchable(a),b,"file")}
function makeBwg(a,b,c){var d=new BigWig;d.data=a;d.name=c;d.data.slice(0,512).fetch(function(a){if(!a)return b(null,"Couldn't fetch file");var c=new Int16Array(a);a=new Int32Array(a);a[0]==BIG_WIG_MAGIC?d.type="bigwig":a[0]==BIG_BED_MAGIC?d.type="bigbed":b(null,"Not a supported format");d.version=c[2];d.numZoomLevels=c[3];d.chromTreeOffset=a[2]<<32|a[3];d.unzoomedDataOffset=a[4]<<32|a[5];d.unzoomedIndexOffset=a[6]<<32|a[7];d.fieldCount=c[16];d.definedFieldCount=c[17];d.asOffset=a[9]<<32|a[10];d.totalSummaryOffset=
a[11]<<32|a[12];d.uncompressBufSize=a[13];d.zoomLevels=[];for(c=0;c<d.numZoomLevels;++c)d.zoomLevels.push({reduction:a[6*c+16],dataOffset:a[6*c+18]<<32|a[6*c+19],indexOffset:a[6*c+20]<<32|a[6*c+21]});d.readChromTree(function(){return b(d)})})}function BlobFetchable(a){this.blob=a}BlobFetchable.prototype.slice=function(a,b){var c;c=b?this.blob.webkitSlice(a,a+b):this.blob.webkitSlice(a);return new BlobFetchable(c)};
BlobFetchable.prototype.fetch=function(a){var b=new FileReader;b.onloadend=function(c){a(bstringToBuffer(b.result))};b.readAsBinaryString(this.blob)};function URLFetchable(a,b,c,d){d||("object"===typeof b?(d=b,b=void 0):d={});this.url=a;this.start=b||0;c&&(this.end=c);this.opts=d}URLFetchable.prototype.slice=function(a,b){var c=this.start,d=this.end,c=c&&a?c+a:a||c;return new URLFetchable(this.url,c,b&&c?c+b-1:d||b-1,this.opts)};
URLFetchable.prototype.fetch=function(a,b,c){var d=this;b=b||1;if(3<b)return a(null);var e=new XMLHttpRequest,f;e.open("GET",this.url,!0);e.overrideMimeType("text/plain; charset=x-user-defined");this.end&&(e.setRequestHeader("Range","bytes="+this.start+"-"+this.end),f=this.end-this.start+1);e.responseType="arraybuffer";e.onreadystatechange=function(){if(4==e.readyState){if(200==e.status||206==e.status){if(e.response)return a(e.response);if(e.mozResponseArrayBuffer)return a(e.mozResponseArrayBuffer);
var h=e.responseText;return f&&f!=h.length&&(!c||h.length!=c)?d.fetch(a,b+1,h.length):a(bstringToBuffer(e.responseText))}return d.fetch(a,b+1)}};this.opts.credentials&&(e.withCredentials=!0);e.send("")};function bstringToBuffer(a){if(!a)return null;for(var b=new Uint8Array(a.length),c=0;c<b.length;++c)b[c]=a.charCodeAt(c);return b.buffer}var NS_SVG="http://www.w3.org/2000/svg",NS_HTML="http://www.w3.org/1999/xhtml",NS_XLINK="http://www.w3.org/1999/xlink";MAX_VIEW_SIZE=5E5;
function Browser(a){a||(a={});this.sources=[];this.tiers=[];this.cookieKey="browser";this.karyoEndpoint=new DASSource("http://www.derkholm.net:8080/das/hsa_54_36p/");this.registry="http://www.dasregistry.org/das/sources";this.coordSystem={speciesName:"Human",taxon:9606,auth:"NCBI",version:"36"};this.chains={};this.exportServer="http://www.biodalliance.org:8765/";this.pageName="svgHolder";this.maxExtra=1.5;this.minExtra=0.2;this.zoomFactor=1;this.origin=0;this.targetQuantRes=5;this.featurePanelWidth=
750;this.zoomBase=100;this.zoomExpt=30;this.entryPoints=null;this.currentSeqMax=-1;this.highlight=!1;this.highlightMax=this.highlightMin=-1;this.autoSizeTiers=!1;this.guidelineStyle="foreground";this.guidelineSpacing=75;this.fgGuide=null;this.positionFeedback=!1;this.selectedTier=1;this.placards=[];this.tierBackgroundColors=["rgb(245,245,245)","rgb(230,230,250)"];this.minTierHeight=25;this.tabMargin=120;this.browserLinks={Ensembl:"http://ncbi36.ensembl.org/Homo_sapiens/Location/View?r=${chr}:${start}-${end}",
UCSC:"http://genome.ucsc.edu/cgi-bin/hgTracks?db=hg18&position=chr${chr}:${start}-${end}"};this.iconsURI="http://www.biodalliance.org/resources/icons.svg";this.availableSources=new Observed;this.defaultSources=[];this.mappableSources={};for(var b in a)this[b]=a[b];var c=this;window.addEventListener("load",function(a){c.realInit()},!1)}function formatQuantLabel(a){a=""+a;var b=a.indexOf(".");if(0>b)return a;var c=2;"-"==a.substring(0,1)&&++c;return b>=c?a.substring(0,b):a.substring(0,b+2)}
Browser.prototype.labelForTier=function(a,b,c){var d=this.tabMargin,e=document.createElementNS(NS_SVG,"path");e.setAttribute("d","M 15 2 L 10 7 L 10 18 L 15 22 L "+(10+d)+" 22 L "+(10+d)+" 2 Z");d=this.tierBackgroundColors[b%this.tierBackgroundColors.length];b==this.selectedTier&&(d="rgb(240, 200, 200)");e.setAttribute("fill",d);e.setAttribute("stroke","none");c.appendChild(e);this.setupTierDrag(e,b);e=!1;if(a.dasSource.collapseSuperGroups||a.hasBumpedFeatures)e=!0,this.makeToggleButton(c,a,0);if(a.isQuantitative){e=
!0;d=makeElementNS(NS_SVG,"g");d.appendChild(makeElementNS(NS_SVG,"rect",null,{x:this.tabMargin-25,y:0,width:25,height:a.layoutHeight,stroke:"none",fill:this.tierBackgroundColors[b%this.tierBackgroundColors.length]}));c.appendChild(d);d.appendChild(makeElementNS(NS_SVG,"line",null,{x1:this.tabMargin,y1:0+(a.clientMin|0),x2:this.tabMargin,y2:0+(a.clientMax|0),strokeWidth:1}));d.appendChild(makeElementNS(NS_SVG,"line",null,{x1:this.tabMargin-5,y1:0+(a.clientMin|0),x2:this.tabMargin,y2:0+(a.clientMin|
0),strokeWidth:1}));d.appendChild(makeElementNS(NS_SVG,"line",null,{x1:this.tabMargin-3,y1:0+((a.clientMin|0)+(a.clientMax|0))/2,x2:this.tabMargin,y2:0+((a.clientMin|0)+(a.clientMax|0))/2,strokeWidth:1}));d.appendChild(makeElementNS(NS_SVG,"line",null,{x1:this.tabMargin-5,y1:0+(a.clientMax|0),x2:this.tabMargin,y2:0+(a.clientMax|0),strokeWidth:1}));var f=makeElementNS(NS_SVG,"text",formatQuantLabel(a.min),{x:80,y:a.clientMin|0,strokeWidth:0,fill:"black",fontSize:"8pt"});d.appendChild(f);b=f.getBBox();
f.setAttribute("x",this.tabMargin-b.width-7);f.setAttribute("y",(a.clientMin|0)+b.height/2-4);f=makeElementNS(NS_SVG,"text",formatQuantLabel(a.max),{x:80,y:a.clientMax|0,strokeWidth:0,fill:"black",fontSize:"8pt"});d.appendChild(f);f.setAttribute("x",this.tabMargin-f.getBBox().width-3);b=f.getBBox();f.setAttribute("x",this.tabMargin-b.width-7);f.setAttribute("y",(a.clientMax|0)+b.height/2-1);var h=this.icons.createIcon("magnifier",c);h.setAttribute("transform","translate("+(this.tabMargin-18)+", "+
(a.layoutHeight/2-8)+"), scale(0.6,0.6)");h.addEventListener("mouseover",function(a){h.setAttribute("fill","red")},!1);h.addEventListener("mouseout",function(a){h.setAttribute("stroke","gray")},!1);d.appendChild(h);this.makeQuantConfigButton(d,a,0);this.makeTooltip(d,"Click to adjust how this data is displayed")}b=this.tabMargin-20;e&&(b-=20);a=a.dasSource.name;e=document.createElementNS(NS_SVG,"text");e.setAttribute("x",15);e.setAttribute("y",17);e.setAttribute("stroke-width",0);e.setAttribute("fill",
"black");e.appendChild(document.createTextNode(a));e.setAttribute("pointer-events","none");c.appendChild(e);try{for(;e.getBBox().width>b;)removeChildren(e),a=a.substring(0,a.length-1),e.appendChild(document.createTextNode(a+"..."))}catch(g){}return c};
Browser.prototype.arrangeTiers=function(){for(var a=this.svgRoot,b=0;b<this.placards.length;++b)a.removeChild(this.placards[b]);this.placards=[];var b=this.dasLabelHolder,c=50;for(ti=0;ti<this.tiers.length;++ti){var d=this.tiers[ti];d.y=c;d.isLabelValid||(d.label&&b.removeChild(d.label),d.label=makeElementNS(NS_SVG,"g"),b.appendChild(d.label),this.labelForTier(d,ti,d.label));this.xfrmTier(d,this.tabMargin-1*(this.viewStart-this.origin)*this.scale,-1);d.placard&&(d.placard.setAttribute("transform",
"translate("+this.tabMargin+", "+(c+d.layoutHeight-4)+")"),a.appendChild(d.placard),this.placards.push(d.placard));c+=d.layoutHeight}this.featureBackground.setAttribute("height",(c|0)-50);150>c&&(c=150);this.browserFrameHeight!=c&&(this.svgRoot.setAttribute("height",""+((c|0)+10)+"px"),this.svgBackground.setAttribute("height",""+((c|0)+10)),this.featureClipRect.setAttribute("height",""+((c|0)-10)),this.labelClipRect.setAttribute("height",""+((c|0)-10)),this.browserFrameHeight=c)};
Browser.prototype.offsetForTier=function(a){for(var b=50,c=0;c<a;++c)b+=this.tiers[c].layoutHeight;return b};
Browser.prototype.tierInfoPopup=function(a,b){var c,d=[];a.dasSource.desc&&d.push(a.dasSource.desc);var e=this.availableSources.get();a.dasSource.mapping&&(e=this.chains[a.dasSource.mapping].coords,d.push(makeElement("p",makeElement("i","Mapped from "+e.auth+e.version))),e=this.mappableSources[a.dasSource.mapping].get());if(!e||0==e)c=makeElement("p","Registry data not available");else{for(var f=0;f<e.length;++f){var h=e[f];if(h.uri==a.dasSource.uri&&h.source_uri){c=makeElement("p",makeElement("a",
"Registry entry: "+h.name,{href:"http://www.dasregistry.org/showdetails.jsp?auto_id="+h.source_uri,target:"_new"}));break}}c||(c=makeElement("p","No registry information for this source"))}d.push(c);this.popit(b,a.dasSource.name,d,{width:300})};
Browser.prototype.setupTierDrag=function(a,b){var c=this,d,e,f,h=null,g=this.tiers[b],m=function(a){a=(a.clientY+window.scrollY-d|0)-50;for(var b=0;b<c.tiers.length&&a>c.tiers[b].layoutHeight;)a-=c.tiers[b].layoutHeight,++b;b!=f&&(f=b,e.setAttribute("y",c.offsetForTier(f)-2))},p=!1,v=function(a){c.bin.setAttribute("stroke","red");e.setAttribute("fill","none");p=!0},u=function(a){c.bin.setAttribute("stroke","gray");e.setAttribute("fill","red");p=!1},q=function(a){window.removeEventListener("mousemove",
m,!0);window.removeEventListener("mouseup",q,!0);c.bin.removeEventListener("mouseover",v,!0);c.bin.removeEventListener("mouseout",u,!0);c.bin.setAttribute("stroke","gray");if(h)clearTimeout(h),h=null,c.tierInfoPopup(g,a);else if(c.popupHolder.removeChild(e),p)c.removeTier(c.tiers[b]);else if(f!=b){a=[];var d=0;for(f>b&&--f;a.length<c.tiers.length;)a.length==f?a.push(c.tiers[b]):(d!=b&&a.push(c.tiers[d]),++d);c.tiers=a;c.knownSpace&&(c.knownSpace.tierMap=c.tiers);for(a=0;a<c.tiers.length;++a)c.tiers[a].background.setAttribute("fill",
c.tierBackgroundColors[a%c.tierBackgroundColors.length]),c.tiers[a].isLabelValid=!1;c.arrangeTiers();c.storeStatus()}};a.addEventListener("mousedown",function(a){c.removeAllPopups();a.stopPropagation();a.preventDefault();d=c.svgHolder.getBoundingClientRect().top+window.scrollY;window.addEventListener("mousemove",m,!0);window.addEventListener("mouseup",q,!0);c.bin.addEventListener("mouseover",v,!0);c.bin.addEventListener("mouseout",u,!0);f=b;e=makeElementNS(NS_SVG,"rect",null,{x:c.tabMargin,y:c.offsetForTier(f)-
2,width:c.featurePanelWidth,height:4,fill:"red",stroke:"none"});h=setTimeout(function(){h=null;c.popupHolder.appendChild(e)},200)},!0)};
Browser.prototype.makeToggleButton=function(a,b,c){var d=makeElementNS(NS_SVG,"g",null,{fill:"cornsilk",strokeWidth:1,stroke:"gray"});d.appendChild(makeElementNS(NS_SVG,"rect",null,{x:this.tabMargin-15,y:c+8,width:8,height:8}));d.appendChild(makeElementNS(NS_SVG,"line",null,{x1:this.tabMargin-15,y1:c+12,x2:this.tabMargin-7,y2:c+12}));b.bumped||d.appendChild(makeElementNS(NS_SVG,"line",null,{x1:this.tabMargin-11,y1:c+8,x2:this.tabMargin-11,y2:c+16}));a.appendChild(d);d.addEventListener("mouseover",
function(a){d.setAttribute("stroke","red")},!1);d.addEventListener("mouseout",function(a){d.setAttribute("stroke","gray")},!1);d.addEventListener("mousedown",function(a){b.bumped=!b.bumped;b.layoutWasDone=!1;b.isLabelValid=!1;b.draw()},!1);this.makeTooltip(d,"Click to "+(b.bumped?"collapse":"expand"))};Browser.prototype.updateRegion=function(){if(!this.updateRegionBaton){var a=this;this.updateRegionBaton=setTimeout(function(){a.updateRegionBaton=null;a.realUpdateRegion()},25)}};
Browser.prototype.realUpdateRegion=function(){var a=this.chr;0>a.indexOf("chr")&&(a="chr"+a);var b=a+":"+(this.viewStart|0)+".."+(this.viewEnd|0);removeChildren(this.regionLabel);this.regionLabel.appendChild(document.createTextNode(b));b=NULL_BBOX;try{this.regionLabel.getBBox()}catch(c){}b=b.x+b.width;this.regionLabelMax&&b>this.regionLabelMax&&(removeChildren(this.regionLabel),this.regionLabel.appendChild(document.createTextNode(a)))};
Browser.prototype.refresh=function(){var a=this.viewEnd-this.viewStart+1,b=a*this.minExtra|0,a=a*this.maxExtra|0,c=(this.viewStart+this.viewEnd)/2,d=c-this.origin;this.origin=c;this.scaleAtLastRedraw=this.scale;for(c=0;c<this.tiers.length;++c){var e=d;this.tiers[c].originHaxx&&(e+=this.tiers[c].originHaxx);this.tiers[c].originHaxx=e}d=this.targetQuantRes/this.scale;c=Math.max(1,(this.viewStart|0)-b);b=Math.min((this.viewEnd|0)+b,0<(this.currentSeqMax|0)?this.currentSeqMax|0:1E9);e=Math.max(1,(this.viewStart|
0)-a);a=Math.min((this.viewEnd|0)+a,0<(this.currentSeqMax|0)?this.currentSeqMax|0:1E9);if(!this.knownSpace||this.knownSpace.chr!==this.chr){for(var f=null,h=0;h<this.tiers.length;++h)if(this.tiers[h].sequenceSource){f=this.tiers[h].sequenceSource;break}this.knownSpace=new KnownSpace(this.tiers,this.chr,e,a,d,f)}(f=this.knownSpace.bestCacheOverlapping(this.chr,c,b))&&f.min<=c&&f.max>=b?(this.drawnStart=Math.max(f.min,e),this.drawnEnd=Math.min(f.max,a)):(this.drawnStart=e,this.drawnEnd=a);this.knownSpace.viewFeatures(this.chr,
this.drawnStart,this.drawnEnd,d)};
Browser.prototype.mouseDownHandler=function(a){var b=this;this.removeAllPopups();a.stopPropagation();a.preventDefault();for(var c=document.elementFromPoint(a.clientX,a.clientY);c&&!c.dalliance_feature&&!c.dalliance_group;)c=c.parentNode;if(c&&(c.dalliance_feature||c.dalliance_group))if(this.dcTimeoutID&&c.dalliance_feature){var d=c.dalliance_feature,e=this.svgHolder.getBoundingClientRect(),e=((d.min|0)-(this.viewStart|0))*this.scale+e.left+this.tabMargin,f=(d.max-d.min+1)*this.scale;clearTimeout(this.dcTimeoutID);
this.dcTimeoutID=null;d=((c.dalliance_feature.min|0)+(c.dalliance_feature.max|0))/2;10<f&&(e=1*(a.clientX-e)/f,0.3>e?d=c.dalliance_feature.min|0:0.7<e&&(d=(c.dalliance_feature.max|0)+1));e=this.viewEnd-this.viewStart;this.setLocation(d-e/2,d+e/2);d=this.featurePanelWidth-(e+1)*this.scale;1<Math.abs(d)&&this.move(d/2)}else this.dcTimeoutID=setTimeout(function(){b.dcTimeoutID=null;b.featurePopup(a,c.dalliance_feature,c.dalliance_group)},200);else this.originX=a.clientX,document.addEventListener("mousemove",
this.__mouseMoveHandler,!0),document.addEventListener("mouseup",this.__mouseUpHandler,!0),this.clickTestTB=setTimeout(function(){b.clickTestTB=null},200)};var TAGVAL_NOTE_RE=/^([A-Za-z]+)=(.+)/;
Browser.prototype.featurePopup=function(a,b,c){b||(b={});c||(c={});this.removeAllPopups();var d=makeElement("table",null);d.style.width="100%";var e=pick(c.type,b.type),f=pick(c.label,b.label,c.id,b.id);f&&0!=f.indexOf("__dazzle")&&(e=e+": "+f);f=0;if(b.method){var h=makeElement("tr",[makeElement("th","Method"),makeElement("td",b.method)]);h.style.backgroundColor=this.tierBackgroundColors[f%this.tierBackgroundColors.length];d.appendChild(h);++f}h=c.segment?c:b;h=makeElement("tr",[makeElement("th",
"Location"),makeElement("td",h.segment+":"+h.min+"-"+h.max)]);h.style.backgroundColor=this.tierBackgroundColors[f%this.tierBackgroundColors.length];d.appendChild(h);++f;void 0!==b.score&&(null!==b.score&&"-"!=b.score)&&(h=makeElement("tr",[makeElement("th","Score"),makeElement("td",""+b.score)]),h.style.backgroundColor=this.tierBackgroundColors[f%this.tierBackgroundColors.length],d.appendChild(h),++f);if((h=maybeConcat(c.links,b.links))&&0<h.length)h=makeElement("tr",[makeElement("th","Links"),makeElement("td",
h.map(function(a){return makeElement("div",makeElement("a",a.desc,{href:a.uri,target:"_new"}))}))]),h.style.backgroundColor=this.tierBackgroundColors[f%this.tierBackgroundColors.length],d.appendChild(h),++f;b=maybeConcat(c.notes,b.notes);for(c=0;c<b.length;++c){var h="Note",g=b[c],m=g.match(TAGVAL_NOTE_RE);m&&(h=m[1],g=m[2]);h=makeElement("tr",[makeElement("th",h),makeElement("td",g)]);h.style.backgroundColor=this.tierBackgroundColors[f%this.tierBackgroundColors.length];d.appendChild(h);++f}this.popit(a,
e,d,{width:400})};
Browser.prototype.mouseUpHandler=function(a){var b=this;if(this.clickTestTB&&this.positionFeedback){var c=svgHolder.getBoundingClientRect(),d=makeElement("div",""+(1*(a.clientX-c.left-this.tabMargin)/this.scale+this.viewStart|0),{},{position:"absolute",top:""+(a.clientY+window.scrollY+20)+"px",left:""+Math.max(a.clientX+window.scrollX-30,20)+"px",backgroundColor:"rgb(250, 240, 220)",borderWidth:"1px",borderColor:"black",borderStyle:"solid",padding:"2px",maxWidth:"400px"});this.hPopupHolder.appendChild(d);var e;
e=function(a){try{b.hPopupHolder.removeChild(d)}catch(c){}window.removeEventListener("mousemove",e,!1)};window.addEventListener("mousemove",e,!1)}a.stopPropagation();a.preventDefault();document.removeEventListener("mousemove",this.__mouseMoveHandler,!0);document.removeEventListener("mouseup",this.__mouseUpHandler,!0);this.storeStatus()};Browser.prototype.mouseMoveHandler=function(a){a.stopPropagation();a.preventDefault();a.clientX!=this.originX&&(this.move(a.clientX-this.originX),this.originX=a.clientX)};
Browser.prototype.touchStartHandler=function(a){removeAllPopups();a.stopPropagation();a.preventDefault();this.touchOriginX=a.touches[0].pageX};Browser.prototype.touchMoveHandler=function(a){a.stopPropagation();a.preventDefault();a=a.touches[0].pageX;this.touchOriginX&&a!=this.touchOriginX&&this.move(a-this.touchOriginX);this.touchOriginX=a};Browser.prototype.touchEndHandler=function(a){a.stopPropagation();a.preventDefault();this.storeStatus()};Browser.prototype.touchCancelHandler=function(a){};
Browser.prototype.removeAllPopups=function(){removeChildren(this.popupHolder);removeChildren(this.hPopupHolder)};function EPMenuItem(a){this.entryPoint=a;this.nums=stringToNumbersArray(a.name)}
Browser.prototype.makeHighlight=function(){this.highlight&&(this.dasTierHolder.removeChild(this.highlight),this.highlight=null);0<this.highlightMin&&(this.highlight=document.createElementNS(NS_SVG,"rect"),this.highlight.setAttribute("x",(this.highlightMin-this.origin)*this.scale),this.highlight.setAttribute("y",0),this.highlight.setAttribute("width",(this.highlightMax-this.highlightMin+1)*this.scale),this.highlight.setAttribute("height",1E4),this.highlight.setAttribute("stroke","none"),this.highlight.setAttribute("fill",
"red"),this.highlight.setAttribute("fill-opacity",0.15),this.highlight.setAttribute("pointer-events","none"),this.dasTierHolder.appendChild(this.highlight))};Browser.prototype.init=function(){};
Browser.prototype.realInit=function(a){a||(a={});this.supportsBinary="function"===typeof Int8Array;var b=this;this.defaultSources=[];for(var c=0;c<this.sources.length;++c)this.defaultSources.push(this.sources[c]);this.defaultChr=this.chr;this.defaultStart=this.viewStart;this.defaultEnd=this.viewEnd;this.icons=new IconSet(this.iconsURI);var d,e=!1,f=a=null,h=null,c={};if(location.search){for(var e=location.search.substring(1).split(/[&;]/),g=0;g<e.length;++g){var m=e[g].split("="),p=decodeURIComponent(m[0]),
v=null;1<m.length&&(v=decodeURIComponent(m[1]));c[p]=v}e=c.reset}g=localStorage["dalliance."+this.cookieKey+".version"];VERSION.CONFIG!=(g?g|0:-100)&&(e=!0);g=localStorage["dalliance."+this.cookieKey+".configHash"]||"";m=hex_sha1(miniJSONify(this.sources));m!=g&&(e=!0,localStorage["dalliance."+this.cookieKey+".configHash"]=m);this.cookieKey&&(localStorage["dalliance."+this.cookieKey+".view-chr"]&&!e)&&(a=localStorage["dalliance."+this.cookieKey+".view-chr"],f=localStorage["dalliance."+this.cookieKey+
".view-start"]|0,h=localStorage["dalliance."+this.cookieKey+".view-end"]|0);this.cookieKey&&(g=localStorage["dalliance."+this.cookieKey+".sources"])&&!e&&(d=JSON.parse(g));e=/([\d+,\w,\.,\_,\-]+):(\d+)[\-,\,](\d+)/;g=!1;c.chr&&(a=c.chr,f=c.min,h=c.max,g=!0);this.positionFeedback=c.positionFeedback||!1;guidelineConfig=c.guidelines||"foreground";"true"==guidelineConfig?this.guidelineStyle="background":STRICT_NUM_REGEXP.test(guidelineConfig)?(this.guidelineStyle="background",this.guidelineSpacing=guidelineConfig|
0):this.guidelineStyle=guidelineConfig;g||((regstr=c.r)||(regstr=c.segment||""),g=regstr.match(e),""!=regstr&&g&&(a=g[1],f=g[2]|0,h=g[3]|0),g=!0);h<f&&(h=f+1E4);if(g=(c.h||"").match(e))this.highlightMin=g[2]|0,this.highlightMax=g[3]|0;this.svgHolder=document.getElementById(this.pageName);this.svgRoot=makeElementNS(NS_SVG,"svg",null,{version:"1.1",width:"860px",height:"500px",id:"browser_svg"});removeChildren(this.svgHolder);this.svgHolder.appendChild(this.svgRoot);e="";for(c=-90;90>=c;c+=20)e=e+"M "+
(Math.max(0,c)-2)+" "+(Math.max(-c,0)-2)+" L "+(Math.min(100+c,100)+2)+" "+(Math.min(100-c,100)+2)+" ",e=e+"M "+Math.max(c,0)+" "+Math.min(c+100,100)+" L "+Math.min(c+100,100)+" "+Math.max(c,0)+" ";c=makeElementNS(NS_SVG,"pattern",makeElementNS(NS_SVG,"path",null,{stroke:"lightgray",strokeWidth:2,d:e}),{id:"bgpattern-"+this.pageName,x:0,y:0,width:100,height:100});c.setAttribute("patternUnits","userSpaceOnUse");this.svgRoot.appendChild(c);this.svgBackground=makeElementNS(NS_SVG,"rect",null,{id:"background",
fill:"white"});c=makeElementNS(NS_SVG,"g",this.svgBackground,{fillOpacity:1,stroke:"black",strokeWidth:"0.1cm",fontFamily:"helvetica",fontSize:"10pt"});this.svgRoot.appendChild(c);this.regionLabel=makeElementNS(NS_SVG,"text","chr???",{x:260,y:30,strokeWidth:0});c.appendChild(this.regionLabel);this.makeTooltip(this.regionLabel,"Click to jump to a new location or gene");e=this.icons.createButton("add-track",c,30,30);e.setAttribute("transform","translate(100, 10)");this.makeTooltip(e,"Add tracks from the DAS registry");
c.appendChild(e);g=this.icons.createButton("link",c,30,30);g.setAttribute("transform","translate(140, 10)");this.makeTooltip(g,"Follow links to other genome browsers");c.appendChild(g);m=this.icons.createButton("reset",c,30,30);m.setAttribute("transform","translate(180, 10)");this.makeTooltip(m,"Reset the browser to a default state");c.appendChild(m);p=this.icons.createButton("export",c,30,30);p.setAttribute("transform","translate(220, 10)");this.makeTooltip(p,"Export the current genome display as a vector graphics file");
c.appendChild(p);var u;p.addEventListener("mousedown",function(a){a.stopPropagation();a.preventDefault();var c=u&&u.displayed;b.removeAllPopups();if(!c){var c=document.implementation.createDocument(NS_SVG,"svg",null),d=b.svgRoot.getAttribute("width")|0;c.documentElement.setAttribute("width",d);c.documentElement.setAttribute("height",b.svgRoot.getAttribute("height"));var e=makeElementNS(NS_SVG,"g",null,{fontFamily:"helvetica"});c.documentElement.appendChild(e);var f=makeElementNS(NS_SVG,"text","Graphics from Dalliance "+
VERSION,{x:80,y:30,strokeWidth:0,fill:"black",fontSize:"12pt"});b.svgRoot.appendChild(f);var g=f.getBBox().width;b.svgRoot.removeChild(f);f.setAttribute("x",d-g-60);e.appendChild(f);d=b.chr;0>d.indexOf("chr")&&(d="chr"+d);e.appendChild(makeElementNS(NS_SVG,"text",d+":"+(b.viewStart|0)+".."+(b.viewEnd|0),{x:40,y:30,strokeWidth:0,fill:"black",fontSize:"12pt"}));e.appendChild(r.cloneNode(!0));e.appendChild(b.dasLabelHolder.cloneNode(!0));e.appendChild(q.cloneNode(!0));e.appendChild(b.dasTierHolder.cloneNode(!0));
var e=makeElement("input",null,{type:"radio",name:"format",value:"svg",checked:!0}),d=makeElement("input",null,{type:"radio",name:"format",value:"pdf"}),h=makeElement("form",[makeElement("p","To work around restrictions on saving files from web applications, image export currently requires transmission of the browser's current state to a remote server.  Depending on connection speed, this can take a few seconds -- please be patient."),makeElement("p","The download links only work once, so if you wish to keep or share your exported images, please save a copy on your computer"),
e,"SVG",makeElement("br"),d,"PDF",makeElement("br"),makeElement("br"),makeElement("input",null,{type:"hidden",name:"svgdata",value:(new XMLSerializer).serializeToString(c)}),makeElement("input",null,{type:"submit"})],{action:b.exportServer+"browser-image.svg",method:"POST"});e.addEventListener("click",function(a){h.setAttribute("action",b.exportServer+"browser-image.svg")},!1);d.addEventListener("click",function(a){h.setAttribute("action",b.exportServer+"browser-image.pdf")},!1);h.addEventListener("submit",
function(a){setTimeout(function(){b.removeAllPopups()},200);return!0},!1);u=b.popit(a,"Export",h,{width:400})}},!1);this.bin=this.icons.createIcon("bin",c);this.bin.setAttribute("transform","translate(10, 18)");c.appendChild(this.bin);this.makeTooltip(this.bin,"Drag tracks here to discard");this.featureClipRect=makeElementNS(NS_SVG,"rect",null,{x:this.tabMargin,y:50,width:850-this.tabMargin,height:440});var q=makeElementNS(NS_SVG,"clipPath",this.featureClipRect,{id:"featureClip-"+this.pageName});
c.appendChild(q);this.labelClipRect=makeElementNS(NS_SVG,"rect",null,{x:10,y:50,width:this.tabMargin-10,height:440});var r=makeElementNS(NS_SVG,"clipPath",this.labelClipRect,{id:"labelClip-"+this.pageName});c.appendChild(r);this.featureBackground=makeElementNS(NS_SVG,"rect",null,{x:this.tabMargin,y:50,width:850-this.tabMargin,height:440,stroke:"none",fill:"url(#bgpattern-"+this.pageName+")"});c.appendChild(this.featureBackground);this.dasTierHolder=makeElementNS(NS_SVG,"g",null,{clipPath:"url(#featureClip-"+
this.pageName+")"});c.appendChild(this.dasTierHolder);p=makeElementNS(NS_SVG,"g",null,{id:"dasTiers"});this.dasTierHolder.appendChild(p);this.makeHighlight();this.dasLabelHolder=makeElementNS(NS_SVG,"g",makeElementNS(NS_SVG,"g",null,{id:"dasLabels"}),{clipPath:"url(#labelClip-"+this.pageName+")"});c.appendChild(this.dasLabelHolder);var v=this.icons.createIcon("magnifier-plus",c),t=this.icons.createIcon("magnifier-minus",c);this.zoomTickMarks=makeElementNS(NS_SVG,"g");this.zoomSlider=new DSlider(250);
this.zoomSlider.onchange=function(a,c){b.zoom(Math.exp(1*a/b.zoomExpt));c&&(b.invalidateLayouts(),b.refresh(),b.storeStatus())};v.setAttribute("transform","translate(0,15)");v.setAttribute("pointer-events","all");v.addEventListener("mousedown",function(a){a.stopPropagation();a.preventDefault();a=b.zoomSlider.getValue();b.zoomSlider.setValue(a-10);var c=b.zoomSlider.getValue();c!=a&&(b.zoom(Math.exp(1*c/b.zoomExpt)),b.scheduleRefresh(500))},!1);this.zoomSlider.svg.setAttribute("transform","translate(30, 0)");
t.setAttribute("transform","translate(285,15)");t.setAttribute("pointer-events","all");t.addEventListener("mousedown",function(a){a.stopPropagation();a.preventDefault();a=b.zoomSlider.getValue();b.zoomSlider.setValue(a+10);var c=b.zoomSlider.getValue();c!=a&&(b.zoom(Math.exp(1*c/b.zoomExpt)),b.scheduleRefresh(500))},!1);this.zoomWidget=makeElementNS(NS_SVG,"g",[this.zoomTickMarks,v,this.zoomSlider.svg,t]);this.makeTooltip(this.zoomWidget,"Drag to zoom");c.appendChild(this.zoomWidget);this.karyo=new Karyoscape(this,
this.karyoEndpoint);this.karyo.svg.setAttribute("transform","translate(480, 15)");this.karyo.onchange=function(a){var c=b.viewEnd-b.viewStart+1;a=a*b.currentSeqMax-c/2|0;b.setLocation(a,a+c-1)};c.appendChild(this.karyo.svg);this.popupHolder=makeElementNS(NS_SVG,"g");c.appendChild(this.popupHolder);this.hPopupHolder=makeElement("div");this.hPopupHolder.style["font-family"]="helvetica";this.hPopupHolder.style["font-size"]="12pt";this.svgHolder.appendChild(this.hPopupHolder);this.bhtmlRoot=makeElement("div");
this.disablePoweredBy||this.bhtmlRoot.appendChild(makeElement("span",["Powered by ",makeElement("a","Dalliance",{href:"http://www.biodalliance.org/"})," "+VERSION]));this.svgHolder.appendChild(this.bhtmlRoot);"foreground"==this.guidelineStyle&&(this.fgGuide=document.createElementNS(NS_SVG,"line"),this.fgGuide.setAttribute("x1",500),this.fgGuide.setAttribute("y1",50),this.fgGuide.setAttribute("x2",500),this.fgGuide.setAttribute("y2",1E4),this.fgGuide.setAttribute("stroke","red"),this.fgGuide.setAttribute("stroke-width",
1),this.fgGuide.setAttribute("pointer-events","none"),c.appendChild(this.fgGuide));var y;g.addEventListener("mousedown",function(a){var c=y&&y.displayed;a.stopPropagation();a.preventDefault();b.removeAllPopups();if(!c){c=makeElement("ul");for(l in b.browserLinks)c.appendChild(makeElement("li",makeElement("a",l,{href:b.browserLinks[l].replace(RegExp("\\${([a-z]+)}","g"),function(a,c){return"chr"==c?b.chr:"start"==c?b.viewStart|0:"end"==c?b.viewEnd|0:""}),target:"_new"})));y=b.popit(a,"Follow links to...",
c)}},!1);var x;this.regionLabel.addEventListener("mousedown",function(a){a.stopPropagation();a.preventDefault();var c=x&&x.displayed;b.removeAllPopups();if(!c)if(null==b.entryPoints)alert("entry_points aren't currently available for this genome");else{for(var c=[],d=0;d<b.entryPoints.length;++d)c.push(new EPMenuItem(b.entryPoints[d]));c=c.sort(function(a,b){for(var c=a.nums,d=b.nums,e=0;;){if(e>=c.length)return-1;if(e>=d.length)return 1;var f=c[e]-d[e];if(0!=f)return f;++e}});c=makeElement("div");
c.style.padding="5px";c.style.paddingRight="9px";d=makeElement("form");d.appendChild(document.createTextNode("Location:"));var e=makeElement("div",null,{},{color:"red"});d.appendChild(e);var f=makeElement("input",null,{type:"text",value:b.chr+":"+(b.viewStart|0)+".."+(b.viewEnd|0)});d.appendChild(f);d.appendChild(makeElement("br"));d.appendChild(makeElement("input",null,{type:"submit",value:"Go"}));c.appendChild(d);x=b.popit(a,"Jump to...",c,{width:300});d.addEventListener("submit",function(a){a.stopPropagation();
a.preventDefault();a=f.value.trim();var c=/^([A-Za-z0-9]+)[:\t ]([0-9]+)([-:.\t ]+([0-9]+))?$/.exec(a);if(c&&5==c.length){a=c[1];var d=stringToInt(c[2]);c[4]?c=stringToInt(c[4]):(c=b.viewEnd-b.viewStart+1,d=d-c/2|0,c=d+c);a!=b.chr&&(b.highlightMin=-1,b.highlightMax=-1);try{b.setLocation(d,c,a),b.removeAllPopups()}catch(g){removeChildren(e),e.appendChild(document.createTextNode(g))}}else removeChildren(e),e.appendChild(document.createTextNode("Should match chr:start...end or chr:midpoint"));return!1},
!1);if(b.searchEndpoint){a=makeElement("form");a.appendChild(makeElement("p","Or search for..."));a.appendChild(document.createTextNode("Gene:"));var g=makeElement("input",null,{value:""});a.appendChild(g);a.appendChild(makeElement("br"));a.appendChild(makeElement("input",null,{type:"submit",value:"Go"}));c.appendChild(a);a.addEventListener("submit",function(a){a.stopPropagation();a.preventDefault();var c=g.value;b.removeAllPopups();if(!c||0==c.length)return!1;b.searchEndpoint.features(null,{group:c,
type:"transcript"},function(a){a||(a=[]);for(var d=5E8,e=-1E8,f=null,g=0;g<a.length;++g){var h=a[g];h.label==c&&(null==f&&(f=h.segment),d=Math.min(d,h.min),e=Math.max(e,h.max))}f?(b.highlightMin=d,b.highlightMax=e,b.makeHighlight(),a=Math.max(2500,0.3*(e-d+1)|0),b.setLocation(d-a,e+a,f)):alert("no match for '"+c+"' (NB. server support for search is currently rather limited...)")},!1);return!1},!1)}}},!1);var w;e.addEventListener("mousedown",function(a){a.stopPropagation();a.preventDefault();var c=
w&&w.displayed;b.removeAllPopups();c||(w=b.showTrackAdder(a))},!1);m.addEventListener("mousedown",function(a){a.stopPropagation();a.preventDefault();removeChildren(b.tierHolder);removeChildren(b.dasLabelHolder);b.tiers=[];b.sources=[];b.knownSpace=null;for(a=0;a<b.defaultSources.length;++a){var c=b.defaultSources[a];b.sources.push(c);b.makeTier(c)}b.arrangeTiers();b.highlightMin=b.highlightMax=-1;b.setLocation(b.defaultStart,b.defaultEnd,b.defaultChr)},!1);this.tierHolder=p;this.tiers=[];if(d)this.sources=
d;else{this.sources=[];for(e=0;e<this.defaultSources.length;++e)d=this.defaultSources[e],d.disable||this.sources.push(d)}for(d=0;d<this.sources.length;++d)e=this.sources[d],e.bwgURI&&!this.supportsBinary?this.binaryWarningGiven||(this.popit({clientX:300,clientY:100},"Warning",makeElement("p","your browser does not support binary data formats, some track(s) not loaded.  We currently recommend Google Chrome 9 or later, or Firefox 4 or later.")),this.binaryWarningGiven=!0):this.makeTier(e);b.arrangeTiers();
this.resizeViewer(!0);window.addEventListener("resize",function(a){b.resizeViewer()},!1);a&&(f&&h)&&(this.chr=a,this.viewStart=f,this.viewEnd=h,0>this.highlightMin&&(this.highlightMin=f,this.highlightMax=h));this.viewEnd-this.viewStart>MAX_VIEW_SIZE&&(a=(this.viewEnd+this.viewStart)/2|0,this.viewStart=a-MAX_VIEW_SIZE/2,this.viewEnd=a+MAX_VIEW_SIZE/2-1);this.origin=(this.viewStart+this.viewEnd)/2|0;this.scale=this.featurePanelWidth/(this.viewEnd-this.viewStart);this.zoomExpt=250/Math.log(MAX_VIEW_SIZE/
this.zoomBase);this.zoomSlider.setValue(this.zoomExpt*Math.log((this.viewEnd-this.viewStart+1)/this.zoomBase));this.move(0);this.makeZoomerTicks();this.__mouseMoveHandler=function(a){return b.mouseMoveHandler(a)};this.__mouseUpHandler=function(a){return b.mouseUpHandler(a)};c.addEventListener("mousedown",function(a){return b.mouseDownHandler(a)},!1);c.addEventListener("touchstart",function(a){return b.touchStartHandler(a)},!1);c.addEventListener("touchmove",function(a){return b.touchMoveHandler(a)},
!1);c.addEventListener("touchend",function(a){return b.touchEndHandler(a)},!1);c.addEventListener("touchcancel",function(a){return b.touchCancelHandler(a)},!1);this.svgRoot.addEventListener("mousewheel",function(a){a.wheelDeltaX&&(a.stopPropagation(),a.preventDefault(),b.move(-a.wheelDeltaX/5))},!1);this.svgRoot.addEventListener("MozMousePixelScroll",function(a){1==a.axis&&(a.stopPropagation(),a.preventDefault(),0!=a.detail&&b.move(a.detail/4))},!1);var s=function(a){if(13==a.keyCode){var c=!1;for(a=
0;a<b.tiers.length;++a){var d=b.tiers[a];d.wantedLayoutHeight&&d.wantedLayoutHeight!=d.layoutHeight&&(d.layoutHeight=d.wantedLayoutHeight,d.placard=null,d.clipTier(),c=!0)}c&&b.arrangeTiers()}else if(32==a.keyCode||32==a.charCode)b.snapZoomLockout||(b.isSnapZooming?(b.isSnapZooming=!1,d=b.savedZoom||10,b.savedZoom=b.zoomSlider.getValue(),b.zoomSlider.setValue(d),b.zoom(Math.exp(1*d/b.zoomExpt)),b.invalidateLayouts(),b.zoomSlider.setColor("blue")):(b.isSnapZooming=!0,d=b.savedZoom||1,b.savedZoom=b.zoomSlider.getValue(),
b.zoomSlider.setValue(d),b.zoom(Math.exp(1*d/b.zoomExpt)),b.invalidateLayouts(),b.zoomSlider.setColor("red")),b.refresh(),b.snapZoomLockout=!0),a.stopPropagation(),a.preventDefault();else if(39==a.keyCode||68==a.keyCode)if(a.stopPropagation(),a.preventDefault(),a.ctrlKey){var e=0;a.shiftKey&&(e=1);var f=(b.viewStart+b.viewEnd+1)/2|0;b.tiers[b.selectedTier].findNextFeature(b.chr,f,-1,e,function(a){if(a){var c=a.min,d=a.max;e&&(d<f-1?(d++,c=d):d=c);var g=b.viewEnd-b.viewStart+1;parseFloat(g/2)==parseInt(g/
2)&&g--;c=(c+d-g)/2+1;b.setLocation(c,c+g-1,a.segment)}else dlog("no next feature")})}else b.move(a.shiftKey?100:25);else if(37==a.keyCode||65==a.keyCode)a.stopPropagation(),a.preventDefault(),a.ctrlKey?(e=0,a.shiftKey&&(e=1),f=(b.viewStart+b.viewEnd+1)/2|0,b.tiers[b.selectedTier].findNextFeature(b.chr,f,1,e,function(a){if(a){var c=a.min,d=a.max;e&&(c>f+1?d=c:(d++,c=d));var g=b.viewEnd-b.viewStart+1;parseFloat(g/2)==parseInt(g/2)&&g--;c=(c+d-g)/2+1;b.setLocation(c,c+g-1,a.segment)}else dlog("no next feature")})):
b.move(a.shiftKey?-100:-25);else if(38==a.keyCode||87==a.keyCode)a.stopPropagation(),a.preventDefault(),0<b.selectedTier&&(--b.selectedTier,b.tiers[b.selectedTier].isLabelValid=!1,b.tiers[b.selectedTier+1].isLabelValid=!1,b.arrangeTiers());else if(40==a.keyCode||83==a.keyCode)a.stopPropagation(),a.preventDefault(),b.selectedTier<b.tiers.length-1&&(++b.selectedTier,b.tiers[b.selectedTier].isLabelValid=!1,b.tiers[b.selectedTier-1].isLabelValid=!1,b.arrangeTiers());else if(61==a.charCode)a.stopPropagation(),
a.preventDefault(),a=b.zoomSlider.getValue(),b.zoomSlider.setValue(a-10),d=b.zoomSlider.getValue(),d!=a&&(b.zoom(Math.exp(1*d/b.zoomExpt)),b.scheduleRefresh(500));else if(45==a.charCode)a.stopPropagation(),a.preventDefault(),a=b.zoomSlider.getValue(),b.zoomSlider.setValue(a+10),d=b.zoomSlider.getValue(),d!=a&&(b.zoom(Math.exp(1*d/b.zoomExpt)),b.scheduleRefresh(500));else if(84==a.keyCode||116==a.keyCode)if(a.stopPropagation(),a.preventDefault(),a.shiftKey)for(a=0;a<b.tiers.length;++a)d=b.tiers[a],
d.dasSource.collapseSuperGroups&&(void 0===c&&(c=!d.bumped),d.bumped=c,d.isLabelValid=!1,d.layoutWasDone=!1,d.draw());else d=b.tiers[b.selectedTier],d.dasSource.collapseSuperGroups&&(void 0===c&&(c=!d.bumped),d.bumped=c,d.layoutWasDone=!1,d.isLabelValid=!1,d.draw())},z=function(a){b.snapZoomLockout=!1},B;B=function(a){window.removeEventListener("keydown",s,!1);window.removeEventListener("keyup",z,!1);window.removeEventListener("keypress",s,!1);b.svgRoot.removeEventListener("mouseout",B,!1)};this.svgRoot.addEventListener("mouseover",
function(a){window.addEventListener("keydown",s,!1);window.addEventListener("keyup",z,!1);window.addEventListener("keypress",s,!1);b.svgRoot.addEventListener("mouseout",B,!1)},!1);this.storeStatus();var C;for(a=0;a<this.tiers.length;++a)if(d=this.tiers[a].dasSource,d.provides_entrypoints){C=this.tiers[a].dasSource;break}C&&C.entryPoints(function(a){b.entryPoints=a;for(a=0;a<b.entryPoints.length;++a)if(b.entryPoints[a].name==b.chr){b.currentSeqMax=b.entryPoints[a].end;break}});b.queryRegistry(null,
!0);for(var H in this.chains)this.queryRegistry(H,!0)};function setSources(a,b,c){if(c)for(var d=0;d<b.length;++d)b[d].mapping=c;a.set(b)}
Browser.prototype.queryRegistry=function(a,b){var c,d;a?(c=this.chains[a].coords,this.mappableSources[a]||(this.mappableSources[a]=new Observed),d=this.mappableSources[a]):(c=this.coordSystem,d=this.availableSources);var e=hex_sha1(miniJSONify(c));if(b){var f=localStorage["dalliance.registry."+e+".last_queried"];if(f)try{if(setSources(d,JSON.parse(localStorage["dalliance.registry."+e+".sources"]),a),432E5>(Date.now()|0)-(f|0))return}catch(h){dlog("Bad registry cache: "+h)}}(new DASRegistry(this.registry)).sources(function(b){for(var f=
[],h=0;h<b.length;++h){var v=b[h];if(v.coords&&0!=v.coords.length){var u=v.coords[0];u.taxon!=c.taxon||(u.auth!=c.auth||u.version!=c.version)||f.push(v)}}localStorage["dalliance.registry."+e+".sources"]=JSON.stringify(f);localStorage["dalliance.registry."+e+".last_queried"]=""+Date.now();setSources(d,f,a)},function(a){},c)};Browser.prototype.makeTier=function(a){try{this.realMakeTier(a)}catch(b){dlog("Error creating tier: "+b)}};
Browser.prototype.realMakeTier=function(a){var b=document.createElementNS(NS_SVG,"g"),c=document.createElementNS(NS_SVG,"rect");c.setAttribute("fill",this.tierBackgroundColors[this.tiers.length%this.tierBackgroundColors.length]);c.setAttribute("x","-1000000");c.setAttribute("y","0");c.setAttribute("width","2000000");c.setAttribute("height","200");c.setAttribute("stroke-width","0");b.appendChild(c);b.setAttribute("transform","translate(200, 450)");a=new DasTier(this,a,b,c);a.init();this.tierHolder.appendChild(b);
this.tiers.push(a);this.refreshTier(a);this.arrangeTiers()};Browser.prototype.removeTier=function(a){a=arrayIndexOf(this.tiers,a);if(0>a)return dlog("Couldn't find tier");var b=this.tiers[a];this.tierHolder.removeChild(b.viewport);b.label&&this.dasLabelHolder.removeChild(b.label);this.tiers.splice(a,1);for(a=0;a<this.tiers.length;++a)this.tiers[a].background.setAttribute("fill",this.tierBackgroundColors[a%this.tierBackgroundColors.length]),this.tiers[a].isLabelValid=!1;this.arrangeTiers();this.storeStatus()};
Browser.prototype.makeZoomerTicks=function(){var a=this;removeChildren(this.zoomTickMarks);var b=function(b){var d=a.zoomExpt*Math.log(b/a.zoomBase);if(!(0>d||250<d)){var e=makeElementNS(NS_SVG,"line",null,{x1:30+d,y1:35,x2:30+d,y2:38,stroke:"gray",strokeWidth:1});b=makeElementNS(NS_SVG,"text",1500<b?""+b/1E3+"kb":""+b+"bp",{x:30+d,y:48,fontSize:"8pt",stroke:"none"});a.zoomTickMarks.appendChild(e);a.zoomTickMarks.appendChild(b);b.setAttribute("text-anchor","middle")}};b(1E6);b(5E5);b(1E5);b(2E4);
b(4E3);b(500);b(100);b(50)};
Browser.prototype.resizeViewer=function(a){var b=this.svgHolder.offsetWidth,b=Math.max(b,640);this.forceWidth&&(b=this.forceWidth);this.center&&(this.svgHolder.style["margin-left"]=((window.innerWidth-b)/2|0)+"px");this.svgRoot.setAttribute("width",b-30);this.svgBackground.setAttribute("width",b-30);this.featureClipRect.setAttribute("width",b-this.tabMargin-40);this.featureBackground.setAttribute("width",b-this.tabMargin-40);this.zoomWidget.setAttribute("transform","translate("+(b-this.zoomSlider.width-
100)+", 0)");1075>b?this.karyo.svg.setAttribute("transform","translate(2000, 15)"):this.karyo.svg.setAttribute("transform","translate(450, 20)");this.regionLabelMax=b-this.zoomSlider.width-120;var c=this.featurePanelWidth;this.featurePanelWidth=b-this.tabMargin-40|0;c!=this.featurePanelWidth&&(b=this.viewStart+(this.viewEnd-this.viewStart)*this.featurePanelWidth/c-this.viewEnd,this.viewStart-=b/2,this.viewEnd+=b/2,b=this.viewEnd-this.viewStart+1,0<this.currentSeqMax&&this.viewEnd>this.currentSeqMax&&
(this.viewEnd=this.currentSeqMax,this.viewStart=this.viewEnd-b+1),1>this.viewStart&&(this.viewStart=1,this.viewEnd=this.viewStart+b-1),this.xfrmTiers(this.tabMargin-1*(this.viewStart-this.origin)*this.scale,1),this.updateRegion(),a||this.spaceCheck());this.fgGuide&&(this.fgGuide.setAttribute("x1",this.featurePanelWidth/2+this.tabMargin),this.fgGuide.setAttribute("x2",this.featurePanelWidth/2+this.tabMargin));for(a=0;a<this.placards.length;++a)b=this.placards[a].getElementsByTagName("rect"),0<b.length&&
b[0].setAttribute("width",this.featurePanelWidth)};Browser.prototype.xfrmTiers=function(a,b){for(var c=0;c<this.tiers.length;++c)this.xfrmTier(this.tiers[c],a,b);this.highlight&&(this.highlight.setAttribute("transform","translate("+a+",0)"),this.highlight.setAttribute("x",(this.highlightMin-this.origin)*this.scale),this.highlight.setAttribute("width",(this.highlightMax-this.highlightMin+1)*this.scale))};
Browser.prototype.jiggleLabels=function(a){var b=a.xfrmX;a=a.viewport.getElementsByClassName("label-text");for(var c=0;c<a.length;++c){var d=a[c];d.jiggleMin&&d.jiggleMax&&d.setAttribute("x",Math.min(Math.max(this.tabMargin-b,d.jiggleMin),d.jiggleMax))}};
Browser.prototype.xfrmTier=function(a,b,c){a.originHaxx&&0!=a.originHaxx&&(b-=1*a.originHaxx*this.scale);var d=c;0>d?d=a.scale:a.scale=c;c=a.y;if(b!=a.xfrmX||c!=a.xfrmY||d!=a.xfrmS){var e="translate("+b+","+a.y+")";1!=d&&(e+=", scale("+d+",1)");a.viewport.setAttribute("transform",e)}if(a.label&&(c!=a.xfrmY||!a.isLabelValid))a.label.setAttribute("transform","translate(0, "+c+")"),a.isLabelValid=!0;a.xfrmX=b;a.xfrmY=c;a.xfrmS=d;this.jiggleLabels(a)};
Browser.prototype.spaceCheck=function(a){!this.knownSpace||this.knownSpace.chr!==this.chr?this.refresh():(a=((this.viewEnd-this.viewStart|0)+1)*this.minExtra|0,((this.drawnStart|0)>Math.max(1,(this.viewStart|0)-a|0)||(this.drawnEnd|0)<Math.min((this.viewEnd|0)+a,0<(this.currentSeqMax|0)?this.currentSeqMax|0:1E9))&&this.refresh())};
Browser.prototype.move=function(a){var b=this.viewEnd-this.viewStart;this.viewStart-=a/this.scale;this.viewEnd=this.viewStart+b;0<this.currentSeqMax&&this.viewEnd>this.currentSeqMax&&(this.viewEnd=this.currentSeqMax,this.viewStart=this.viewEnd-b);1>this.viewStart&&(this.viewStart=1,this.viewEnd=this.viewStart+b);this.xfrmTiers(this.tabMargin-1*(this.viewStart-this.origin)*this.scale,1);this.updateRegion();this.karyo.update(this.chr,this.viewStart,this.viewEnd);this.spaceCheck()};
Browser.prototype.zoom=function(a){this.zoomFactor=a;a=Math.round((this.viewStart+this.viewEnd)/2)|0;this.viewStart=a-this.zoomBase*this.zoomFactor/2;this.viewEnd=a+this.zoomBase*this.zoomFactor/2;0<this.currentSeqMax&&this.viewEnd>this.currentSeqMax+5&&(a=this.viewEnd-this.viewStart+1,this.viewEnd=this.currentSeqMax,this.viewStart=this.viewEnd-a+1);1>this.viewStart&&(a=this.viewEnd-this.viewStart+1,this.viewStart=1,this.viewEnd=this.viewStart+a-1);this.scale=this.featurePanelWidth/(this.viewEnd-
this.viewStart);this.updateRegion();this.xfrmTiers(this.tabMargin-1*(this.viewStart-this.origin)*this.scale,this.scale/this.scaleAtLastRedraw);a=this.svgRoot.getElementsByClassName("label-text");for(var b=0;b<a.length;++b){var c=a[b],d=c.getAttribute("x");c.setAttribute("transform","scale("+this.scaleAtLastRedraw/this.scale+",1), translate( "+(d*this.scale-d*this.scaleAtLastRedraw)/this.scaleAtLastRedraw+",0)")}};
Browser.prototype.setLocation=function(a,b,c){a|=0;b|=0;if(c&&c!=this.chr){if(!this.entryPoints)throw"Need entry points";for(var d=null,e=0;e<this.entryPoints.length;++e){var f=this.entryPoints[e].name;if(f===c||"chr"+f===c||f==="chr"+c){d=this.entryPoints[e];break}}if(!d)throw"Couldn't find chromosome "+c;this.chr=d.name;this.currentSeqMax=d.end}c=b-a+1;c>MAX_VIEW_SIZE&&(a=(b+a-MAX_VIEW_SIZE)/2|0,b=a+MAX_VIEW_SIZE-1|0);c<this.zoomBase&&(a=(b+a-this.zoomBase)/2|0,mewMax=a+this.zoomBase-1|0);1>a&&
(c=b-a+1,a=1,b=Math.min(a+c-1,this.currentSeqMax));0<this.currentSeqMax&&b>this.currentSeqMax&&(c=b-a+1,b=this.currentSeqMax,a=Math.max(1,b-c+1));this.viewStart=a|0;this.viewEnd=b|0;this.scale=this.featurePanelWidth/(this.viewEnd-this.viewStart);this.zoomSlider.setValue(this.zoomExpt*Math.log((this.viewEnd-this.viewStart+1)/this.zoomBase));this.updateRegion();this.karyo.update(this.chr,this.viewStart,this.viewEnd);this.spaceCheck();this.xfrmTiers(this.tabMargin-1*(this.viewStart-this.origin)*this.scale,
1);this.storeStatus()};
Browser.prototype.storeStatus=function(){if(this.cookieKey&&!this.noPersist){localStorage["dalliance."+this.cookieKey+".view-chr"]=this.chr;localStorage["dalliance."+this.cookieKey+".view-start"]=this.viewStart|0;localStorage["dalliance."+this.cookieKey+".view-end"]=this.viewEnd|0;for(var a=[],b=0;b<this.tiers.length;++b)this.tiers[b].dasSource.noPersist||a.push(this.tiers[b].dasSource);localStorage["dalliance."+this.cookieKey+".sources"]=JSON.stringify(a);localStorage["dalliance."+this.cookieKey+
".version"]=VERSION.CONFIG}};Browser.prototype.scheduleRefresh=function(a){a||(a=500);var b=this;this.refreshTB&&clearTimeout(this.refreshTB);this.refreshTB=setTimeout(function(){b.refreshTB=null;b.refresh()},a)};Browser.prototype.invalidateLayouts=function(){for(var a=0;a<this.tiers.length;++a)this.tiers[a].layoutWasDone=!1};Browser.prototype.refreshTier=function(a){this.knownSpace&&this.knownSpace.invalidate(a)};
function Chainset(a,b,c,d){this.uri=a;this.srcTag=b;this.destTag=c;this.coords=d;this.chainsBySrc={};this.chainsByDest={};this.postFetchQueues={}}function parseCigar(a){for(var b=[],c=RegExp("([0-9]*)([MID])","g"),d;null!=(d=c.exec(a));){var e=d[1];0==e.length&&(e=1);b.push({cnt:e|0,op:d[2]})}return b}
Chainset.prototype.fetchChainsTo=function(a){var b=this;(new DASSource(this.uri)).alignments(a,{},function(c){b.chainsByDest[a]||(b.chainsByDest[a]=[]);for(var d=0;d<c.length;++d)for(var e=c[d],f=0;f<e.blocks.length;++f){for(var h=e.blocks[f],g,m,p=0;p<h.segments.length;++p){var v=h.segments[p],u=e.objects[v.object];u.dbSource===b.srcTag?g=v:u.dbSource===b.destTag&&(m=v)}if(g&&m){for(var h={srcChr:e.objects[g.object].accession,srcMin:g.min|0,srcMax:g.max|0,srcOri:g.strand,destChr:e.objects[m.object].accession,
destMin:m.min|0,destMax:m.max|0,destOri:m.strand,blocks:[]},p=parseCigar(g.cigar),v=parseCigar(m.cigar),q=u=0,r=0,t=0;r<p.length&&t<v.length;)if("M"==p[r].op&&"M"==v[t].op){var y=Math.min(p[r].cnt,v[t].cnt);h.blocks.push([u,q,y]);p[r].cnt==y?++r:p[r].cnt-=y;v[t].cnt==y?++t:v[t]-=y;u+=y;q+=y}else"I"==p[r].op?q+=p[r++].cnt:"I"==v[t].op&&(u+=v[t++].cnt);pusho(b.chainsBySrc,h.srcChr,h);pusho(b.chainsByDest,h.destChr,h)}}if(b.postFetchQueues[a]){c=b.postFetchQueues[a];for(d=0;d<c.length;++d)c[d]();b.postFetchQueues[a]=
null}})};Chainset.prototype.mapPoint=function(a,b){for(var c=this.chainsBySrc[a]||[],d=0;d<c.length;++d){var e=c[d];if(b>=e.srcMin&&b<=e.srcMax){var f;f="-"==e.srcOri?e.srcMax-b:b-e.srcMin;for(var h=e.blocks,g=0;g<h.length;++g){var m=h[g],p=m[0],v=m[1],m=m[2];if(f>=p&&f<=p+m)return c=f-p,{seq:e.destChr,pos:"-"==e.destOri?e.destMax-v-c:c+v+e.destMin,flipped:e.srcOri!=e.destOri}}}}return null};
Chainset.prototype.unmapPoint=function(a,b){for(var c=this.chainsByDest[a]||[],d=0;d<c.length;++d){var e=c[d];if(b>=e.destMin&&b<=e.destMax){for(var d="-"==e.srcOri?e.destMax-b:b-e.destMin,f=e.blocks,h=0;h<f.length;++h){var g=f[h],c=g[0],m=g[1],g=g[2];if(d>=m&&d<=m+g)return d-=m,f=d+c+e.srcMin,f="-"==e.destOri?e.srcMax-c-d:d+c+e.srcMin,{seq:e.srcChr,pos:f,flipped:e.srcOri!=e.destOri}}break}}return null};
Chainset.prototype.sourceBlocksForRange=function(a,b,c,d){if(this.chainsByDest[a]){var e=this.unmapPoint(a,b),f=this.unmapPoint(a,c);!e||!f||e.seq!=f.seq?d([]):d([new DASSegment(e.seq,e.pos,f.pos)])}else{var e=!this.postFetchQueues[a],h=this;pusho(this.postFetchQueues,a,function(){h.sourceBlocksForRange(a,b,c,d)});e&&this.fetchChainsTo(a)}};var dasLibErrorHandler=function(a){alert(a)},dasLibRequestQueue=[];function DASSegment(a,b,c,d){this.name=a;this.start=b;this.end=c;this.description=d}
DASSegment.prototype.toString=function(){return this.name+":"+this.start+".."+this.end};DASSegment.prototype.isBounded=function(){return this.start&&this.end};DASSegment.prototype.toDASQuery=function(){var a="segment="+this.name;this.start&&this.end&&(a+=":"+this.start+","+this.end);return a};
function DASSource(a,b){var c;"string"==typeof a?(this.uri=a,c=b||{}):c=a||{};for(var d in c)"function"!=typeof c[d]&&(this[d]=c[d]);this.coords||(this.coords=[]);this.props||(this.props={});this.uri&&"/"!=this.uri.substr(this.uri.length-1)&&(this.uri+="/")}function DASCoords(){}function coordsMatch(a,b){return a.taxon==b.taxon&&a.auth==b.auth&&a.version==b.version}
DASSource.prototype.entryPoints=function(a){this.doCrossDomainRequest(this.uri+"entry_points",function(b){if(!b)return a([]);var c=[];b=b.getElementsByTagName("SEGMENT");for(var d=0;d<b.length;++d){var e=b[d],f=e.getAttribute("id"),h=e.getAttribute("size"),g;h?g=1:(g=e.getAttribute("start"),h=e.getAttribute("stop"));var m=null;e.firstChild&&(m=e.firstChild.nodeValue);c.push(new DASSegment(f,g,h,m))}a(c)})};
function DASSequence(a,b,c,d,e){this.name=a;this.start=b;this.end=c;this.alphabet=d;this.seq=e}
DASSource.prototype.sequence=function(a,b){var c=this.uri+"sequence?"+a.toDASQuery();this.doCrossDomainRequest(c,function(a){if(a){var c=[];a=a.getElementsByTagName("SEQUENCE");for(var f=0;f<a.length;++f){var h=a[f],g=h.getAttribute("id"),m=h.getAttribute("start"),p=h.getAttribute("stop"),v=null;if(h.firstChild)for(var h=h.firstChild.nodeValue,v="",u=0;;){var q=h.indexOf("\n",u);if(0<=q)v+=h.substring(u,q),u=q+1;else{v+=h.substring(u);break}}c.push(new DASSequence(g,m,p,"DNA",v))}b(c)}else b([])})};
function DASFeature(){}function DASGroup(){}function DASLink(a,b){this.desc=a;this.uri=b}
DASSource.prototype.features=function(a,b,c){b=b||{};var d;if(0==this.uri.indexOf("http://")){var e=[];if(a)e.push(a.toDASQuery());else if(b.group)if(a=b.group,"string"==typeof a)e.push("group_id="+a);else for(var f=0;f<a.length;++f)e.push("group_id="+a[f]);if(b.adjacent){a=b.adjacent;"string"==typeof a&&(a=[a]);for(f=0;f<a.length;++f)e.push("adjacent="+a[f])}if(b.type)if("string"==typeof b.type)e.push("type="+b.type);else for(a=0;a<b.type.length;++a)e.push("type="+b.type[a]);b.maxbins&&e.push("maxbins="+
b.maxbins);0<e.length?d=this.uri+"features?"+e.join(";"):c([],"No filters specified")}else d=this.uri;this.doCrossDomainRequest(d,function(a,b){if(a){for(var d=[],e={},f=a.getElementsByTagName("SEGMENT"),u=0;u<f.length;++u){var q=f[u],r=q.getAttribute("id");e[r]={min:q.getAttribute("start"),max:q.getAttribute("stop")};for(var q=q.getElementsByTagName("FEATURE"),t=0;t<q.length;++t){var y=q[t],x=new DASFeature;x.segment=r;x.id=y.getAttribute("id");x.label=y.getAttribute("label");var w=elementValue(y,
"START"),s=elementValue(y,"END");(w|0)>(s|0)?(x.min=s|0,x.max=w|0):(x.min=w|0,x.max=s|0);w=y.getElementsByTagName("TYPE");0<w.length&&(w=w[0],w.firstChild&&(x.type=w.firstChild.nodeValue),x.typeId=w.getAttribute("id"),x.typeCv=w.getAttribute("cvId"));x.type=elementValue(y,"TYPE");!x.type&&x.typeId&&(x.type=x.typeId);x.method=elementValue(y,"METHOD");(w=elementValue(y,"ORIENTATION"))||(w="0");x.orientation=w;x.score=elementValue(y,"SCORE");x.links=dasLinksOf(y);x.notes=dasNotesOf(y);w=y.getElementsByTagName("GROUP");
for(s=0;s<w.length;++s){var z=w[s],B=new DASGroup;B.type=z.getAttribute("type");B.id=z.getAttribute("id");B.links=dasLinksOf(z);B.notes=dasNotesOf(z);x.groups?x.groups.push(B):x.groups=Array(B)}if(x.notes)for(w=0;w<x.notes.length;++w)s=x.notes[w],0==s.indexOf("Genename=")&&(z=new DASGroup,z.type="gene",z.id=s.substring(9),x.groups?x.groups.push(z):x.groups=Array(z));w=y.getElementsByTagName("PART");if(0<w.length){z=[];for(s=0;s<w.length;++s)z.push(w[s].getAttribute("id"));x.parts=z}w=y.getElementsByTagName("PARENT");
if(0<w.length){y=[];for(s=0;s<w.length;++s)y.push(w[s].getAttribute("id"));x.parents=y}d.push(x)}}c(d,void 0,e)}else c([],"Failed request: "+(0==b.status?"server may not support CORS":"status="+b.status))})};function DASAlignment(a){this.type=a;this.objects={};this.blocks=[]}
DASSource.prototype.alignments=function(a,b,c){var d=this.uri+"alignment?query="+a;this.doCrossDomainRequest(d,function(a){if(a){var b=[];a=a.getElementsByTagName("alignment");for(var h=0;h<a.length;++h){for(var g=a[h],m=new DASAlignment(g.getAttribute("alignType")),p=g.getElementsByTagName("alignObject"),v=0;v<p.length;++v){var u=p[v],u={id:u.getAttribute("intObjectId"),accession:u.getAttribute("dbAccessionId"),version:u.getAttribute("objectVersion"),dbSource:u.getAttribute("dbSource"),dbVersion:u.getAttribute("dbVersion")};
m.objects[u.id]=u}g=g.getElementsByTagName("block");for(p=0;p<g.length;++p){for(var u=g[p],v={order:u.getAttribute("blockOrder"),segments:[]},u=u.getElementsByTagName("segment"),q=0;q<u.length;++q){var r=u[q],r={object:r.getAttribute("intObjectId"),min:r.getAttribute("start"),max:r.getAttribute("end"),strand:r.getAttribute("strand"),cigar:elementValue(r,"cigar")};v.segments.push(r)}m.blocks.push(v)}b.push(m)}c(b)}else c([],"Failed request "+d)})};function DASStylesheet(){this.styles=[]}
DASStylesheet.prototype.pushStyle=function(a,b,c){a||(a={type:"default"});a=shallowCopy(a);b&&(a.zoom=b);a.style=c;this.styles.push(a)};function DASStyle(){}
DASSource.prototype.stylesheet=function(a,b){var c,d=this.credentials;this.stylesheet_uri?(c=this.stylesheet_uri,d=!1):c=this.uri+"stylesheet";doCrossDomainRequest(c,function(c){if(c){var d=new DASStylesheet;c=c.getElementsByTagName("TYPE");for(var h=0;h<c.length;++h){var g=c[h],m={};m.type=g.getAttribute("id");m.label=g.getAttribute("label");m.method=g.getAttribute("method");for(var g=g.getElementsByTagName("GLYPH"),p=0;p<g.length;++p){var v=g[p],u=v.getAttribute("zoom"),q=childElementOf(v),v=new DASStyle;
v.glyph=q.localName;for(q=q.firstChild;q;)q.nodeType==Node.ELEMENT_NODE&&(v[q.localName]=q.firstChild.nodeValue),q=q.nextSibling;d.pushStyle(m,u,v)}}a(d)}else b&&b()},d)};function DASRegistry(a,b){b=b||{};this.uri=a;this.opts=b}
DASRegistry.prototype.sources=function(a,b,c){c||(c={});var d=[];c.taxon&&d.push("organism="+c.taxon);c.auth&&d.push("authority="+c.auth);c.version&&d.push("version="+c.version);c=this.uri;0<d.length&&(c=c+"?"+d.join("&"));doCrossDomainRequest(c,function(c){if(!c&&b)b();else{var d=[];c=c.getElementsByTagName("SOURCE");for(var h=0;h<c.length;++h){var g=c[h],m=g.getElementsByTagName("VERSION");if(!(1>m.length)){for(var p=m[0],v=p.getElementsByTagName("COORDINATES"),m=[],u=0;u<v.length;++u){var q=v[u],
r=new DASCoords;r.auth=q.getAttribute("authority");r.taxon=q.getAttribute("taxid");r.version=q.getAttribute("version");m.push(r)}for(var v=[],q=p.getElementsByTagName("CAPABILITY"),t,u=0;u<q.length;++u)r=q[u],v.push(r.getAttribute("type")),"das1:features"==r.getAttribute("type")&&(t=r.getAttribute("query_uri"),t=t.substring(0,t.length-8));u={};p=p.getElementsByTagName("PROP");for(q=0;q<p.length;++q)pusho(u,p[q].getAttribute("name"),p[q].getAttribute("value"));t&&(g=new DASSource(t,{source_uri:g.getAttribute("uri"),
name:g.getAttribute("title"),desc:g.getAttribute("description"),coords:m,props:u,capabilities:v}),d.push(g))}}a(d)}})};function elementValue(a,b){var c=a.getElementsByTagName(b);return 0<c.length&&c[0].firstChild?c[0].firstChild.nodeValue:null}function childElementOf(a){if(a.hasChildNodes()){a=a.firstChild;do{if(a.nodeType==Node.ELEMENT_NODE)return a;a=a.nextSibling}while(null!=a)}return null}
function dasLinksOf(a){for(var b=[],c=a.getElementsByTagName("LINK"),d=0;d<c.length;++d){var e=c[d];e.parentNode==a&&b.push(new DASLink(e.firstChild?e.firstChild.nodeValue:"Unknown",e.getAttribute("href")))}return b}function dasNotesOf(a){var b=[];a=a.getElementsByTagName("NOTE");for(var c=0;c<a.length;++c)a[c].firstChild&&b.push(a[c].firstChild.nodeValue);return b}
function doCrossDomainRequest(a,b,c,d){if(window.XDomainRequest){var e=new XDomainRequest;e.onload=function(){var a=new ActiveXObject("Microsoft.XMLDOM");a.async=!1;a.loadXML(e.responseText);b(a)};e.open("get",a)}else e=new XMLHttpRequest,e.onreadystatechange=function(){4==e.readyState&&(200<=e.status||0==e.status)&&b(e.responseXML,e)},e.open("get",a,!0),c&&(e.withCredentials=!0),d&&e.setRequestHeader("X-DAS-Authorisation",d),e.setRequestHeader("Accept","application/xml,*/*");e.send("")}
DASSource.prototype.doCrossDomainRequest=function(a,b){var c;this.xUser&&(c="Basic "+btoa(this.xUser+":"+this.xPass));return doCrossDomainRequest(a,b,this.credentials,c)};
Browser.prototype.makeTooltip=function(a,b){var c=!1,d=this,e=null,f;f=function(b){c=!1;e&&(clearTimeout(e),e=null);a.removeEventListener("mouseout",f,!1)};var h;h=function(f){var m=f.clientX+window.scrollX,p=f.clientY+window.scrollY;e||(e=setTimeout(function(){var f=makeElement("div",b,{},{position:"absolute",top:""+(p+20)+"px",left:""+Math.max(m-30,20)+"px",backgroundColor:"rgb(250, 240, 220)",borderWidth:"1px",borderColor:"black",borderStyle:"solid",padding:"2px",maxWidth:"400px"});d.hPopupHolder.appendChild(f);
var g;g=function(b){try{d.hPopupHolder.removeChild(f)}catch(e){}window.removeEventListener("mousemove",g,!1);c&&null!=a.offsetParent&&h(b)};window.addEventListener("mousemove",g,!1);e=null},1E3))};a.addEventListener("mouseover",function(b){c=!0;a.addEventListener("mouseout",f,!1);h(b)},!1);a.addEventListener("DOMNodeRemovedFromDocument",function(a){c=!1;e&&(clearTimeout(e),e=null)},!1)};
Browser.prototype.popit=function(a,b,c,d){var e=this;d||(d={});var f=d.width||200;d=a.clientX;a=a.clientY;d+=document.documentElement.scrollLeft||document.body.scrollLeft;a+=document.documentElement.scrollTop||document.body.scrollTop;var h=window.innerWidth,g=a+30,m=Math.min(d-30,h-f-10),p=makeElement("div");p.style.position="absolute";p.style.top=""+g+"px";p.style.left=""+m+"px";p.style.width=f+"px";p.style.backgroundColor="white";p.style.borderWidth="2px";p.style.borderColor="black";p.style.borderStyle=
"solid";if(b){var v=makeElement("div","X",null,{marginTop:"-3px",padding:"3px",borderStyle:"none",borderLeftStyle:"solid",borderWidth:"1px",borderColor:"rgb(128,128,128)",cssFloat:"right"});v.style["float"]="right";v.addEventListener("mouseover",function(a){v.style.color="red"},!1);v.addEventListener("mouseout",function(a){v.style.color="black"},!1);v.addEventListener("mousedown",function(a){e.removeAllPopups()},!1);b=makeElement("div",[makeElement("span",b,null,{maxWidth:"200px"}),v],null,{backgroundColor:"rgb(230,230,250)",
borderColor:"rgb(128,128,128)",borderStyle:"none",borderBottomStyle:"solid",borderWidth:"1px",padding:"3px"});var u,q,r,t;r=function(a){a.stopPropagation();a.preventDefault();m+=a.clientX-u;8>m&&(m=8);m>h-f-32&&(m=h-f-26);g+=a.clientY-q;g=Math.max(10,g);p.style.top=""+g+"px";p.style.left=""+Math.min(m,h-f-10)+"px";u=a.clientX;q=a.clientY};t=function(a){a.stopPropagation();a.preventDefault();window.removeEventListener("mousemove",r,!1);window.removeEventListener("mouseup",t,!1)};b.addEventListener("mousedown",
function(a){a.preventDefault();a.stopPropagation();u=a.clientX;q=a.clientY;window.addEventListener("mousemove",r,!1);window.addEventListener("mouseup",t,!1)},!1);p.appendChild(b)}p.appendChild(makeElement("div",c,null,{padding:"3px",clear:"both"}));this.hPopupHolder.appendChild(p);var y={node:p,displayed:!0};p.addEventListener("DOMNodeRemoved",function(a){y.displayed=!1},!1);return y};function IconSet(a){var b=new XMLHttpRequest;b.open("get",a,!1);b.send();this.icons=b.responseXML}
IconSet.prototype.createIcon=function(a,b){var c=this.icons.getElementById(a);if(c)return c=document.importNode(c,!0),makeElementNS(NS_SVG,"g",c);alert("couldn't find "+a)};IconSet.prototype.createButton=function(a,b,c,d){c|=0;d|=0;a=this.icons.getElementById(a);a=document.importNode(a,!0);return makeElementNS(NS_SVG,"g",[makeElementNS(NS_SVG,"rect",null,{x:0,y:0,width:c,height:d,fill:"rgb(230,230,250)",stroke:"rgb(150,150,220)",strokeWidth:2}),a])};
function dlog(a){var b=document.getElementById("log");b&&b.appendChild(makeElement("p",a))}var MIN_FEATURE_PX=1,MIN_PADDING=3,DEFAULT_SUBTIER_MAX=25,NULL_BBOX={x:0,y:0,width:0,height:0};function DColour(a,b,c,d){this.red=a|0;this.green=b|0;this.blue=c|0;d&&(this.name=d)}DColour.prototype.toSvgString=function(){this.name||(this.name="rgb("+this.red+","+this.green+","+this.blue+")");return this.name};
var palette={red:new DColour(255,0,0,"red"),green:new DColour(0,255,0,"green"),blue:new DColour(0,0,255,"blue"),yellow:new DColour(255,255,0,"yellow"),white:new DColour(255,255,255,"white"),black:new DColour(0,0,0,"black")},COLOR_RE=/^#([0-9A-Fa-f]{2})([0-9A-Fa-f]{2})([0-9A-Fa-f]{2})$/;function dasColourForName(a){var b=palette[a];b||((b=COLOR_RE.exec(a))?b=new DColour("0x"+b[1]|0,"0x"+b[2]|0,"0x"+b[3]|0,a):(dlog("couldn't handle color: "+a),b=palette.black),palette[a]=b);return b}
function DGlyph(a,b,c,d){this.glyph=a;this.min=b;this.max=c;this.height=d;this.zindex=0}function DSubTier(){this.glyphs=[];this.height=0}DSubTier.prototype.add=function(a){this.glyphs.push(a);this.height=Math.max(this.height,a.height)};DSubTier.prototype.hasSpaceFor=function(a){for(var b=0;b<this.glyphs.length;++b){var c=this.glyphs[b];if(c.min<=a.max&&c.max>=a.min)return!1}return!0};
DasTier.prototype.styleForFeature=function(a){var b=zoomForScale(this.browser.scale);if(!this.stylesheet)return null;for(var c=null,d=this.stylesheet.styles,e=0;e<d.length;++e){var f=d[e];if(!(f.zoom&&f.zoom!=b)&&(!f.label||RegExp("^"+f.label+"$").test(a.label)))if(!f.method||RegExp("^"+f.method+"$").test(a.method)){if(f.type)if("default"==f.type){c||(c=f.style);continue}else if(f.type!=a.type)continue;return f.style}}return c};
function drawLine(a,b,c,d,e){var f=d.browser.origin,h=d.browser.scale,g=c.HEIGHT||30,m=d.dasSource.forceMin||c.MIN||d.currentFeaturesMinScore||0,p=d.dasSource.forceMax||c.MAX||d.currentFeaturesMaxScore||10,v=1*g/(p-m),u=c.LINEWIDTH||1,q=c.COLOR||c.COLOR1||"black";c=document.createElementNS(NS_SVG,"path");c.setAttribute("fill","none");c.setAttribute("stroke",q);c.setAttribute("stroke-width",u);u="";for(q=0;q<b.length;++q)var r=b[q],t=(((r.min|0)+(r.max|0))/2-f)*h,r=e+(g-((r.score-1*m)*v|0)),u=0==q?
"M "+t+" "+r:u+(" L "+t+" "+r);c.setAttribute("d",u);a.appendChild(c);b="line_clip_"+ ++clipIdSeed;f=document.createElementNS(NS_SVG,"clipPath");f.setAttribute("id",b);h=document.createElementNS(NS_SVG,"rect");h.setAttribute("x",-5E5);h.setAttribute("y",e-1);h.setAttribute("width",1E6);h.setAttribute("height",g+2);f.appendChild(h);a.appendChild(f);c.setAttribute("clip-path","url(#"+b+")");d.isQuantitative||(d.isQuantitative=!0,d.isLabelValid=!1);d.min!=m&&(d.min=m,d.isLabelValid=!1);d.max!=p&&(d.max=
p,d.isLabelValid=!1);d.clientMin!=e|0+g&&(d.clientMin=e|0+g,d.isLabelValid=!1);d.clientMax!=e&&(d.clientMax=e,d.isLabelValid=!1);return g|0+MIN_PADDING}
function sortFeatures(a){for(var b={},c={},d={},e={},f={},h=[],g,m,p,v=function(){p={};for(var b=0;b<a.currentFeatures.length;++b){var c=a.currentFeatures[b];c.id&&(p[c.id]=c)}},u=function(a){var b=[];if(a.parents)for(var c=0;c<a.parents.length;++c){var d=a.parents[c],e=p[d];e&&"SO:0000704"==e.typeCv&&pushnew(b,d)}return b},q=0;q<a.currentFeatures.length;++q){var r=a.currentFeatures[q];if(!r.parts)if(!r.min||!r.max)h.push(r);else{if(r.score&&"."!=r.score&&"-"!=r.score){sc=1*r.score;if(!g||sc<g)g=
sc;if(!m||sc>m)m=sc}var t=[],y=null;if(r.groups)for(var x=0;x<r.groups.length;++x){var w=r.groups[x],s=w.id;"gene"==w.type?(y=s,d[s]=shallowCopy(w)):"translation"!=w.type&&(pusho(c,s,r),d[s]=shallowCopy(w),t.push(s))}if(r.parents){p||v();for(x=0;x<r.parents.length;++x)if(w=r.parents[x],s=p[w])s.parts||(s.parts=[r]),pushnewo(c,w,s),pusho(c,w,r),d[w]||(d[w]={type:s.type,id:s.id,label:s.label||s.id}),t.push(w),w=u(s),0<w.length&&(y=w[0],s=p[w[0]],d[w[0]]={type:s.type,id:s.id,label:s.label||s.id},a.dasSource.collapseSuperGroups||
(a.dasSource.collapseSuperGroups=!0,a.isLabelValid=!1))}if(0==t.length)pusho(b,r.type,r);else if(y)for(w=0;w<t.length;++w)s=t[w],pushnewo(e,y,s),f[s]=y}}a.ungroupedFeatures=b;a.groupedFeatures=c;a.groups=d;a.superGroups=e;a.groupsToSupers=f;g&&(0<g?g=0:0>m&&(m=0),a.currentFeaturesMinScore=g,a.currentFeaturesMaxScore=m)}var clipIdSeed=0;
function drawFeatureTier(a){Date.now();sortFeatures(a);a.placard=null;a.isQuantitative=!1;for(var b=a.viewport;0<b.childNodes.length;)b.removeChild(b.firstChild);b.appendChild(a.background);drawGuidelines(a,b);var c=MIN_PADDING,d=[],e=!1,f;for(f in a.ungroupedFeatures){var h=a.ungroupedFeatures[f],g=a.styleForFeature(h[0]);if(g)if("LINEPLOT"==g.glyph)c+=Math.max(drawLine(b,h,g,a,c)),e=!0;else for(var m=0;m<h.length;++m)if(g=h[m],!g.parts){var p=glyphForFeature(g,0,a.styleForFeature(g),a);d.push(p)}}if(a.dasSource.collapseSuperGroups&&
!a.bumped)for(var v in a.superGroups){f=a.superGroups[v];a.groups[v].type=a.groups[f[0]].type;m={};for(p=0;p<f.length;++p){for(var h=a.groupedFeatures[f[p]],u=0;u<h.length;++u)g=h[u],pusho(m,g.type,g);if(a.groups[v]&&!a.groups[v].links||0==a.groups[v].links.length)a.groups[v].links=a.groups[f[0]].links;delete a.groupedFeatures[f[p]]}for(var q in m){for(var r=m[q],t=r[0],h=null,u=0;u<r.length;++u)g=r[u],g=new Range(g.min,g.max),h=h?union(h,g):g;for(var y=h.ranges(),h=0;h<y.length;++h){for(var x=y[h],
w=((x.max()|0)-(x.min()|0)+1)*f.length,s=0,u=0;u<r.length;++u)if(g=r[u],(g.min|0)<=x.max()&&(g.max|0)>=x.min())var z=Math.max(g.min|0,x.min()),g=Math.min(g.max|0,x.max()),s=s+(g-z+1);g=new DASFeature;for(k in t)g[k]=t[k];g.min=x.min();g.max=x.max();g.label&&1<f.length&&(g.label+=" ("+f.length+" vars)");g.visualWeight=1*s/w;pusho(a.groupedFeatures,v,g)}}delete a.superGroups[v]}f=[];for(var B in a.groupedFeatures)f.push(B);f.sort(function(b,c){var d=a.groupedFeatures[b][0].score-a.groupedFeatures[c][0].score;
return 0<d?-1:0==d?0:1});q={};for(h=0;h<f.length;++h)B=f[h],(p=glyphsForGroup(a.groupedFeatures[B],0,a.groups[B],a,a.dasSource.collapseSuperGroups&&!a.bumped?"collapsed_gene":"tent"))&&(q[B]=p);for(v in a.superGroups){f=a.superGroups[v];B=[];h=1E10;g=-1E10;for(m=0;m<f.length;++m)u=q[f[m]],q[f[m]]=null,u&&(B.push(u),h=Math.min(h,u.min),g=Math.max(g,u.max));for(m=0;m<B.length;++m)u=B[m],u.min=h,u.max=g,d.push(u)}for(p in q)(u=q[p])&&d.push(u);v=new DSubTier;B=[];h=!1;g=a.dasSource.subtierMax||DEFAULT_SUBTIER_MAX;
f=0;a:for(;f<d.length;++f)if(p=d[f],p=labelGlyph(a,p,b),p.bump&&(h=!0),p.bump&&(a.bumped||a.dasSource.collapseSuperGroups)){for(m=0;m<B.length;++m)if(q=B[m],q.hasSpaceFor(p)){q.add(p);continue a}B.length>=g?a.status="Too many overlapping features, truncating at "+g:(q=new DSubTier,q.add(p),B.push(q))}else v.add(p);a.hasBumpedFeatures=h;0<v.glyphs.length&&(B=[v].concat(B));v=[];e&&v.push(c);for(h=0;h<B.length;++h){q=B[h];g=q.glyphs;g=g.sort(function(a,b){return a.zindex-b.zindex});for(f=0;f<g.length;++f)p=
g[f],p.glyph&&(gypos=c,p.height<q.height&&(gypos+=q.height-p.height),p.glyph.setAttribute("transform","translate(0, "+gypos+")"),p.glyph.setAttribute("cursor","pointer"),b.appendChild(p.glyph));p.quant&&(a.isLabelValid=!1,a.isQuantitative=!0,a.min=p.quant.min,a.max=p.quant.max,a.clientMin=c+q.height,a.clientMax=c);c+=q.height+MIN_PADDING;v.push(c)}c=Math.max(a.browser.minTierHeight,c);if(2>v.length&&(b=!1,p=c,B=a.stylesheet)){f=zoomForScale(a.browser.scale);for(h=0;h<B.styles.length;++h)if(q=B.styles[h],
!q.zoom||q.zoom==f)q=q.style,q.bump&&(b=!0),q.height&&4+q.height>p&&(p=4+q.height);b&&(c=2*p)}a.wantedLayoutHeight=c;if(!a.layoutWasDone||a.browser.autoSizeTiers){a.layoutHeight=c;if(0<d.length||e)a.layoutWasDone=!0;a.placard=null}else if(a.layoutHeight!=c){d=document.createElementNS(NS_SVG,"g");e=document.createElementNS(NS_SVG,"rect");e.setAttribute("x",0);e.setAttribute("y",-20);e.setAttribute("width",a.browser.featurePanelWidth);e.setAttribute("height",20);e.setAttribute("stroke","red");e.setAttribute("stroke-width",
1);e.setAttribute("fill","white");d.appendChild(e);e=document.createElementNS(NS_SVG,"text");e.setAttribute("stroke","none");e.setAttribute("fill","red");e.setAttribute("font-family","helvetica");e.setAttribute("font-size","10pt");if(a.layoutHeight<c){for(b=0;a.layoutHeight-20>=v[b];)++b;e.appendChild(document.createTextNode("Show "+(v.length-b)+" more"))}else e.appendChild(document.createTextNode("Show less"));e.setAttribute("x",80);e.setAttribute("y",-6);d.appendChild(e);e=document.createElementNS(NS_SVG,
"path");e.setAttribute("fill","red");e.setAttribute("stroke","none");a.layoutHeight<c?e.setAttribute("d","M 30 -16 L 42 -16 L 36 -4 Z"):e.setAttribute("d","M 30 -4 L 42 -4 L 36 -16 Z");d.appendChild(e);d.addEventListener("mousedown",function(b){a.layoutHeight=a.wantedLayoutHeight;a.placard=null;a.clipTier();a.browser.arrangeTiers()},!1);e=document.createElementNS(NS_SVG,"text");e.setAttribute("stroke","none");e.setAttribute("fill","red");e.setAttribute("font-family","helvetica");e.setAttribute("font-size",
"10pt");e.appendChild(document.createTextNode("(Auto grow-shrink)"));e.setAttribute("x",750);e.setAttribute("y",-6);e.addEventListener("mousedown",function(b){b.preventDefault();b.stopPropagation();a.browser.autoSizeTiers=!0;a.browser.refresh()},!1);d.appendChild(e);a.placard=d}d=a.error||a.status;null!=d&&(c=document.createElementNS(NS_SVG,"g"),e=document.createElementNS(NS_SVG,"rect"),e.setAttribute("x",0),e.setAttribute("y",-20),e.setAttribute("width",a.browser.featurePanelWidth),e.setAttribute("height",
20),e.setAttribute("stroke","red"),e.setAttribute("stroke-width",1),e.setAttribute("fill","white"),c.appendChild(e),b=document.createElementNS(NS_SVG,"text"),b.setAttribute("stroke","none"),b.setAttribute("fill","red"),b.setAttribute("font-family","helvetica"),b.setAttribute("font-size","10pt"),b.setAttribute("x",25),b.setAttribute("y",-6),b.appendChild(document.createTextNode(d)),a.error&&(e=document.createElementNS(NS_SVG,"text"),e.setAttribute("stroke","none"),e.setAttribute("fill","red"),e.setAttribute("font-family",
"helvetica"),e.setAttribute("font-size","10pt"),e.appendChild(document.createTextNode("(Remove track)")),e.setAttribute("x",800),e.setAttribute("y",-6),e.addEventListener("mousedown",function(b){b.preventDefault();b.stopPropagation();a.browser.removeTier(a)},!1),c.appendChild(e)),c.appendChild(b),a.placard=c);a.clipTier();a.scale=1;Date.now()}
DasTier.prototype.clipTier=function(){var a=this.viewport;this.background.setAttribute("height",this.layoutHeight);var b="tier_clip_"+ ++clipIdSeed,c=document.createElementNS(NS_SVG,"clipPath");c.setAttribute("id",b);var d=document.createElementNS(NS_SVG,"rect");d.setAttribute("x",-5E5);d.setAttribute("y",0);d.setAttribute("width",1E6);d.setAttribute("height",this.layoutHeight);c.appendChild(d);a.appendChild(c);a.setAttribute("clip-path","url(#"+b+")")};
function glyphsForGroup(a,b,c,d,e){for(var f=d.browser.scale,h=d.browser.origin,g=1,m,p=null,v=null,u=null,q=null,r=null,t,y=d.styleForFeature(c),x=0;x<a.length;++x){var w=a[x],s=d.styleForFeature(w);s&&s.HEIGHT&&(t=t?Math.max(t,s.HEIGHT|0):s.HEIGHT|0)}var z=document.createElementNS(NS_SVG,"g"),B=[];z.dalliance_group=c;for(var C=[],x=0;x<a.length;++x)if(w=a[x],w.orientation&&null==q&&(q=w.orientation),w.notes&&null==v&&(v=w.notes),w.links&&null==p&&(p=w.links),(s=d.styleForFeature(w))&&!w.parts)(w=
glyphForFeature(w,b,s,d,t))&&w.glyph&&C.push(w);if(0==C.length)return null;C=C.sort(function(a,b){return a.zindex-b.zindex});for(x=0;x<C.length;++x)w=C[x],w.glyph.dalliance_group=c,B.push(w.glyph),p=new Range(w.min,w.max),u=null==u?p:union(u,p),g=Math.max(g,w.height),!m&&w.label&&(m=w.label),w.quant&&(r=w.quant);if(u){C=u.ranges();for(x=1;x<C.length;++x){p=(C[x-1].max()+1-h)*f;t=(C[x].min()-h)*f;if("collapsed_gene"==e){w=document.createElementNS(NS_SVG,"path");w.setAttribute("fill","none");w.setAttribute("stroke",
"black");w.setAttribute("stroke-width","1");var s=g/2,H="M "+p+" "+(b+s)+" L "+t+" "+(b+s);if(8<t-p){var D=0.5*t+0.5*p;"+"==q?H+=" M "+(D-2)+" "+(b+s-4)+" L "+(D+2)+" "+(b+s)+" L "+(D-2)+" "+(b+s+4):"-"==q&&(H+=" M "+(D+2)+" "+(b+s-4)+" L "+(D-2)+" "+(b+s)+" L "+(D+2)+" "+(b+s+4))}w.setAttribute("d",H)}else w=document.createElementNS(NS_SVG,"path"),w.setAttribute("fill","none"),w.setAttribute("stroke","black"),w.setAttribute("stroke-width","1"),H=!0,y&&(y.STYLE&&"hat"!=y.STYLE)&&(H=!1),s=r?g:g/2,
H&&("+"==q||"-"==q)?(D=(p+t)/2,w.setAttribute("d","M "+p+" "+(b+s)+" L "+D+" "+("-"==q?b+12:b)+" L "+t+" "+(b+s))):w.setAttribute("d","M "+p+" "+(b+s)+" L "+t+" "+(b+s));z.appendChild(w)}}for(x=0;x<B.length;++x)z.appendChild(B[x]);c.segment=a[0].segment;c.min=u.min();c.max=u.max();if(v&&(!c.notes||0==c.notes.length))c.notes=v;a=new DGlyph(z,u.min(),u.max(),g);a.strand=q;a.bump=!0;if(m||y&&(y.LABEL||y.LABELS))if(a.label=c.label||m,(m=d.groupsToSupers[c.id])&&d.superGroups[m]&&c.id!=d.superGroups[m][0])a.label=
null;r&&(a.quant=r);return a}
function glyphForFeature(a,b,c,d,e){var f=d.browser.scale,h=d.browser.origin,g=c.glyph||"BOX",m,p=a.min,v=a.max,u=a.orientation,q=a.score,r=(p-h)*f,t=(v-h+1)*f,y,x;if("HIDDEN"==g||a.parts)m=null;else if("CROSS"==g||"EX"==g||"SPAN"==g||"LINE"==g||"DOT"==g||"TRIANGLE"==g){var h=c.FGCOLOR||"black",w=c.BGCOLOR||"none";e=c.HEIGHT||e||12;y=e*=1;m=(r+t)/2;var q=e/2,s,f=r;d=t;"CROSS"==g?(s=document.createElementNS(NS_SVG,"path"),s.setAttribute("fill","none"),s.setAttribute("stroke",h),s.setAttribute("stroke-width",
1),s.setAttribute("d","M "+(m-q)+" "+(b+q)+" L "+(m+q)+" "+(b+q)+" M "+m+" "+b+" L "+m+" "+(b+e)),f=Math.min(r,m-q),d=Math.max(t,m+q)):"EX"==g?(s=document.createElementNS(NS_SVG,"path"),s.setAttribute("fill","none"),s.setAttribute("stroke",h),s.setAttribute("stroke-width",1),s.setAttribute("d","M "+(m-q)+" "+b+" L "+(m+q)+" "+(b+e)+" M "+(m+q)+" "+b+" L "+(m-q)+" "+(b+e)),f=Math.min(r,m-q),d=Math.max(t,m+q)):"SPAN"==g?(s=document.createElementNS(NS_SVG,"path"),s.setAttribute("fill","none"),s.setAttribute("stroke",
h),s.setAttribute("stroke-width",1),s.setAttribute("d","M "+r+" "+(b+q)+" L "+t+" "+(b+q)+" M "+r+" "+b+" L "+r+" "+(b+e)+" M "+t+" "+b+" L "+t+" "+(b+e))):"LINE"==g?(m=c.STYLE||"solid",s=document.createElementNS(NS_SVG,"path"),s.setAttribute("fill","none"),s.setAttribute("stroke",h),s.setAttribute("stroke-width",1),"hat"==m?(h=0,"-"==a.orientation&&(h=e),s.setAttribute("d","M "+r+" "+(b+q)+" L "+(t+r)/2+" "+(b+h)+" L "+t+" "+(b+q))):s.setAttribute("d","M "+r+" "+(b+q)+" L "+t+" "+(b+q)),"dashed"==
m&&s.setAttribute("stroke-dasharray","3")):"DOT"==g?(s=document.createElementNS(NS_SVG,"circle"),s.setAttribute("fill",h),s.setAttribute("stroke","none"),s.setAttribute("cx",m),s.setAttribute("cy",b+q),s.setAttribute("r",q),f=Math.min(r,m-q),d=Math.max(t,m+q)):"TRIANGLE"==g&&(f=c.DIRECTION||"N","FORWARD"===f?f="-"===u?"W":"E":"REVERSE"===f&&(f="-"===u?"E":"W"),d=c.LINEWIDTH||e,halfHeight=0.5*e,halfWidth=0.5*d,s=document.createElementNS(NS_SVG,"path"),"E"==f?s.setAttribute("d","M "+(m-halfWidth)+" 0 L "+
(m-halfWidth)+" "+e+" L "+(m+halfWidth)+" "+halfHeight+" Z"):"W"==f?s.setAttribute("d","M "+(m+halfWidth)+" 0 L "+(m+halfWidth)+" "+e+" L "+(m-halfWidth)+" "+halfHeight+" Z"):"S"==f?s.setAttribute("d","M "+(m+halfWidth)+" 0 L "+(m-halfWidth)+" 0 L "+m+" "+e+" Z"):s.setAttribute("d","M "+(m+halfWidth)+" "+e+" L "+(m-halfWidth)+" "+e+" L "+m+" 0 Z"),f=Math.min(r,m-halfWidth),d=Math.max(t,m+halfWidth),s.setAttribute("fill",h),s.setAttribute("stroke","none"));m=document.createElementNS(NS_SVG,"g");if("none"==
w||f<r||d>t)h=document.createElementNS(NS_SVG,"rect"),h.setAttribute("x",f),h.setAttribute("y",b),h.setAttribute("width",d-f),h.setAttribute("height",e),h.setAttribute("stroke","none"),h.setAttribute("fill","none"),h.setAttribute("pointer-events","all"),m.appendChild(h);"none"!=w&&(h=document.createElementNS(NS_SVG,"rect"),h.setAttribute("x",r),h.setAttribute("y",b),h.setAttribute("width",t-r),h.setAttribute("height",e),h.setAttribute("stroke","none"),h.setAttribute("fill",w),h.setAttribute("pointer-events",
"all"),m.appendChild(h));m.appendChild(s)}else if("PRIMERS"==g)b=c.BGCOLOR||"black",e=c.HEIGHT||e||12,y=e*=1,m=document.createElementNS(NS_SVG,"g"),h=document.createElementNS(NS_SVG,"path"),h.setAttribute("stroke",b),h.setAttribute("fill","none"),h.setAttribute("d","M "+r+" "+e/2+" L "+t+" "+e/2),m.appendChild(h),b=document.createElementNS(NS_SVG,"path"),b.setAttribute("stroke","none"),b.setAttribute("fill","arrowColor"),b.setAttribute("d","M "+r+" 0 L "+r+" "+e+" L "+(r+e)+" "+e/2+" Z M "+t+" 0 L "+
t+" "+e+" L "+(t-e)+" "+e/2+" Z"),m.appendChild(b);else if("ARROW"==g)g=c.PARALLEL?"yes"==c.PARALLEL:!0,b=c.NORTHEAST&&"yes"==c.NORTHEAST,d=c.SOUTHWEST&&"yes"==c.SOUTHWEST,h=c.FGCOLOR||"none",w=c.BGCOLOR||"green",e=c.HEIGHT||e||12,y=e*=1,s=g?0.5*e:0.25*e,u=(t+r)/2,f=g?0.25*e:0.4*e,g?(b&&t-u<e&&(t=u+e),d&&u-r<e&&(r=u-e)):t-r<0.75*e&&(r=u-0.375*e,t=u+0.375*e),m=document.createElementNS(NS_SVG,"path"),m.setAttribute("fill",w),m.setAttribute("stroke",h),"none"!=h&&m.setAttribute("stroke-width",1),g?(h=
"M "+u+" "+f,h=b?h+(" L "+(t-s)+" "+f+" L "+(t-s)+" 0 L "+t+" "+e/2+" L "+(t-s)+" "+e+" L "+(t-s)+" "+(e-f)):h+(" L "+t+" "+f+" L "+t+" "+(e-f)),h=d?h+(" L "+(r+s)+" "+(e-f)+" L "+(r+s)+" "+e+" L "+r+" "+e/2+" L "+(r+s)+"  0 L "+(r+s)+" "+f):h+(" L "+r+" "+(e-f)+" L "+r+" "+f)):(h="M "+(r+f)+" "+e/2,h=b?h+(" L "+(r+f)+" "+s+" L "+r+" "+s+" L "+u+" 0 L "+t+" "+s+" L "+(t-f)+" "+s):h+(" L "+(r+f)+" 0 L "+(t-f)+" 0"),h=d?h+(" L "+(t-f)+" "+(e-s)+" L "+t+" "+(e-s)+" L "+u+" "+e+" L "+r+" "+(e-s)+" L "+
(r+f)+" "+(e-s)):h+(" L "+(t-f)+" "+e+" L "+(r+f)+" "+e)),m.setAttribute("d",h+" Z");else if("ANCHORED_ARROW"==g)h=c.FGCOLOR||"none",w=c.BGCOLOR||"green",e=c.HEIGHT||e||12,y=e*=1,g=d=0,m=e+2,f=0.333333*e,a.orientation&&("+"==a.orientation?g=e/2:"-"==a.orientation&&(d=e/2)),t-r<m&&(r=(t+r-m)/2,t=r+m),m=document.createElementNS("http://www.w3.org/2000/svg","path"),m.setAttribute("fill",w),m.setAttribute("stroke",h),"none"!=h&&m.setAttribute("stroke-width",1),m.setAttribute("d","M "+(r+d)+" "+(b+f)+
" L "+(t-g)+" "+(b+f)+" L "+(t-g)+" "+b+" L "+t+" "+(b+e/2)+" L "+(t-g)+" "+(b+e)+" L "+(t-g)+" "+(b+f+f)+" L "+(r+d)+" "+(b+f+f)+" L "+(r+d)+" "+(b+e)+" L "+r+" "+(b+e/2)+" L "+(r+d)+" "+b+" L "+(r+d)+" "+(b+f));else if("TEXT"==g)if(w=c.FGCOLOR||"none",b=c.BGCOLOR||"none",e=c.HEIGHT||e||12,m=c.STRING,y=e,m){m=makeElementNS(NS_SVG,"text",m,{stroke:"none",fill:w});d.viewport.appendChild(m);w=NULL_BBOX;try{w=m.getBBox()}catch(z){}d.viewport.removeChild(m);m.setAttribute("x",(r+t-w.width)/2);m.setAttribute("y",
e-2);m="none"==b?m:makeElementNS(NS_SVG,"g",[makeElementNS(NS_SVG,"rect",null,{x:r,y:0,width:t-r,height:e,fill:b,stroke:"none"}),m]);w.width>t-r&&(v=r+w.width,p=((r+t-w.width)/2/f|0)+h,v=(v/f|0)+h)}else m=null;else{h=c.FGCOLOR||"none";w=a.override_color||c.BGCOLOR||c.COLOR1||"green";e=c.HEIGHT||e||12;y=e*=1;c.WIDTH?(s=c.WIDTH|0,r=(t+r-s)/2,t=r+s):t-r<MIN_FEATURE_PX&&(r=(t+r-MIN_FEATURE_PX)/2,t=r+MIN_FEATURE_PX);if(("HISTOGRAM"==g||"GRADIENT"==g)&&"undefined"!==q){s=d.dasSource.forceMin||c.MIN||d.currentFeaturesMinScore;
(u=d.dasSource.forceMax||c.MAX||d.currentFeaturesMaxScore)||(u=0>s?0:10);s||(s=0);1*q<1*s&&(q=s);1*q>1*u&&(q=u);q=(1*q-s)/(u-s);if(c.COLOR2){var B,C;c.COLOR3?0.5>q?(w=dasColourForName(c.COLOR1),B=dasColourForName(c.COLOR2),C=2*q):(w=dasColourForName(c.COLOR2),B=dasColourForName(c.COLOR3),C=2*q-1):(w=dasColourForName(c.COLOR1),B=dasColourForName(c.COLOR2),C=q);w=(new DColour(w.red*(1-C)+B.red*C|0,w.green*(1-C)+B.green*C|0,w.blue*(1-C)+B.blue*C|0)).toSvgString()}"HISTOGRAM"==g&&(x=-1*s/(u-s),q>=x?(e=
Math.max(1,(q-x)*y),b=b+(1-x)*y-e):(e=Math.max(1,(x-q)*y),b+=(1-x)*y),x={min:s,max:u});r-=0.25;t+=0.25}s=document.createElementNS(NS_SVG,"rect");s.setAttribute("x",r);s.setAttribute("y",b);s.setAttribute("width",t-r);s.setAttribute("height",e);s.setAttribute("stroke",h);s.setAttribute("stroke-width",1);s.setAttribute("fill",w);a.visualWeight&&1>a.visualWeight&&(s.setAttribute("fill-opacity",a.visualWeight),"none"!=h&&s.setAttribute("stroke-opacity",a.visualWeight));if("TOOMANY"==g){b=[s];for(w=3;w<
e;w+=3)b.push(makeElementNS(NS_SVG,"line",null,{x1:r,y1:w,x2:t,y2:w,stroke:h,strokeWidth:0.5}));m=makeElementNS(NS_SVG,"g",b)}else if(a.seq&&1<=f){d.currentSequence&&(m=d.currentSequence);t=a.seq.toUpperCase();h=[];for(w=0;w<t.length;++w)g=t.substr(w,1),d=null,m&&m.seq&&m.start<=p&&m.end>=v&&m.seq.substr((p|0)+(w|0)-(m.start|0),1).toUpperCase()!==g&&(d="red"),d||(d="gray"),8<=f?(y=document.createElementNS(NS_SVG,"text"),y.setAttribute("x",r+w*f),y.setAttribute("y",12),y.setAttribute("stroke","none"),
y.setAttribute("fill",d),y.appendChild(document.createTextNode(g)),h.push(y),y=14):(g=document.createElementNS(NS_SVG,"rect"),g.setAttribute("x",r+w*f),g.setAttribute("y",b),g.setAttribute("height",e),g.setAttribute("width",f),g.setAttribute("fill",d),g.setAttribute("stroke","none"),h.push(g));8<=f?(p-=1,v+=1):(p=Math.floor(p-1/f)|0,v=Math.ceil(v+1/f)|0);m=makeElementNS(NS_SVG,"g",h)}else m=s}m&&(m.dalliance_feature=a);p=new DGlyph(m,p,v,y);if(isDasBooleanTrue(c.LABEL)&&(a.label||a.id))p.label=a.label||
a.id;isDasBooleanTrue(c.BUMP)&&(p.bump=!0);p.strand=a.orientation||"0";x&&(p.quant=x);p.zindex=c.ZINDEX||0;return p}function isDasBooleanTrue(a){a=(""+a).toLowerCase();return"yes"===a||"true"===a}
function labelGlyph(a,b,c){var d=a.browser.scale,e=a.browser.origin;if(!1!==a.dasSource.labels&&b.glyph&&b.label){var f=b.label;a=document.createElementNS(NS_SVG,"text");a.setAttribute("x",(b.min-e)*d);a.setAttribute("y",b.height+15);a.setAttribute("stroke-width",0);a.setAttribute("fill","black");a.setAttribute("class","label-text");a.setAttribute("font-family","helvetica");a.setAttribute("font-size","10pt");"+"==b.strand?f+=">":"-"==b.strand&&(f="<"+f);a.appendChild(document.createTextNode(f));c.appendChild(a);
f=a.getBBox().width;c.removeChild(a);"g"==b.glyph.localName?c=b.glyph:(c=document.createElementNS(NS_SVG,"g"),c.appendChild(b.glyph));c.appendChild(a);b.glyph=c;b.height+=20;c=(b.min|0)+(f+10)/d;if(c>b.max){var f=(c-b.max)/2,h=(b.min-f-e)*d+5;a.setAttribute("x",h);b.min=h/d+e|0;b.max=c-f|0}else a.jiggleMin=(b.min-e)*d,a.jiggleMax=(b.max-e)*d-f}return b}function Karyoscape(a,b){this.browser=a;this.dsn=b;this.svg=makeElementNS(NS_SVG,"g");this.width=250}
Karyoscape.prototype.update=function(a,b,c){this.start=b;this.end=c;if(!this.chr||a!=this.chr){this.chr=a;removeChildren(this.svg);var d=this;this.dsn.features(new DASSegment(a),{type:"karyotype"},function(b,c,h){d.chrLen=h&&h[a]&&h[a].max?h[a].max:null;d.karyos=b||[];d.redraw()})}else this.setThumb()};
var karyo_palette={gneg:"white",gpos25:"rgb(200,200,200)",gpos33:"rgb(180,180,180)",gpos50:"rgb(128,128,128)",gpos66:"rgb(100,100,100)",gpos75:"rgb(64,64,64)",gpos100:"rgb(0,0,0)",gpos:"rgb(0,0,0)",gvar:"rgb(100,100,100)",acen:"rgb(100,100,100)",stalk:"rgb(100,100,100)"};
Karyoscape.prototype.redraw=function(){removeChildren(this.svg);this.karyos=this.karyos.sort(function(a,b){return(a.min|0)-(b.min|0)});0<this.karyos.length?this.chrLen||(this.chrLen=this.karyos[this.karyos.length-1].max):(this.chrLen||(this.chrLen=2E8),this.karyos.push({min:1,max:this.chrLen,label:"gneg"}));for(var a=null,b=0;b<this.karyos.length;++b){var c=this.karyos[b],d=1*c.min/this.chrLen*this.width,e=1*c.max/this.chrLen*this.width,f=karyo_palette[c.label];f&&e>d&&(d=makeElementNS(NS_SVG,"rect",
null,{x:d,y:"stalk"==c.label||"acen"==c.label?5:0,width:e-d,height:"stalk"==c.label||"acen"==c.label?5:15,stroke:"none",fill:f}),"g"==c.label.substring(0,1)&&(e=new Range(c.min,c.max),a=null==a?e:union(a,e)),this.browser.makeTooltip(d,c.id),this.svg.appendChild(d))}if(a){for(var a=a.ranges(),b="M 0 10 L 0 0",c="M 0 5 L 0 15",h=f=0;h<a.length;++h)e=a[h],d=1*e.min()/this.chrLen*this.width,e=1*e.max()/this.chrLen*this.width,0.75<d-f&&(b+=" M "+d+" 0",c+=" M "+d+" 15"),b+=" L "+e+" 0",c+=" L "+e+" 15",
f=e;0.75<this.width-f?(b+=" M "+this.width+" 0",c+=" M "+this.width+" 15"):(b+=" L "+this.width+" 0",c+=" L "+this.width+" 15");b+=" L "+this.width+" 10";c+=" L "+this.width+" 5";this.svg.appendChild(makeElementNS(NS_SVG,"path",null,{d:b+" "+c,stroke:"black",strokeWidth:2,fill:"none"}))}this.thumb=makeElementNS(NS_SVG,"rect",null,{x:50,y:-5,width:8,height:25,fill:"blue",fillOpacity:0.5,stroke:"none"});this.svg.appendChild(this.thumb);this.setThumb();var g=this,m,p=function(a){a.stopPropagation();
a.preventDefault();a=Math.max(-4,Math.min(a.clientX+m,g.width-4));g.thumb.setAttribute("x",a)},v=function(a){a.stopPropagation();a.preventDefault();if(g.onchange)g.onchange(1*((g.thumb.getAttribute("x")|0)+4)/g.width,!0);document.removeEventListener("mousemove",p,!0);document.removeEventListener("mouseup",v,!0)};this.thumb.addEventListener("mousedown",function(a){a.stopPropagation();a.preventDefault();m=g.thumb.getAttribute("x")-a.clientX;document.addEventListener("mousemove",p,!0);document.addEventListener("mouseup",
v,!0)},!1)};Karyoscape.prototype.setThumb=function(){var a=1*(((this.start|0)+(this.end|0))/2)/this.chrLen*this.width;this.thumb&&this.thumb.setAttribute("x",a-4)};function FetchPool(){this.reqs=[]}FetchPool.prototype.addRequest=function(a){this.reqs.push(a)};FetchPool.prototype.abortAll=function(){for(var a=0;a<this.reqs.length;++a)this.reqs[a].abort()};function KSCacheBaton(a,b,c,d,e,f){this.chr=a;this.min=b;this.max=c;this.scale=d;this.features=e||[];this.status=f}
KSCacheBaton.prototype.toString=function(){return this.chr+":"+this.min+".."+this.max+";scale="+this.scale};function KnownSpace(a,b,c,d,e,f){this.tierMap=a;this.chr=b;this.min=c;this.max=d;this.scale=e;this.seqSource=f||new DummySequenceSource;this.featureCache={}}KnownSpace.prototype.bestCacheOverlapping=function(a,b,c){return(a=this.featureCache[this.tierMap[0]])?a:null};
KnownSpace.prototype.viewFeatures=function(a,b,c,d){if(d!=d)throw"viewFeatures called with silly scale";if(a!=this.chr)throw"Can't extend Known Space to a new chromosome";this.min=b;this.max=c;this.scale=d;this.pool&&this.pool.abortAll();this.pool=new FetchPool;this.awaitedSeq=new Awaited;this.seqWasFetched=!1;this.startFetchesForTiers(this.tierMap)};
function filterFeatures(a,b,c){var d=[];featuresByGroup={};for(var e=0;e<a.length;++e){var f=a[e];!f.min||!f.max?d.push(f):f.groups&&0<f.groups.length?pusho(featuresByGroup,f.groups[0].id,f):f.min<=c&&f.max>=b&&d.push(f)}for(var h in featuresByGroup){a=featuresByGroup[h];for(var g=1E11,m=-1E11,e=0;e<a.length;++e)f=a[e],g=Math.min(g,f.min),m=Math.max(m,f.max);if(g<=c||m>=b)for(e=0;e<a.length;++e)d.push(a[e])}return d}KnownSpace.prototype.invalidate=function(a){this.featureCache[a]=null;this.startFetchesForTiers([a])};
KnownSpace.prototype.startFetchesForTiers=function(a){for(var b=this,c=this.awaitedSeq,d=!1,e=0;e<a.length;++e)this.startFetchesFor(a[e],c)&&(d=!0);if(d&&!this.seqWasFetched){this.seqWasFetched=!0;var f=this.min,h=this.max;if(this.cs&&this.cs.start<=f&&this.cs.end>=h)return a=this.cs.start==f&&this.cs.end==h?this.cs:new DASSequence(this.cs.name,f,h,this.cs.alphabet,this.cs.seq.substring(f-this.cs.start,h+1-this.cs.start)),c.provide(a);this.seqSource.fetch(this.chr,f,h,this.pool,function(a,d){if(d){if(!b.cs||
f<=b.cs.start&&h>=b.cs.end||f>=b.cs.end||h<=b.cs.start||h-f>b.cs.end-b.cs.start)b.cs=d;c.provide(d)}else dlog("Noseq: "+miniJSONify(a))})}};
KnownSpace.prototype.startFetchesFor=function(a,b){var c=this,d=a.getSource()||new DummyFeatureSource,e=a.needsSequence(this.scale),f=c.featureCache[a],h=a.getDesiredTypes(this.scale);if(void 0===h)return!1;if(f&&f.chr===this.chr&&f.min<=this.min&&f.max>=this.max){var g=f.features;if(f.min<this.min||f.max>this.max)g=filterFeatures(g,this.min,this.max);c.provision(a,f.chr,Math.max(f.min,this.min),Math.min(f.max,this.max),f.scale,h,g,f.status,e?b:null);g=d.getScales();if(f.scale<=this.scale||!g)return e}d.fetch(this.chr,
this.min,this.max,this.scale,h,this.pool,function(d,g,v){if(!f||c.min<f.min||c.max>f.max)c.featureCache[a]=new KSCacheBaton(c.chr,c.min,c.max,v,g,d);c.provision(a,c.chr,c.min,c.max,v,h,g,d,e?b:null)});return e};
KnownSpace.prototype.provision=function(a,b,c,d,e,f,h,g,m){if(g)a.updateStatus(g);else{g=!1;for(var p=a.getSource();MappedFeatureSource.prototype.isPrototypeOf(p);)p=p.source;if(BWGFeatureSource.prototype.isPrototypeOf(p)||BAMFeatureSource.prototype.isPrototypeOf(p))g=!0;if(e<this.scale/2&&200<h.length||g&&f&&1==f.length&&0<=f.indexOf("density"))h=downsample(h,this.scale);m?m.await(function(f){a.viewFeatures(b,c,d,e,h,f)}):a.viewFeatures(b,c,d,e,h)}};
function DASFeatureSource(a){this.dasSource=a}DASFeatureSource.prototype.fetch=function(a,b,c,d,e,f,h){if(e&&0==e.length)h(null,[],d);else if(this.dasSource.uri){var g=!1!==this.dasSource.maxbins;e={type:e};g&&(e.maxbins=1+((c-b)/d|0));this.dasSource.features(new DASSegment(a,b,c),e,function(a,b){var c=d;g||(c=0.1);h(b,a,c)})}};function DASSequenceSource(a){this.dasSource=a}
DASSequenceSource.prototype.fetch=function(a,b,c,d,e){this.dasSource.sequence(new DASSegment(a,b,c),function(a){return 1==a.length?e(null,a[0]):e("Didn't get sequence")})};function TwoBitSequenceSource(a){var b=this;this.source=a;this.twoBit=new Awaited;makeTwoBit(new URLFetchable(a.twoBitURI),function(a,d){d?dlog(d):b.twoBit.provide(a)})}
TwoBitSequenceSource.prototype.fetch=function(a,b,c,d,e){this.twoBit.await(function(d){d.fetch(a,b,c,function(d,f){if(f)return e(f,null);var m=new DASSequence(a,b,c,"DNA",d);return e(null,m)})})};DASFeatureSource.prototype.getScales=function(){return[]};var bwg_preflights={};
function BWGFeatureSource(a,b){var c=this;this.bwgSource=a;this.opts=b||{};c.bwgHolder=new Awaited;if(this.opts.preflight){var d=bwg_preflights[this.opts.preflight];if(!d){d=new Awaited;bwg_preflights[this.opts.preflight]=d;var e=new XMLHttpRequest;e.onreadystatechange=function(){4==e.readyState&&(200==e.status?d.provide("success"):d.provide("failure"))};e.open("get",this.opts.preflight+"?"+hex_sha1("salt"+Date.now()),!0);this.opts.credentials&&(e.withCredentials=!0);e.send("")}d.await(function(a){"success"===
a&&c.init()})}else c.init()}BWGFeatureSource.prototype.init=function(){var a=this,b,c;this.bwgSource.bwgURI?(b=makeBwgFromURL,c=this.bwgSource.bwgURI):(b=makeBwgFromFile,c=this.bwgSource.bwgBlob);b(c,function(b){a.bwgHolder.provide(b)},this.opts.credentials)};
BWGFeatureSource.prototype.fetch=function(a,b,c,d,e,f,h){var g=this;this.bwgHolder.await(function(f){if(null==f)return h("Can't access binary file",null,null);var p;p=!e||0==e.length||0<=arrayIndexOf(e,"density");g.opts.clientBin&&(p=!1);if("bigwig"==f.type||p||"undefined"!==typeof g.opts.forceReduction){p=-1;for(var v=0;v<f.zoomLevels.length;++v)if(f.zoomLevels[v].reduction<=d)p=v;else break;"undefined"!==typeof g.opts.forceReduction&&(p=g.opts.forceReduction);p=0>p?f.getUnzoomedView():f.getZoomedView(p)}else p=
f.getUnzoomedView();p.readWigData(a,b,c,function(a){var d=1E9;if("bigwig"===f.type){var e=(c-b)/a.length/2;e<d&&(d=e)}if(g.opts.link)for(e=0;e<a.length;++e){var p=a[e];p.label&&(p.links=[new DASLink("Link",g.opts.link.replace(/\$\$/,p.label))])}h(null,a,d)})})};BWGFeatureSource.prototype.getScales=function(){var a=this.bwgHolder.res;if(a){for(var b=[1],c=0;c<a.zoomLevels.length;++c)b.push(a.zoomLevels[c].reduction);return b}return null};
function BAMFeatureSource(a,b){var c=this;this.bamSource=a;this.opts=b||{};this.bamHolder=new Awaited;if(this.opts.preflight){var d=bwg_preflights[this.opts.preflight];if(!d){d=new Awaited;bwg_preflights[this.opts.preflight]=d;var e=new XMLHttpRequest;e.onreadystatechange=function(){4==e.readyState&&(200==e.status?d.provide("success"):d.provide("failure"))};e.open("get",this.opts.preflight+"?"+hex_sha1("salt"+Date.now()),!0);this.opts.credentials&&(e.withCredentials="true");e.send("")}d.await(function(a){"success"===
a&&c.init()})}else c.init()}BAMFeatureSource.prototype.init=function(){var a=this,b,c;this.bamSource.bamBlob?(b=new BlobFetchable(this.bamSource.bamBlob),c=new BlobFetchable(this.bamSource.baiBlob)):(b=new URLFetchable(this.bamSource.bamURI,{credentials:this.opts.credentials}),c=new URLFetchable(this.bamSource.baiURI||this.bamSource.bamURI+".bai",{credentials:this.opts.credentials}));makeBam(b,c,function(b){a.bamHolder.provide(b)})};
BAMFeatureSource.prototype.fetch=function(a,b,c,d,e,f,h){this.bamHolder.await(function(d){d.fetch(a,b,c,function(a,b){if(b)h(b,null,null);else{for(var c=[],d=0;d<a.length;++d){var e=a[d],f=new DASFeature;f.min=e.pos+1;f.max=e.pos+e.seq.length;f.segment=e.segment;f.type="bam";f.id=e.readName;f.notes=["Sequence="+e.seq,"CIGAR="+e.cigar,"MQ="+e.mq];f.seq=e.seq;c.push(f)}h(null,c,1E9)}})})};BAMFeatureSource.prototype.getScales=function(){return 1E9};
function MappedFeatureSource(a,b){this.source=a;this.mapping=b}MappedFeatureSource.prototype.getScales=function(){return this.source.getScales()};
MappedFeatureSource.prototype.fetch=function(a,b,c,d,e,f,h){var g=this;this.mapping.sourceBlocksForRange(a,b,c,function(b){0==b.length?h("No mapping available for this regions",[],d):(b=b[0],g.source.fetch(b.name,b.start,b.end,d,e,f,function(b,c,d){var e=[];if(c)for(var f=0;f<c.length;++f){var m=c[f],y=m.segment;0==y.indexOf("chr")&&(y=y.substr(3));var x=g.mapping.mapPoint(y,m.min),y=g.mapping.mapPoint(y,m.max);!x||!y||x.seq!=y.seq||x.seq!=a?m.parts&&0<m.parts.length&&e.push(m):(m.segment=x.seq,m.min=
x.pos,m.max=y.pos,m.min>m.max&&(y=m.max,m.max=m.min,m.min=y),x.flipped&&("-"==m.orientation?m.orientation="+":"+"==m.orientation&&(m.orientation="-")),e.push(m))}h(b,e,d)}))})};function DummyFeatureSource(){}DummyFeatureSource.prototype.getScales=function(){return null};DummyFeatureSource.prototype.fetch=function(a,b,c,d,e,f,h){return h(null,[],1E9)};function DummySequenceSource(){}DummySequenceSource.prototype.fetch=function(a,b,c,d,e){return e(null,null)};var VALID_BOUND_RE=/^-?[0-9]+(\.[0-9]+)?$/;
Browser.prototype.makeQuantConfigButton=function(a,b,c){var d=this;a.addEventListener("mousedown",function(a){a.stopPropagation();a.preventDefault();d.removeAllPopups();var c=makeElement("table"),h=makeElement("input","",{value:b.min});c.appendChild(makeElement("tr",[makeElement("td","Min:"),makeElement("td",h)]));var g=makeElement("input","",{value:b.max});c.appendChild(makeElement("tr",[makeElement("td","Max:"),makeElement("td",g)]));var m=makeElement("div","Update");m.style.backgroundColor="rgb(230,230,250)";
m.style.borderStyle="solid";m.style.borderColor="blue";m.style.borderWidth="3px";m.style.padding="2px";m.style.margin="10px";m.style.width="150px";m.addEventListener("mousedown",function(a){a.stopPropagation();a.preventDefault();VALID_BOUND_RE.test(h.value)?VALID_BOUND_RE.test(g.value)?(b.dasSource.forceMin=h.value,b.dasSource.forceMax=g.value,d.removeAllPopups(),b.draw(),d.storeStatus()):alert("Don't understand "+g.value):alert("Don't understand "+h.value)},!1);d.popit(a,"Configure: "+b.dasSource.name,
[c,m])},!1)};var __DS_SCALES=[1,2,5];function ds_scale(a){return __DS_SCALES[a%__DS_SCALES.length]*Math.pow(10,a/__DS_SCALES.length|0)}function DSBin(a,b,c){this.scale=a;this.cnt=this.tot=0;this.hasScore=!1;this.min=b;this.max=c;this.lap=0;this.covered=null}DSBin.prototype.score=function(){return 0==this.cnt?0:this.hasScore?this.tot/this.cnt:this.lap/coverage(this.covered)};
DSBin.prototype.feature=function(a){a.score&&(this.tot+=a.score,this.hasScore=!0);var b=a.max|0;a=Math.max(this.min,a.min|0);b=Math.min(this.max,b);this.lap+=1*(b-a+1);++this.cnt;b=new Range(a,b);this.covered=this.covered?union(this.covered,b):b};
function downsample(a,b){Date.now();for(var c=0;ds_scale(c+1)<b;)++c;for(var c=ds_scale(c),d=[],e=-1E10,f=1E10,h=0;h<a.length;++h){var g=a[h];if(g.groups&&0<g.groups.length)return a;for(var m=g.min/c|0,p=g.max/c|0,e=Math.max(e,p),f=Math.min(f,m);m<=p;++m){var v=d[m];v||(v=new DSBin(c,m*c,(m+1)*c-1),d[m]=v);v.feature(g)}}h=[];for(m=f;m<=e;++m)if(v=d[m])g=new DASFeature,g.segment=a[0].segment,g.min=m*c+1,g.max=(m+1)*c,g.score=v.score(),g.type="density",h.push(g);Date.now();return h}
var MIN_TILE=75,rulerTileColors=["black","white"],baseColors={A:"green",C:"blue",G:"black",T:"red"},steps=[1,2,5];function tileSizeForScale(a,b){b||(b=MIN_TILE);for(var c=steps.length;a*steps[c%steps.length]*Math.pow(10,c/steps.length|0)<b;)++c;return steps[c%steps.length]*Math.pow(10,c/steps.length|0)}
function drawGuidelines(a,b){if("background"==a.browser.guidelineStyle){var c=tileSizeForScale(a.browser.scale,teir.browser.guidelineSpacing),d=Math.max(0,(a.browser.knownStart/c|0)*c),e=knownEnd;0<a.browser.currentSeqMax&&a.browser.currentSeqMax<a.browser.knownEnd&&(e=a.browser.currentSeqMax);for(;d<=e;d+=c){var f=document.createElementNS(NS_SVG,"line");f.setAttribute("x1",(d-origin)*scale);f.setAttribute("y1",0);f.setAttribute("x2",(d-origin)*scale);f.setAttribute("y2",1E3);f.setAttribute("stroke",
"black");f.setAttribute("stroke-opacity",0.2);f.setAttribute("stroke-width",1);b.appendChild(f)}}}
function drawSeqTier(a,b){var c=a.browser.scale,d=a.knownStart,e=a.knownEnd,f=a.browser.origin,h=a.browser.currentSeqMax;if(c){for(var g=a.viewport;0<g.childNodes.length;)g.removeChild(g.firstChild);g.appendChild(a.background);drawGuidelines(a,g);var m=tileSizeForScale(c),d=Math.max(0,(d/m|0)*m),p=e;0<h&&h<e&&(p=h);e=!1;if(b&&b.seq)for(h=b.start;h<=b.end;++h){var v=b.seq.substr(h-b.start,1).toUpperCase(),u=baseColors[v];u||(u="gray");if(8<=c){var q=document.createElementNS(NS_SVG,"text");q.setAttribute("x",
(h-f)*c);q.setAttribute("y",12);q.setAttribute("stroke-width","0");q.setAttribute("fill",u);q.setAttribute("class","label-text");q.appendChild(document.createTextNode(v))}else q=document.createElementNS(NS_SVG,"rect"),q.setAttribute("x",(h-f)*c),q.setAttribute("y",5),q.setAttribute("height",10),q.setAttribute("width",c),q.setAttribute("fill",u),q.setAttribute("stroke","none");g.appendChild(q)}else e=!0;for(;d<=p;)e&&(q=document.createElementNS(NS_SVG,"rect"),q.setAttribute("x",(d-f)*c),q.setAttribute("y",
8),q.setAttribute("height",3),h=Math.min(m,p-d)*c,q.setAttribute("width",h),q.setAttribute("fill",rulerTileColors[d/m%2]),q.setAttribute("stroke-width",1),g.appendChild(q)),0==d/m%2&&(h=0,e||(g.appendChild(makeElementNS(NS_SVG,"line",null,{x1:(d-f)*c,y1:15,x2:(d-f)*c,y2:35,stroke:"rgb(80, 90, 150)",strokeWidth:1})),h+=3),q=document.createElementNS(NS_SVG,"text"),q.setAttribute("x",(d-f)*c+h),q.setAttribute("y",30),q.setAttribute("stroke-width","0"),q.setAttribute("fill","black"),q.setAttribute("class",
"label-text"),q.appendChild(document.createTextNode(""+d)),g.appendChild(q)),d+=m;a.layoutHeight=35;a.background.setAttribute("height",35);a.scale=1;a.browser.arrangeTiers()}}var hexcase=0,b64pad="";function hex_sha1(a){return rstr2hex(rstr_sha1(str2rstr_utf8(a)))}function b64_sha1(a){return rstr2b64(rstr_sha1(str2rstr_utf8(a)))}function any_sha1(a,b){return rstr2any(rstr_sha1(str2rstr_utf8(a)),b)}function hex_hmac_sha1(a,b){return rstr2hex(rstr_hmac_sha1(str2rstr_utf8(a),str2rstr_utf8(b)))}
function b64_hmac_sha1(a,b){return rstr2b64(rstr_hmac_sha1(str2rstr_utf8(a),str2rstr_utf8(b)))}function any_hmac_sha1(a,b,c){return rstr2any(rstr_hmac_sha1(str2rstr_utf8(a),str2rstr_utf8(b)),c)}function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc").toLowerCase()}function rstr_sha1(a){return binb2rstr(binb_sha1(rstr2binb(a),8*a.length))}
function rstr_hmac_sha1(a,b){var c=rstr2binb(a);16<c.length&&(c=binb_sha1(c,8*a.length));for(var d=Array(16),e=Array(16),f=0;16>f;f++)d[f]=c[f]^909522486,e[f]=c[f]^1549556828;c=binb_sha1(d.concat(rstr2binb(b)),512+8*b.length);return binb2rstr(binb_sha1(e.concat(c),672))}function rstr2hex(a){try{hexcase}catch(b){hexcase=0}for(var c=hexcase?"0123456789ABCDEF":"0123456789abcdef",d="",e,f=0;f<a.length;f++)e=a.charCodeAt(f),d+=c.charAt(e>>>4&15)+c.charAt(e&15);return d}
function rstr2b64(a){try{b64pad}catch(b){b64pad=""}for(var c="",d=a.length,e=0;e<d;e+=3)for(var f=a.charCodeAt(e)<<16|(e+1<d?a.charCodeAt(e+1)<<8:0)|(e+2<d?a.charCodeAt(e+2):0),h=0;4>h;h++)c=8*e+6*h>8*a.length?c+b64pad:c+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(f>>>6*(3-h)&63);return c}
function rstr2any(a,b){var c=b.length,d=[],e,f,h,g,m=Array(Math.ceil(a.length/2));for(e=0;e<m.length;e++)m[e]=a.charCodeAt(2*e)<<8|a.charCodeAt(2*e+1);for(;0<m.length;){g=[];for(e=h=0;e<m.length;e++)if(h=(h<<16)+m[e],f=Math.floor(h/c),h-=f*c,0<g.length||0<f)g[g.length]=f;d[d.length]=h;m=g}c="";for(e=d.length-1;0<=e;e--)c+=b.charAt(d[e]);d=Math.ceil(8*a.length/(Math.log(b.length)/Math.log(2)));for(e=c.length;e<d;e++)c=b[0]+c;return c}
function str2rstr_utf8(a){for(var b="",c=-1,d,e;++c<a.length;)d=a.charCodeAt(c),e=c+1<a.length?a.charCodeAt(c+1):0,55296<=d&&(56319>=d&&56320<=e&&57343>=e)&&(d=65536+((d&1023)<<10)+(e&1023),c++),127>=d?b+=String.fromCharCode(d):2047>=d?b+=String.fromCharCode(192|d>>>6&31,128|d&63):65535>=d?b+=String.fromCharCode(224|d>>>12&15,128|d>>>6&63,128|d&63):2097151>=d&&(b+=String.fromCharCode(240|d>>>18&7,128|d>>>12&63,128|d>>>6&63,128|d&63));return b}
function str2rstr_utf16le(a){for(var b="",c=0;c<a.length;c++)b+=String.fromCharCode(a.charCodeAt(c)&255,a.charCodeAt(c)>>>8&255);return b}function str2rstr_utf16be(a){for(var b="",c=0;c<a.length;c++)b+=String.fromCharCode(a.charCodeAt(c)>>>8&255,a.charCodeAt(c)&255);return b}function rstr2binb(a){for(var b=Array(a.length>>2),c=0;c<b.length;c++)b[c]=0;for(c=0;c<8*a.length;c+=8)b[c>>5]|=(a.charCodeAt(c/8)&255)<<24-c%32;return b}
function binb2rstr(a){for(var b="",c=0;c<32*a.length;c+=8)b+=String.fromCharCode(a[c>>5]>>>24-c%32&255);return b}
function binb_sha1(a,b){a[b>>5]|=128<<24-b%32;a[(b+64>>9<<4)+15]=b;for(var c=Array(80),d=1732584193,e=-271733879,f=-1732584194,h=271733878,g=-1009589776,m=0;m<a.length;m+=16){for(var p=d,v=e,u=f,q=h,r=g,t=0;80>t;t++){c[t]=16>t?a[m+t]:bit_rol(c[t-3]^c[t-8]^c[t-14]^c[t-16],1);var y=safe_add(safe_add(bit_rol(d,5),sha1_ft(t,e,f,h)),safe_add(safe_add(g,c[t]),sha1_kt(t))),g=h,h=f,f=bit_rol(e,30),e=d,d=y}d=safe_add(d,p);e=safe_add(e,v);f=safe_add(f,u);h=safe_add(h,q);g=safe_add(g,r)}return[d,e,f,h,g]}
function sha1_ft(a,b,c,d){return 20>a?b&c|~b&d:40>a?b^c^d:60>a?b&c|b&d|c&d:b^c^d}function sha1_kt(a){return 20>a?1518500249:40>a?1859775393:60>a?-1894007588:-899497514}function safe_add(a,b){var c=(a&65535)+(b&65535);return(a>>16)+(b>>16)+(c>>16)<<16|c&65535}function bit_rol(a,b){return a<<b|a>>>32-b}
function DSlider(a,b){b||(b={});this.width=a;this.opts=b;var c=0,d=this,e;this.svg=document.createElementNS(NS_SVG,"g");this.track=document.createElementNS(NS_SVG,"path");this.track.setAttribute("fill","grey");this.track.setAttribute("stroke","grey");this.track.setAttribute("stroke-width","1");this.track.setAttribute("d","M 0 35 L "+a+" 35 L "+a+" 15 L 0 32 Z");this.svg.appendChild(this.track);this.handle=document.createElementNS(NS_SVG,"rect");this.handle.setAttribute("x",-4);this.handle.setAttribute("y",
10);this.handle.setAttribute("width",8);this.handle.setAttribute("height",30);this.handle.setAttribute("stroke","none");this.handle.setAttribute("fill","blue");this.handle.setAttribute("fill-opacity",0.5);this.svg.appendChild(this.handle);this.getValue=function(){return c};this.setValue=function(a){0>a?a=0:a>this.width&&(a=this.width);c=a;this.handle.setAttribute("x",c-4)};this.setColor=function(a){this.handle.setAttribute("fill",a)};this.onchange=null;var f=function(b){b.stopPropagation();b.preventDefault();
b=Math.max(-4,Math.min(b.clientX+e,a-4));d.handle.setAttribute("x",b);c=b+4;if(d.onchange)d.onchange(c,!1)},h=function(a){a.stopPropagation();a.preventDefault();if(d.onchange)d.onchange(c,!0);document.removeEventListener("mousemove",f,!0);document.removeEventListener("mouseup",h,!0)};this.handle.addEventListener("mousedown",function(a){a.stopPropagation();a.preventDefault();e=d.handle.getAttribute("x")-a.clientX;document.addEventListener("mousemove",f,!0);document.addEventListener("mouseup",h,!0)},
!1)}function Range(a,b){this._min=a|0;this._max=b|0}Range.prototype.min=function(){return this._min};Range.prototype.max=function(){return this._max};Range.prototype.contains=function(a){return a>=this._min&&a<=this._max};Range.prototype.isContiguous=function(){return!0};Range.prototype.ranges=function(){return[this]};Range.prototype.toString=function(){return"["+this._min+"-"+this._max+"]"};function _Compound(a){this._ranges=a}_Compound.prototype.min=function(){return this._ranges[0].min()};
_Compound.prototype.max=function(){return this._ranges[this._ranges.length-1].max()};_Compound.prototype.contains=function(a){for(var b=0;b<this._ranges.length;++b)if(this._ranges[b].contains(a))return!0;return!1};_Compound.prototype.isContiguous=function(){return 1<this._ranges.length};_Compound.prototype.ranges=function(){return this._ranges};_Compound.prototype.toString=function(){for(var a="",b=0;b<this._ranges.length;++b)0<b&&(a+=","),a+=this._ranges[b].toString();return a};
function union(a,b){for(var c=a.ranges().concat(b.ranges()).sort(rangeOrder),d=[],e=c[0],f=1;f<c.length;++f){var h=c[f];h.min()>e.max()+1?(d.push(e),e=h):h.max()>e.max()&&(e=new Range(e.min(),h.max()))}d.push(e);return 1==d.length?d[0]:new _Compound(d)}
function intersection(a,b){for(var c=a.ranges(),d=b.ranges(),e=c.length,f=d.length,h=0,g=0,m=[];h<e&&g<f;){a=c[h];b=d[g];var p=Math.max(a.min(),b.min()),v=Math.min(a.max(),b.max());v>=p&&m.push(new Range(p,v));a.max()>b.max()?++g:++h}return 0==m.length?null:1==m.length?m[0]:new _Compound(m)}function coverage(a){var b=0;a=a.ranges();for(var c=0;c<a.length;++c)var d=a[c],b=b+(d.max()-d.min()+1);return b}
function rangeOrder(a,b){return a.min()<b.min()?-1:a.min()>b.min()?1:a.max()<b.max()?-1:b.max()>a.max()?1:0}var __tier_idSeed=0;
function DasTier(a,b,c,d){var e=this;this.id="tier"+ ++__tier_idSeed;this.browser=a;this.dasSource=new DASSource(b);this.viewport=c;this.background=d;this.req=null;this.layoutHeight=25;this.bumped=!0;this.dasSource.collapseSuperGroups&&(this.bumped=!1);this.y=0;this.layoutWasDone=!1;var f,h;if(this.dasSource.bwgURI||this.dasSource.bwgBlob)f=new BWGFeatureSource(this.dasSource,{credentials:this.dasSource.credentials,preflight:this.dasSource.preflight,clientBin:this.dasSource.clientBin,forceReduction:this.dasSource.forceReduction,
link:this.dasSource.link}),this.sourceFindNextFeature=function(a,b,c,d){f.bwgHolder.res.getUnzoomedView().getFirstAdjacent(a,b,c,function(a){0<a.length&&null!=a[0]&&d(a[0])})},!this.dasSource.uri&&!this.dasSource.stylesheet_uri&&f.bwgHolder.await(function(a){if(!a)return e.stylesheet=new DASStylesheet,e.browser.refreshTier(e);void 0===e.dasSource.collapseSuperGroups&&(12==a.definedFieldCount&&14<=a.fieldCount)&&(e.dasSource.collapseSuperGroups=!0,e.bumped=!1,e.isLabelValid=!1);"bigbed"==a.type?(e.stylesheet=
new DASStylesheet,a=new DASStyle,a.glyph="BOX",a.FGCOLOR="black",a.BGCOLOR="blue",a.HEIGHT=8,a.BUMP=!0,a.LABEL=!0,a.ZINDEX=20,e.stylesheet.pushStyle({type:"bigwig"},null,a),a.glyph="BOX",a.FGCOLOR="black",a.BGCOLOR="red",a.HEIGHT=10,a.BUMP=!0,a.ZINDEX=20,e.stylesheet.pushStyle({type:"bb-translation"},null,a),a=new DASStyle,a.glyph="BOX",a.FGCOLOR="black",a.BGCOLOR="white",a.HEIGHT=10,a.ZINDEX=10,a.BUMP=!0,a.LABEL=!0,e.stylesheet.pushStyle({type:"bb-transcript"},null,a),a=new DASStyle,a.glyph="HISTOGRAM",
a.COLOR1="white",a.COLOR2="black",a.HEIGHT=30,e.stylesheet.pushStyle({type:"density"},null,a)):(e.stylesheet=new DASStylesheet,a=new DASStyle,a.glyph="HISTOGRAM",a.COLOR1="white",a.COLOR2="black",a.HEIGHT=30,e.stylesheet.pushStyle({type:"default"},null,a));e.browser.refreshTier(e)});else if(this.dasSource.bamURI||this.dasSource.bamBlob)f=new BAMFeatureSource(this.dasSource,{credentials:this.dasSource.credentials,preflight:this.dasSource.preflight}),!this.dasSource.uri&&!this.dasSource.stylesheet_uri&&
f.bamHolder.await(function(a){e.stylesheet=new DASStylesheet;a=new DASStyle;a.glyph="HISTOGRAM";a.COLOR1="black";a.COLOR2="red";a.HEIGHT=30;e.stylesheet.pushStyle({type:"density"},"low",a);e.stylesheet.pushStyle({type:"density"},"medium",a);a=new DASStyle;a.glyph="BOX";a.FGCOLOR="black";a.BGCOLOR="blue";a.HEIGHT=8;a.BUMP=!0;a.LABEL=!1;a.ZINDEX=20;e.stylesheet.pushStyle({type:"bam"},"high",a);e.browser.refreshTier(e)});else if("sequence"==this.dasSource.tier_type)h=this.dasSource.twoBitURI?new TwoBitSequenceSource(this.dasSource):
new DASSequenceSource(this.dasSource);else{f=new DASFeatureSource(this.dasSource);var g=!1;this.dasSource.capabilities&&0<=arrayIndexOf(this.dasSource.capabilities,"das1:adjacent-feature")&&(this.sourceFindNextFeature=function(a,b,c,d){if(g)return dlog("Already looking for a next feature, be patient!");g=!0;a={adjacent:a+":"+(b|0)+":"+(0<c?"F":"B")};if(b=e.getDesiredTypes(e.browser.scale))a.types=b;e.dasSource.features(null,a,function(a){g=!1;0<a.length&&null!=a[0]&&(dlog("DAS adjacent seems to be working..."),
d(a[0]))})})}this.dasSource.mapping&&(f=new MappedFeatureSource(f,this.browser.chains[this.dasSource.mapping]));this.featureSource=f;this.sequenceSource=h;this.setBackground()}DasTier.prototype.toString=function(){return this.id};
DasTier.prototype.init=function(){var a=this;if(a.dasSource.uri||a.dasSource.stylesheet_uri)a.status="Fetching stylesheet",this.dasSource.stylesheet(function(b){a.stylesheet=b;a.browser.refreshTier(a)},function(){a.stylesheet=new DASStylesheet;var b=new DASStyle;b.glyph="BOX";b.BGCOLOR="blue";b.FGCOLOR="black";a.stylesheet.pushStyle({type:"default"},null,b);a.browser.refreshTier(a)});else if(a.dasSource.twoBitURI){a.stylesheet=new DASStylesheet;var b=new DASStyle;b.glyph="BOX";b.BGCOLOR="blue";b.FGCOLOR=
"black";a.stylesheet.pushStyle({type:"default"},null,b);a.browser.refreshTier(a)}};DasTier.prototype.styles=function(a){return null==this.stylesheet?null:0.2<this.browser.scale?this.stylesheet.highZoomStyles:0.01<this.browser.scale?this.stylesheet.mediumZoomStyles:this.stylesheet.lowZoomStyles};DasTier.prototype.getSource=function(){return this.featureSource};
DasTier.prototype.getDesiredTypes=function(a){a=[];var b=!1,c=zoomForScale(this.browser.scale);if(this.stylesheet){for(var d=this.stylesheet.styles,e=0;e<d.length;++e){var f=d[e];if(!f.zoom||f.zoom==c)if(!f.type||"default"==f.type){b=!0;break}else pushnew(a,f.type)}return b?null:a}};DasTier.prototype.needsSequence=function(a){return"sequence"===this.dasSource.tier_type&&5>a||(this.dasSource.bamURI||this.dasSource.bamBlob)&&20>a?!0:!1};DasTier.prototype.setStatus=function(a){dlog(a)};
DasTier.prototype.viewFeatures=function(a,b,c,d,e,f){this.currentFeatures=e;this.currentSequence=f;this.knownChr=a;this.knownStart=b;this.knownEnd=c;this.error=this.status=null;this.setBackground();this.draw()};DasTier.prototype.updateStatus=function(a){a&&(this.currentFeatures=[],this.currentSequence=null,this.error=a);this.setBackground();this.draw()};
DasTier.prototype.draw=function(){var a=this.currentSequence;"sequence"===this.dasSource.tier_type?drawSeqTier(this,a):drawFeatureTier(this);this.originHaxx=0;this.browser.arrangeTiers()};function zoomForScale(a){return 0.2<a?"high":0.01<a?"medium":"low"}DasTier.prototype.setBackground=function(){var a=this.knownEnd||-100000001;this.background.setAttribute("x",((this.knownStart||-1E8)-this.browser.origin)*this.browser.scale);this.background.setAttribute("width",(a-this.knownStart+1)*this.browser.scale)};
DasTier.prototype.sourceFindNextFeature=function(a,b,c,d){d(null)};
DasTier.prototype.findNextFeature=function(a,b,c,d,e){if(this.knownStart&&(b>=this.knownStart&&b<=this.knownEnd)&&this.currentFeatures){for(var f=null,h=0;h<this.currentFeatures.length;++h){var g=this.currentFeatures[h];if(g.min&&g.max&&!(g.parents&&0<g.parents.length))if(0>c)if(1==d&&g.max>=b&&g.min<b){if(!f||g.min>f.min||g.min==f.min&&g.max<f.max)f=g}else{if(g.max<b&&(!f||g.max>f.max||g.max==f.max&&g.min<f.min||g.min==f.mmin&&f.max>=b))f=g}else if(1==d&&g.min<=b&&g.max>b){if(!f||g.max<f.max||g.max==
f.max&&g.min>f.min)f=g}else if(g.min>b&&(!f||g.min<f.min||g.min==f.min&&g.max>f.max||g.max==f.max&&f.min<=b))f=g}if(f)return e(f);b=0>c?this.knownStart:this.knownEnd}this.sourceFindNextFeature(a,b,c,e)};Browser.prototype.currentlyActive=function(a){for(var b=0;b<this.tiers.length;++b){var c=this.tiers[b].dasSource;if(c.uri==a.uri||c.uri==a.uri+"/")if(!c.tier_type||a.tier_type&&a.tier_type==c.tier_type)if(!c.stylesheet_uri||a.stylesheet_uri&&a.stylesheet_uri==c.stylesheet_uri)return!0}return!1};
Browser.prototype.makeButton=function(a,b){var c=makeElement("span",a);c.style.backgroundColor="rgb(230,230,250)";c.style.borderStyle="solid";c.style.borderColor="red";c.style.borderWidth="3px";c.style.padding="4px";c.style.marginLeft="10px";c.style.marginRight="10px";c.style["float"]="left";b&&this.makeTooltip(c,b);return c};function activateButton(a,b){for(var c=0;c<a.length;++c){var d=a[c];d.style.borderColor=d==b?"red":"blue"}}
Browser.prototype.showTrackAdder=function(a){function b(){F="bin";J.style.visibility="hidden";removeChildren(A);g.supportsBinary?(A.appendChild(makeElement("h2","Add custom URL-based data")),A.appendChild(makeElement("p",["You can add indexed binary data hosted on an web server that supports CORS (",makeElement("a","full details",{href:"http://www.biodalliance.org/bin.html"}),").  Currently supported formats are bigwig, bigbed, and indexed BAM."])),A.appendChild(makeElement("br")),A.appendChild(document.createTextNode("URL: ")),
s=makeElement("input","",{size:80,value:"http://www.biodalliance.org/datasets/ensGene.bb"}),A.appendChild(s),s.focus(),A.appendChild(makeElement("br")),A.appendChild(makeElement("b","- or -")),A.appendChild(makeElement("br")),A.appendChild(document.createTextNode("File: ")),H=makeElement("input",null,{type:"file"}),A.appendChild(H),A.appendChild(makeElement("p",'Clicking the "Add" button below will initiate a series of test queries.'))):(A.appendChild(makeElement("h2","Your browser does not support binary data")),
A.appendChild(makeElement("p","Browsers currently known to support this feature include Google Chrome 9 or later and Mozilla Firefox 4 or later.")))}function c(){if(F)if("das"===F){var a=s.value.trim();/^.+:\/\//.exec(a)||(a="http://"+a);a=new DASSource({name:"temporary",uri:a});P(a)}else if("bin"===F){var c={name:"temporary"};(a=H.files)&&0<a.length&&a[0]?(c.bwgBlob=a[0],c.noPersist=!0):(a=s.value.trim(),/^.+:\/\//.exec(a)||(a="http://"+a),c.bwgURI=a);a=new DASSource(c);Q(a)}else"reset"===F?N():
"reset-bin"===F?b():"prompt-bai"===F?(a=H.files)&&0<a.length&&a[0]?(E.baiBlob=a[0],f(E)):e(E):"finalize"===F&&(E.name=z.value,c=B.value,E.mapping="__default__"!=c?c:void 0,C&&(E.maxbins=C.checked),1<D.value.length&&1<G.value.length&&(dlog("password"),E.xUser=D.value,E.xPass=G.value),g.sources.push(E),g.makeTier(E),g.storeStatus(),g.removeAllPopups());else{for(c=0;c<w.length;++c)a=w[c],a.checked&&(a=a.dalliance_source,g.sources.push(a),g.makeTier(a),g.storeStatus());g.removeAllPopups()}}function d(a,
b){var c=a.uri;if(b){var e=/(.+)\/[^\/]+\/?/.exec(c);e&&(c=e[1]+"/sources")}(new DASRegistry(c,{credentials:a.credentials})).sources(function(c){if(!c||0==c.length)return b?O(a):d(a,!0);var e=null;if(1==c.length)e=c[0];else for(var f=0;f<c.length;++f)if(c[f].uri===a.uri){e=c[f];break}f=c=!1;if(e&&(a.name=e.name,a.desc=e.desc,a.maxbins=e.maxbins?!0:!1,e.capabilities&&(a.capabilities=e.capabilities),f=!0,e.coords&&1==e.coords.length))if(e=e.coords[0],coordsMatch(e,g.coordSystem))c=!0;else if(g.chains)for(var h in g.chains)coordsMatch(e,
g.chains[h].coords)&&(a.mapping=h,c=!0);return O(a,c,f)},function(){return b?O(a):d(a,!0)})}function e(a){removeChildren(A);F="prompt-bai";A.appendChild(makeElement("h2","Select an index file"));A.appendChild(makeElement("p","Dalliance requires a BAM index (.bai) file when displaying BAM data.  These normally accompany BAM files.  For security reasons, web applications like Dalliance can only access local files which you have explicity selected.  Please use the file chooser below to select the appropriate BAI file"));
A.appendChild(document.createTextNode("Index file: "));H=makeElement("input",null,{type:"file"});A.appendChild(H);E=a}function f(a){(a.baiBlob?new BlobFetchable(a.baiBlob):new URLFetchable(a.bwgURI+".bai")).slice(0,256).fetch(function(b){var c=!1;b&&(b=new Uint8Array(b),c=readInt(b,0)==BAI_MAGIC);if(c){if(b=/\/?([^/]+?)(.bam)?$/.exec(a.bwgURI||a.bwgBlob.name))a.name=b[1];a.bamURI=a.bwgURI;a.bamBlob=a.bwgBlob;a.bwgURI=void 0;a.bwgBlob=void 0;return O(a,!1,!1,!0)}return h("You have selected a valid BAM file, but a corresponding index (.bai) file was not found.  Please index your BAM (samtools index) and place the BAI file in the same directory")})}
function h(a){removeChildren(A);a=a||"Custom data format not recognized";A.appendChild(makeElement("h2","Error adding custom data"));A.appendChild(makeElement("p",a));A.appendChild(makeElement("p","Currently supported formats are bigBed, bigWig, and BAM."));F="reset-bin"}var g=this,m=document.createElement("div");m.appendChild(makeElement("div",null,{},{clear:"both",height:"10px"}));var p=[],v,u,q=this.makeButton("Registry","Browse compatible datasources from the DAS registry");p.push(q);for(var r in this.mappableSources)(function(a){var b=
g.makeButton(g.chains[a].srcTag,"Browse datasources mapped from "+g.chains[a].srcTag);p.push(b);b.addEventListener("mousedown",function(c){c.preventDefault();c.stopPropagation();activateButton(p,b);v(g.mappableSources[a],a)},!1)})(r);var t=this.makeButton("Defaults","Browse the default set of data for this browser");p.push(t);var y=this.makeButton("Custom","Add arbitrary DAS data");p.push(y);var x=this.makeButton("Binary","Add data in bigwig or bigbed format");p.push(x);activateButton(p,q);m.appendChild(makeElement("div",
p),null);m.appendChild(makeElement("div",null,{},{clear:"both",height:"10px"}));var w=[],s,z,B,C,H,D,G,F=!1,E=null;r=makeElement("form",null,{},{clear:"both"});r.addEventListener("submit",function(a){a.stopPropagation();a.preventDefault();c();return!1},!0);var A=document.createElement("div");A.style.position="relative";A.style.overflow="auto";A.style.height="400px";r.appendChild(A);var M,L;v=function(a,b){J.style.visibility="visible";L&&L.removeListener(u);M=b;L=a;L.addListenerAndFire(u)};u=function(a){F=
!1;w=[];removeChildren(A);if(a){var b=document.createElement("table");b.style.width="100%";for(var c=0,d=[],e=0;e<a.length;++e)d.push(a[e]);d.sort(function(a,b){return a.name.toLowerCase().trim().localeCompare(b.name.toLowerCase().trim())});for(e=0;e<d.length;++e){a=d[e];var f=document.createElement("tr");f.style.backgroundColor=g.tierBackgroundColors[c%g.tierBackgroundColors.length];var h=document.createElement("td");h.style.textAlign="center";if(g.currentlyActive(a))h.appendChild(document.createTextNode("X")),
g.makeTooltip(h,"This data source is already active.");else if(!a.props||a.props.cors){var m=document.createElement("input");m.type="checkbox";m.dalliance_source=a;M&&(m.dalliance_mapping=M);h.appendChild(m);w.push(m);g.makeTooltip(h,"Check here then click 'Add' to activate.")}else h.appendChild(document.createTextNode("!")),g.makeTooltip(h,makeElement("span",["This data source isn't accessible because it doesn't support ",makeElement("a","CORS",{href:"http://www.w3.org/TR/cors/"}),"."]));f.appendChild(h);
h=document.createElement("td");h.appendChild(document.createTextNode(a.name));a.desc&&0<a.desc.length&&g.makeTooltip(h,a.desc);f.appendChild(h);b.appendChild(f);++c}A.appendChild(b)}else A.appendChild(makeElement("p","Dalliance was unable to retrieve data source information from the DAS registry, please try again later"))};q.addEventListener("mousedown",function(a){a.preventDefault();a.stopPropagation();activateButton(p,q);v(g.availableSources)},!1);t.addEventListener("mousedown",function(a){a.preventDefault();
a.stopPropagation();activateButton(p,t);v(new Observed(g.defaultSources))},!1);x.addEventListener("mousedown",function(a){a.preventDefault();a.stopPropagation();activateButton(p,x);b()},!1);y.addEventListener("mousedown",function(a){a.preventDefault();a.stopPropagation();activateButton(p,y);N()},!1);var N=function(){F="das";J.style.visibility="hidden";removeChildren(A);var a=makeElement("div");a.appendChild(makeElement("h2","Add custom DAS data"));a.appendChild(makeElement("p","This interface is intended for adding custom or lab-specific data.  Public data can be added more easily via the registry interface."));
a.appendChild(document.createTextNode("URL: "));a.appendChild(makeElement("br"));s=makeElement("input","",{size:80,value:"http://www.derkholm.net:8080/das/medipseq_reads/"});a.appendChild(s);a.appendChild(makeElement("p",'Clicking the "Add" button below will initiate a series of test queries.  If the source is password-protected, you may be prompted to enter credentials.'));A.appendChild(a);s.focus()},I=document.createElement("span");I.style.backgroundColor="rgb(230,230,250)";I.style.borderStyle=
"solid";I.style.borderColor="blue";I.style.borderWidth="3px";I.style.padding="2px";I.style.margin="10px";I.style.width="150px";I.appendChild(document.createTextNode("Add"));I.addEventListener("mousedown",function(a){a.stopPropagation();a.preventDefault();c()},!1);var P=function(a,b){var c=g.knownSpace;if(c){var e=Math.max(c.min,(c.min+c.max-100)/2)|0,c=new DASSegment(c.chr,e,Math.min(e+99,c.max));a.features(c,{},function(c,e){if(e)b?(removeChildren(A),A.appendChild(makeElement("h2","Custom data not found")),
A.appendChild(makeElement("p","DAS uri: "+a.uri+" is not answering features requests")),F="reset"):(dlog("retrying with credentials"),a.credentials=!0,P(a,!0));else{var f=/\/([^/]+)\/?$/.exec(a.uri);f&&(a.name=f[1]);d(a)}})}else alert("Can't confirm track-addition to an uninit browser.")},Q=function(a){(a.bwgURI?new URLFetchable(a.bwgURI):new BlobFetchable(a.bwgBlob)).slice(0,65536).fetch(function(b,c){if(b){var d=new Uint8Array(b),g=readInt(d,0);if(g==BIG_WIG_MAGIC||g==BIG_BED_MAGIC){if(d=/\/?([^/]+?)(.bw|.bb|.bigWig|.bigBed)?$/.exec(a.bwgURI||
a.bwgBlob.name))a.name=d[1];return O(a,!1,!1,!0)}if(31!=d[0]||139!=d[1])return h();d=unbgzf(b);d=new Uint8Array(d);g=readInt(d,0);return g==BAM_MAGIC?a.bwgBlob?e(a):f(a):h()}removeChildren(A);A.appendChild(makeElement("h2","Custom data not found"));a.bwgURI?A.appendChild(makeElement("p","Data URI: "+a.bwgURI+" is not accessible.")):A.appendChild(makeElement("p","File access failed, are you using an up-to-date browser?"));c&&A.appendChild(makeElement("p",""+c));A.appendChild(makeElement("p","If in doubt, please check that the server where the file is hosted supports CORS."));
F="reset-bin"})},O=function(a,b,c,d){removeChildren(A);A.appendChild(makeElement("h2","Add custom data: step 2"));A.appendChild(document.createTextNode("Label: "));z=makeElement("input","",{value:a.name});A.appendChild(z);A.appendChild(document.createTextNode("User: "));D=makeElement("input","");A.appendChild(D);A.appendChild(document.createTextNode("Pass: "));G=makeElement("input","");A.appendChild(G);A.appendChild(makeElement("br"));A.appendChild(makeElement("br"));A.appendChild(makeElement("h4",
"Coordinate system: "));B=makeElement("select",null);B.appendChild(makeElement("option",g.coordSystem.auth+g.coordSystem.version,{value:"__default__"}));if(g.chains)for(var e in g.chains){var f=g.chains[e].coords;B.appendChild(makeElement("option",f.auth+f.version,{value:e}))}B.value=a.mapping||"__default__";A.appendChild(B);b?A.appendChild(makeElement("p","(Based on server response, probably doesn't need changing.)")):(A.appendChild(makeElement("p",[makeElement("b","Warning: "),"unable to determine the correct value from server responses.  Please check carefully."])),
A.appendChild(makeElement("p","If you don't see the mapping you're looking for, please contact thomas@biodalliance.org")));d||(A.appendChild(document.createTextNode("Quantitative: ")),C=makeElement("input",null,{type:"checkbox",checked:!0}),"undefined"!==typeof a.maxbins&&(C.checked=a.maxbins),A.appendChild(C),c?A.appendChild(makeElement("p","(Based on server response, probably doesn't need changing.)")):A.appendChild(makeElement("p",[makeElement("b","Warning: "),"unable to determine correct value.  If in doubt, leave checked."])));
a.bwgBlob&&A.appendChild(makeElement("p",[makeElement("b","Warning: "),"data added from local file.  Due to the browser security model, the track will disappear if you reload Dalliance."]));z.focus();F="finalize";E=a},K=document.createElement("span");K.style.backgroundColor="rgb(230,230,250)";K.style.borderStyle="solid";K.style.borderColor="blue";K.style.borderWidth="3px";K.style.padding="2px";K.style.margin="10px";K.style.width="150px";K.appendChild(document.createTextNode("Cancel"));K.addEventListener("mousedown",
function(a){a.stopPropagation();a.preventDefault();g.removeAllPopups()},!1);var J=makeElement("span","Refresh");J.style.backgroundColor="rgb(230,230,250)";J.style.borderStyle="solid";J.style.borderColor="blue";J.style.borderWidth="3px";J.style.padding="2px";J.style.margin="10px";J.style.width="120px";J.addEventListener("mousedown",function(a){a.stopPropagation();a.preventDefault();g.queryRegistry(M)},!1);this.makeTooltip(J,"Click to re-fetch data from the DAS registry");I=makeElement("div",[I,K,J]);
I.style.margin="10px";r.appendChild(I);m.appendChild(r);v(g.availableSources);return this.popit(a,"Add DAS data",m,{width:600})};var TWOBIT_MAGIC=440477507;function TwoBitFile(){}
function makeTwoBit(a,b){var c=new TwoBitFile;c.data=a;c.data.slice(0,1024).fetch(function(a){if(!a)return b(null,"Couldn't access data");a=new Uint8Array(a);if(readInt(a,0)!=TWOBIT_MAGIC)return b(null,"Not a .2bit fie");var e=readInt(a,4);if(0!=e)return b(null,"Unsupported version "+e);c.seqCount=readInt(a,8);c.seqDict={};for(var e=16,f=0;f<c.seqCount;++f){for(var h=a[e++],g="",m=1;m<=h;++m)g+=String.fromCharCode(a[e++]);h=readInt(a,e);e+=4;c.seqDict[g]=new TwoBitSeq(c,h)}return b(c)})}
TwoBitFile.prototype.getSeq=function(a){var b=this.seqDict[a];b||(b=this.seqDict["chr"+a]);return b};TwoBitFile.prototype.fetch=function(a,b,c,d){var e=this.getSeq(a);if(e)e.fetch(b,c,d);else return d(null,"Couldn't find "+a)};function TwoBitSeq(a,b){this.tbf=a;this.offset=b}
TwoBitSeq.prototype.init=function(a){if(this.seqOffset)return a();var b=this;b.tbf.data.slice(b.offset,8).fetch(function(c){if(!c)return a("Fetch failed");c=new Uint8Array(c);b.length=readInt(c,0);b.nBlockCnt=readInt(c,4);b.tbf.data.slice(b.offset+8,8*b.nBlockCnt+4).fetch(function(c){if(!c)return a("Fetch failed");c=new Uint8Array(c);for(var e=null,f=0;f<b.nBlockCnt;++f)var h=readInt(c,4*f),g=readInt(c,4*(f+b.nBlockCnt)),h=new Range(h,h+g-1),e=e?union(e,h):h;b.nBlocks=e;b.mBlockCnt=readInt(c,8*b.nBlockCnt);
b.seqLength=(b.length+3)/4|0;b.seqOffset=b.offset+16+8*(b.nBlockCnt+b.mBlockCnt);return a()})})};var TWOBIT_TABLE=["T","C","A","G"];
TwoBitSeq.prototype.fetch=function(a,b,c){--a;--b;var d=this;this.init(function(e){if(e)return c(null,e);var f=a>>2;e=b+3>>2;if(0>f||e>d.seqLength)return c("Coordinates out of bounds: "+a+":"+b);d.tbf.data.slice(d.seqOffset+f,e-f).fetch(function(e){function g(a){for(;u<=a;){var b=u&3,c=m[(u>>2)-f];v+=TWOBIT_TABLE[0==b?c>>6&3:1==b?c>>4&3:2==b?c>>2&3:c&3];++u}}if(null==e)return c("SeqFetch failed");var m=new Uint8Array(e);e=[];if(d.nBlocks){var p=intersection(new Range(a,b),d.nBlocks);p&&(e=p.ranges())}for(var v=
"",u=a,p=0;p<e.length;++p){var q=e[p];if(u>q.min())throw"N mismatch...";for(u<q.min()&&g(q.min()-1);u<q.max();)v+="N",++u}u<b&&g(b);return c(v)})})};TwoBitSeq.prototype.length=function(a){var b=this;this.init(function(c){return c?a(null,c):a(b.length)})};var NUM_REGEXP=/[0-9]+/;function stringToNumbersArray(a){for(var b=[],c;c=NUM_REGEXP.exec(a);)b.push(c[0]),a=a.substring(c.index+c[0].length);return b}var STRICT_NUM_REGEXP=/^[0-9]+$/;
function stringToInt(a){a=a.replace(RegExp(",","g"),"");return!STRICT_NUM_REGEXP.test(a)?null:a|0}function pushnew(a,b){for(var c=0;c<a.length;++c)if(a[c]==b)return;a.push(b)}function pusho(a,b,c){a[b]?a[b].push(c):a[b]=[c]}function pushnewo(a,b,c){var d=a[b];if(d){for(a=0;a<d.length;++a)if(d[a]==c)return;d.push(c)}else a[b]=[c]}function pick(a,b,c,d){if(a)return a;if(b)return b;if(c)return c;if(d)return d}function pushnew(a,b){for(var c=0;c<a.length;++c)if(a[c]==b)return;a.push(b)}
function maybeConcat(a,b){var c=[];if(a)for(var d=0;d<a.length;++d)pushnew(c,a[d]);if(b)for(d=0;d<b.length;++d)pushnew(c,b[d]);return c}function arrayIndexOf(a,b){if(!a)return-1;for(var c=0;c<a.length;++c)if(a[c]===b)return c;return-1}function arrayRemove(a,b){var c=arrayIndexOf(a,b);return 0<=c?(a.splice(c,1),!0):!1}
function makeElement(a,b,c,d){a=document.createElement(a);if(b){b instanceof Array||(b=[b]);for(var e=0;e<b.length;++e){var f=b[e];"string"==typeof f&&(f=document.createTextNode(f));a.appendChild(f)}}if(c)for(var h in c)a[h]=c[h];if(d)for(h in d)a.style[h]=d[h];return a}function makeElementNS(a,b,c,d){a=document.createElementNS(a,b);if(c){c instanceof Array||(c=[c]);for(b=0;b<c.length;++b){var e=c[b];"string"==typeof e&&(e=document.createTextNode(e));a.appendChild(e)}}setAttrs(a,d);return a}
var attr_name_cache={};function setAttr(a,b,c){var d=attr_name_cache[b];if(!d){for(var d="",e=0;e<b.length;++e)var f=b.substring(e,e+1),h=f.toLowerCase(),d=h!=f?d+"-"+h:d+f;attr_name_cache[b]=d}a.setAttribute(d,c)}function setAttrs(a,b){if(b)for(var c in b)setAttr(a,c,b[c])}function removeChildren(a){if(a&&a.childNodes)for(;0<a.childNodes.length;)a.removeChild(a.firstChild)}
function miniJSONify(a){if("undefined"===typeof a)return"undefined";if(null==a)return"null";if("string"==typeof a)return"'"+a+"'";if("number"==typeof a||"boolean"==typeof a)return""+a;if("object"==typeof a){if(a instanceof Array){for(var b=null,c=0;c<a.length;++c)b=(null==b?"":b+", ")+miniJSONify(a[c]);return"["+(b?b:"")+"]"}b=null;for(c in a)void 0!=c&&"function"!=typeof a[c]&&(b=(null==b?"":b+", ")+c+": "+miniJSONify(a[c]));return"{"+(b?b:"")+"}"}return typeof a}
function shallowCopy(a){n={};for(k in a)n[k]=a[k];return n}function Observed(a){this.value=a;this.listeners=[]}Observed.prototype.addListener=function(a){this.listeners.push(a)};Observed.prototype.addListenerAndFire=function(a){this.listeners.push(a);a(this.value)};Observed.prototype.removeListener=function(a){arrayRemove(this.listeners,a)};Observed.prototype.get=function(){return this.value};Observed.prototype.set=function(a){this.value=a;for(var b=0;b<this.listeners.length;++b)this.listeners[b](a)};
function Awaited(){this.queue=[]}Awaited.prototype.provide=function(a){if(this.res)throw"Resource has already been provided.";this.res=a;for(var b=0;b<this.queue.length;++b)this.queue[b](a)};Awaited.prototype.await=function(a){if(this.res)return a(this.res),this.res;this.queue.push(a)};"trim"in String.prototype||(String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")});
var VERSION={CONFIG:3,MAJOR:0,MINOR:7,MICRO:0,PATCH:"pre5",BRANCH:"",toString:function(){var a=""+this.MAJOR+"."+this.MINOR+"."+this.MICRO;this.PATCH&&(a+=this.PATCH);this.BRANCH&&""!=this.BRANCH&&(a=a+"-"+this.BRANCH);return a}},JSON;JSON||(JSON={});
(function(){function a(a){return 10>a?"0"+a:a}function b(a){e.lastIndex=0;return e.test(a)?'"'+a.replace(e,function(a){var b=g[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function c(a,d){var e,g,r,t,y=f,x,w=d[a];w&&("object"===typeof w&&"function"===typeof w.toJSON)&&(w=w.toJSON(a));"function"===typeof m&&(w=m.call(d,a,w));switch(typeof w){case "string":return b(w);case "number":return isFinite(w)?String(w):"null";case "boolean":case "null":return String(w);
case "object":if(!w)return"null";f+=h;x=[];if("[object Array]"===Object.prototype.toString.apply(w)){t=w.length;for(e=0;e<t;e+=1)x[e]=c(e,w)||"null";r=0===x.length?"[]":f?"[\n"+f+x.join(",\n"+f)+"\n"+y+"]":"["+x.join(",")+"]";f=y;return r}if(m&&"object"===typeof m){t=m.length;for(e=0;e<t;e+=1)g=m[e],"string"===typeof g&&(r=c(g,w))&&x.push(b(g)+(f?": ":":")+r)}else for(g in w)Object.hasOwnProperty.call(w,g)&&(r=c(g,w))&&x.push(b(g)+(f?": ":":")+r);r=0===x.length?"{}":f?"{\n"+f+x.join(",\n"+f)+"\n"+
y+"}":"{"+x.join(",")+"}";f=y;return r}}"function"!==typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(b){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(a){return this.valueOf()});var d=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
e=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,f,h,g={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},m;"function"!==typeof JSON.stringify&&(JSON.stringify=function(a,b,d){var e;h=f="";if("number"===typeof d)for(e=0;e<d;e+=1)h+=" ";else"string"===typeof d&&(h=d);if((m=b)&&"function"!==typeof b&&("object"!==typeof b||"number"!==typeof b.length))throw Error("JSON.stringify");return c("",{"":a})});
"function"!==typeof JSON.parse&&(JSON.parse=function(a,b){function c(a,d){var e,f,g=a[d];if(g&&"object"===typeof g)for(e in g)Object.hasOwnProperty.call(g,e)&&(f=c(g,e),void 0!==f?g[e]=f:delete g[e]);return b.call(a,d,g)}var e;a=String(a);d.lastIndex=0;d.test(a)&&(a=a.replace(d,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return e=eval("("+a+")"),"function"===typeof b?c({"":e},""):e;throw new SyntaxError("JSON.parse");})})();
var MAX_WBITS=15,DEF_WBITS=MAX_WBITS,MAX_MEM_LEVEL=9,MANY=1440,BMAX=15,PRESET_DICT=32,Z_NO_FLUSH=0,Z_PARTIAL_FLUSH=1,Z_SYNC_FLUSH=2,Z_FULL_FLUSH=3,Z_FINISH=4,Z_DEFLATED=8,Z_OK=0,Z_STREAM_END=1,Z_NEED_DICT=2,Z_ERRNO=-1,Z_STREAM_ERROR=-2,Z_DATA_ERROR=-3,Z_MEM_ERROR=-4,Z_BUF_ERROR=-5,Z_VERSION_ERROR=-6,METHOD=0,FLAG=1,DICT4=2,DICT3=3,DICT2=4,DICT1=5,DICT0=6,BLOCKS=7,CHECK4=8,CHECK3=9,CHECK2=10,CHECK1=11,DONE=12,BAD=13,inflate_mask=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],
IB_TYPE=0,IB_LENS=1,IB_STORED=2,IB_TABLE=3,IB_BTREE=4,IB_DTREE=5,IB_CODES=6,IB_DRY=7,IB_DONE=8,IB_BAD=9,fixed_bl=9,fixed_bd=5,fixed_tl=[96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,192,80,7,10,0,8,96,0,8,32,0,9,160,0,8,0,0,8,128,0,8,64,0,9,224,80,7,6,0,8,88,0,8,24,0,9,144,83,7,59,0,8,120,0,8,56,0,9,208,81,7,17,0,8,104,0,8,40,0,9,176,0,8,8,0,8,136,0,8,72,0,9,240,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,200,81,7,13,0,8,100,0,8,36,0,9,168,0,8,4,0,8,132,0,8,68,0,9,232,80,
7,8,0,8,92,0,8,28,0,9,152,84,7,83,0,8,124,0,8,60,0,9,216,82,7,23,0,8,108,0,8,44,0,9,184,0,8,12,0,8,140,0,8,76,0,9,248,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,196,81,7,11,0,8,98,0,8,34,0,9,164,0,8,2,0,8,130,0,8,66,0,9,228,80,7,7,0,8,90,0,8,26,0,9,148,84,7,67,0,8,122,0,8,58,0,9,212,82,7,19,0,8,106,0,8,42,0,9,180,0,8,10,0,8,138,0,8,74,0,9,244,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,204,81,7,15,0,8,102,0,8,38,0,9,172,0,8,6,0,8,134,0,8,70,0,9,236,80,7,9,0,8,94,0,8,30,0,
9,156,84,7,99,0,8,126,0,8,62,0,9,220,82,7,27,0,8,110,0,8,46,0,9,188,0,8,14,0,8,142,0,8,78,0,9,252,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,194,80,7,10,0,8,97,0,8,33,0,9,162,0,8,1,0,8,129,0,8,65,0,9,226,80,7,6,0,8,89,0,8,25,0,9,146,83,7,59,0,8,121,0,8,57,0,9,210,81,7,17,0,8,105,0,8,41,0,9,178,0,8,9,0,8,137,0,8,73,0,9,242,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,202,81,7,13,0,8,101,0,8,37,0,9,170,0,8,5,0,8,133,0,8,69,0,9,234,80,7,8,0,8,93,0,8,29,0,9,154,84,7,83,0,8,
125,0,8,61,0,9,218,82,7,23,0,8,109,0,8,45,0,9,186,0,8,13,0,8,141,0,8,77,0,9,250,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,198,81,7,11,0,8,99,0,8,35,0,9,166,0,8,3,0,8,131,0,8,67,0,9,230,80,7,7,0,8,91,0,8,27,0,9,150,84,7,67,0,8,123,0,8,59,0,9,214,82,7,19,0,8,107,0,8,43,0,9,182,0,8,11,0,8,139,0,8,75,0,9,246,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,206,81,7,15,0,8,103,0,8,39,0,9,174,0,8,7,0,8,135,0,8,71,0,9,238,80,7,9,0,8,95,0,8,31,0,9,158,84,7,99,0,8,127,0,8,63,0,9,222,
82,7,27,0,8,111,0,8,47,0,9,190,0,8,15,0,8,143,0,8,79,0,9,254,96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,193,80,7,10,0,8,96,0,8,32,0,9,161,0,8,0,0,8,128,0,8,64,0,9,225,80,7,6,0,8,88,0,8,24,0,9,145,83,7,59,0,8,120,0,8,56,0,9,209,81,7,17,0,8,104,0,8,40,0,9,177,0,8,8,0,8,136,0,8,72,0,9,241,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,201,81,7,13,0,8,100,0,8,36,0,9,169,0,8,4,0,8,132,0,8,68,0,9,233,80,7,8,0,8,92,0,8,28,0,9,153,84,7,83,0,8,124,0,8,60,0,9,217,82,7,23,0,8,108,0,
8,44,0,9,185,0,8,12,0,8,140,0,8,76,0,9,249,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,197,81,7,11,0,8,98,0,8,34,0,9,165,0,8,2,0,8,130,0,8,66,0,9,229,80,7,7,0,8,90,0,8,26,0,9,149,84,7,67,0,8,122,0,8,58,0,9,213,82,7,19,0,8,106,0,8,42,0,9,181,0,8,10,0,8,138,0,8,74,0,9,245,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,205,81,7,15,0,8,102,0,8,38,0,9,173,0,8,6,0,8,134,0,8,70,0,9,237,80,7,9,0,8,94,0,8,30,0,9,157,84,7,99,0,8,126,0,8,62,0,9,221,82,7,27,0,8,110,0,8,46,0,9,189,0,8,14,
0,8,142,0,8,78,0,9,253,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,195,80,7,10,0,8,97,0,8,33,0,9,163,0,8,1,0,8,129,0,8,65,0,9,227,80,7,6,0,8,89,0,8,25,0,9,147,83,7,59,0,8,121,0,8,57,0,9,211,81,7,17,0,8,105,0,8,41,0,9,179,0,8,9,0,8,137,0,8,73,0,9,243,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,203,81,7,13,0,8,101,0,8,37,0,9,171,0,8,5,0,8,133,0,8,69,0,9,235,80,7,8,0,8,93,0,8,29,0,9,155,84,7,83,0,8,125,0,8,61,0,9,219,82,7,23,0,8,109,0,8,45,0,9,187,0,8,13,0,8,141,0,8,77,0,
9,251,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,199,81,7,11,0,8,99,0,8,35,0,9,167,0,8,3,0,8,131,0,8,67,0,9,231,80,7,7,0,8,91,0,8,27,0,9,151,84,7,67,0,8,123,0,8,59,0,9,215,82,7,19,0,8,107,0,8,43,0,9,183,0,8,11,0,8,139,0,8,75,0,9,247,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,207,81,7,15,0,8,103,0,8,39,0,9,175,0,8,7,0,8,135,0,8,71,0,9,239,80,7,9,0,8,95,0,8,31,0,9,159,84,7,99,0,8,127,0,8,63,0,9,223,82,7,27,0,8,111,0,8,47,0,9,191,0,8,15,0,8,143,0,8,79,0,9,255],fixed_td=[80,
5,1,87,5,257,83,5,17,91,5,4097,81,5,5,89,5,1025,85,5,65,93,5,16385,80,5,3,88,5,513,84,5,33,92,5,8193,82,5,9,90,5,2049,86,5,129,192,5,24577,80,5,2,87,5,385,83,5,25,91,5,6145,81,5,7,89,5,1537,85,5,97,93,5,24577,80,5,4,88,5,769,84,5,49,92,5,12289,82,5,13,90,5,3073,86,5,193,192,5,24577],cplens=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],cplext=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,112,112],cpdist=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,
129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],cpdext=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];function ZStream(){}ZStream.prototype.inflateInit=function(a,b){a||(a=DEF_WBITS);b&&(b=!1);this.istate=new Inflate;return this.istate.inflateInit(this,b?-a:a)};ZStream.prototype.inflate=function(a){return null==this.istate?Z_STREAM_ERROR:this.istate.inflate(this,a)};
ZStream.prototype.inflateEnd=function(){if(null==this.istate)return Z_STREAM_ERROR;var a=istate.inflateEnd(this);this.istate=null;return a};ZStream.prototype.inflateSync=function(){return istate.inflateSync(this)};ZStream.prototype.inflateSetDictionary=function(a,b){return istate.inflateSetDictionary(this,a,b)};function Inflate(){this.was=[0]}
Inflate.prototype.inflateReset=function(a){if(null==a||null==a.istate)return Z_STREAM_ERROR;a.total_in=a.total_out=0;a.msg=null;a.istate.mode=0!=a.istate.nowrap?BLOCKS:METHOD;a.istate.blocks.reset(a,null);return Z_OK};Inflate.prototype.inflateEnd=function(a){null!=this.blocks&&this.blocks.free(a);this.blocks=null;return Z_OK};
Inflate.prototype.inflateInit=function(a,b){this.blocks=a.msg=null;nowrap=0;0>b&&(b=-b,nowrap=1);if(8>b||15<b)return this.inflateEnd(a),Z_STREAM_ERROR;this.wbits=b;a.istate.blocks=new InfBlocks(a,0!=a.istate.nowrap?null:this,1<<b);this.inflateReset(a);return Z_OK};
Inflate.prototype.inflate=function(a,b){var c,d;if(null==a||null==a.istate||null==a.next_in)return Z_STREAM_ERROR;b=b==Z_FINISH?Z_BUF_ERROR:Z_OK;for(c=Z_BUF_ERROR;;)switch(a.istate.mode){case METHOD:if(0==a.avail_in)return c;c=b;a.avail_in--;a.total_in++;if(((a.istate.method=a.next_in[a.next_in_index++])&15)!=Z_DEFLATED){a.istate.mode=BAD;a.msg="unknown compression method";a.istate.marker=5;break}if((a.istate.method>>4)+8>a.istate.wbits){a.istate.mode=BAD;a.msg="invalid window size";a.istate.marker=
5;break}a.istate.mode=FLAG;case FLAG:if(0==a.avail_in)return c;c=b;a.avail_in--;a.total_in++;d=a.next_in[a.next_in_index++]&255;if(0!=((a.istate.method<<8)+d)%31){a.istate.mode=BAD;a.msg="incorrect header check";a.istate.marker=5;break}if(0==(d&PRESET_DICT)){a.istate.mode=BLOCKS;break}a.istate.mode=DICT4;case DICT4:if(0==a.avail_in)return c;c=b;a.avail_in--;a.total_in++;a.istate.need=(a.next_in[a.next_in_index++]&255)<<24&4278190080;a.istate.mode=DICT3;case DICT3:if(0==a.avail_in)return c;c=b;a.avail_in--;
a.total_in++;a.istate.need+=(a.next_in[a.next_in_index++]&255)<<16&16711680;a.istate.mode=DICT2;case DICT2:if(0==a.avail_in)return c;c=b;a.avail_in--;a.total_in++;a.istate.need+=(a.next_in[a.next_in_index++]&255)<<8&65280;a.istate.mode=DICT1;case DICT1:if(0==a.avail_in)return c;a.avail_in--;a.total_in++;a.istate.need+=a.next_in[a.next_in_index++]&255;a.adler=a.istate.need;a.istate.mode=DICT0;return Z_NEED_DICT;case DICT0:return a.istate.mode=BAD,a.msg="need dictionary",a.istate.marker=0,Z_STREAM_ERROR;
case BLOCKS:c=a.istate.blocks.proc(a,c);if(c==Z_DATA_ERROR){a.istate.mode=BAD;a.istate.marker=0;break}c==Z_OK&&(c=b);if(c!=Z_STREAM_END)return c;c=b;a.istate.blocks.reset(a,a.istate.was);if(0!=a.istate.nowrap){a.istate.mode=DONE;break}a.istate.mode=CHECK4;case CHECK4:if(0==a.avail_in)return c;c=b;a.avail_in--;a.total_in++;a.istate.need=(a.next_in[a.next_in_index++]&255)<<24&4278190080;a.istate.mode=CHECK3;case CHECK3:if(0==a.avail_in)return c;c=b;a.avail_in--;a.total_in++;a.istate.need+=(a.next_in[a.next_in_index++]&
255)<<16&16711680;a.istate.mode=CHECK2;case CHECK2:if(0==a.avail_in)return c;c=b;a.avail_in--;a.total_in++;a.istate.need+=(a.next_in[a.next_in_index++]&255)<<8&65280;a.istate.mode=CHECK1;case CHECK1:if(0==a.avail_in)return c;c=b;a.avail_in--;a.total_in++;a.istate.need+=a.next_in[a.next_in_index++]&255;if(a.istate.was[0]!=a.istate.need){a.istate.mode=BAD;a.msg="incorrect data check";a.istate.marker=5;break}a.istate.mode=DONE;case DONE:return Z_STREAM_END;case BAD:return Z_DATA_ERROR;default:return Z_STREAM_ERROR}};
Inflate.prototype.inflateSetDictionary=function(a,b,c){var d=0,e=c;if(null==a||null==a.istate||a.istate.mode!=DICT0)return Z_STREAM_ERROR;if(a._adler.adler32(1,b,0,c)!=a.adler)return Z_DATA_ERROR;a.adler=a._adler.adler32(0,null,0,0);e>=1<<a.istate.wbits&&(e=(1<<a.istate.wbits)-1,d=c-e);a.istate.blocks.set_dictionary(b,d,e);a.istate.mode=BLOCKS;return Z_OK};var mark=[0,0,255,255];
Inflate.prototype.inflateSync=function(a){var b,c,d;if(null==a||null==a.istate)return Z_STREAM_ERROR;a.istate.mode!=BAD&&(a.istate.mode=BAD,a.istate.marker=0);if(0==(b=a.avail_in))return Z_BUF_ERROR;c=a.next_in_index;for(d=a.istate.marker;0!=b&&4>d;)a.next_in[c]==mark[d]?d++:d=0!=a.next_in[c]?0:4-d,c++,b--;a.total_in+=c-a.next_in_index;a.next_in_index=c;a.avail_in=b;a.istate.marker=d;if(4!=d)return Z_DATA_ERROR;b=a.total_in;c=a.total_out;this.inflateReset(a);a.total_in=b;a.total_out=c;a.istate.mode=
BLOCKS;return Z_OK};Inflate.prototype.inflateSyncPoint=function(a){return null==a||null==a.istate||null==a.istate.blocks?Z_STREAM_ERROR:a.istate.blocks.sync_point()};var INFBLOCKS_BORDER=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];
function InfBlocks(a,b,c){this.hufts=new Int32Array(3*MANY);this.window=new Uint8Array(c);this.end=c;this.checkfn=b;this.mode=IB_TYPE;this.reset(a,null);this.index=this.table=this.left=0;this.blens=null;this.bb=new Int32Array(1);this.tb=new Int32Array(1);this.codes=new InfCodes;this.check=this.write=this.read=this.bitb=this.bitk=this.last=0;this.inftree=new InfTree}
InfBlocks.prototype.reset=function(a,b){b&&(b[0]=this.check);this.mode==IB_CODES&&this.codes.free(a);this.mode=IB_TYPE;this.read=this.write=this.bitb=this.bitk=0;this.checkfn&&(a.adler=this.check=a._adler.adler32(0,null,0,0))};
InfBlocks.prototype.proc=function(a,b){var c,d,e,f,h,g,m;f=a.next_in_index;h=a.avail_in;d=this.bitb;e=this.bitk;g=this.write;for(m=g<this.read?this.read-g-1:this.end-g;;)switch(this.mode){case IB_TYPE:for(;3>e;){if(0!=h)b=Z_OK;else return this.bitb=d,this.bitk=e,a.avail_in=h,a.total_in+=f-a.next_in_index,a.next_in_index=f,this.write=g,this.inflate_flush(a,b);h--;d|=(a.next_in[f++]&255)<<e;e+=8}c=d&7;this.last=c&1;switch(c>>>1){case 0:d>>>=3;e-=3;c=e&7;d>>>=c;e-=c;this.mode=IB_LENS;break;case 1:var p=
new Int32Array(1),v=new Int32Array(1),u=[],q=[];inflate_trees_fixed(p,v,u,q,a);this.codes.init(p[0],v[0],u[0],0,q[0],0,a);d>>>=3;e-=3;this.mode=IB_CODES;break;case 2:d>>>=3;e-=3;this.mode=IB_TABLE;break;case 3:return d>>>=3,e-=3,this.mode=BAD,a.msg="invalid block type",b=Z_DATA_ERROR,this.bitb=d,this.bitk=e,a.avail_in=h,a.total_in+=f-a.next_in_index,a.next_in_index=f,this.write=g,this.inflate_flush(a,b)}break;case IB_LENS:for(;32>e;){if(0!=h)b=Z_OK;else return this.bitb=d,this.bitk=e,a.avail_in=h,
a.total_in+=f-a.next_in_index,a.next_in_index=f,this.write=g,this.inflate_flush(a,b);h--;d|=(a.next_in[f++]&255)<<e;e+=8}if((~d>>>16&65535)!=(d&65535))return this.mode=BAD,a.msg="invalid stored block lengths",b=Z_DATA_ERROR,this.bitb=d,this.bitk=e,a.avail_in=h,a.total_in+=f-a.next_in_index,a.next_in_index=f,this.write=g,this.inflate_flush(a,b);this.left=d&65535;d=e=0;this.mode=0!=left?IB_STORED:0!=this.last?IB_DRY:IB_TYPE;break;case IB_STORED:if(0==h)return this.bitb=d,this.bitk=e,a.avail_in=h,a.total_in+=
f-a.next_in_index,a.next_in_index=f,write=g,this.inflate_flush(a,b);if(0==m&&(g==end&&0!=read&&(g=0,m=g<this.read?this.read-g-1:this.end-g),0==m&&(this.write=g,b=this.inflate_flush(a,b),g=this.write,m=g<this.read?this.read-g-1:this.end-g,g==this.end&&0!=this.read&&(g=0,m=g<this.read?this.read-g-1:this.end-g),0==m)))return this.bitb=d,this.bitk=e,a.avail_in=h,a.total_in+=f-a.next_in_index,a.next_in_index=f,this.write=g,this.inflate_flush(a,b);b=Z_OK;c=this.left;c>h&&(c=h);c>m&&(c=m);arrayCopy(a.next_in,
f,window,g,c);f+=c;h-=c;g+=c;m-=c;if(0!=(this.left-=c))break;this.mode=0!=this.last?IB_DRY:IB_TYPE;break;case IB_TABLE:for(;14>e;){if(0!=h)b=Z_OK;else return this.bitb=d,this.bitk=e,a.avail_in=h,a.total_in+=f-a.next_in_index,a.next_in_index=f,this.write=g,this.inflate_flush(a,b);h--;d|=(a.next_in[f++]&255)<<e;e+=8}this.table=c=d&16383;if(29<(c&31)||29<(c>>5&31))return this.mode=IB_BAD,a.msg="too many length or distance symbols",b=Z_DATA_ERROR,this.bitb=d,this.bitk=e,a.avail_in=h,a.total_in+=f-a.next_in_index,
a.next_in_index=f,this.write=g,this.inflate_flush(a,b);c=258+(c&31)+(c>>5&31);if(null==this.blens||this.blens.length<c)this.blens=new Int32Array(c);else for(m=0;m<c;m++)this.blens[m]=0;d>>>=14;e-=14;this.index=0;mode=IB_BTREE;case IB_BTREE:for(;this.index<4+(this.table>>>10);){for(;3>e;){if(0!=h)b=Z_OK;else return this.bitb=d,this.bitk=e,a.avail_in=h,a.total_in+=f-a.next_in_index,a.next_in_index=f,this.write=g,this.inflate_flush(a,b);h--;d|=(a.next_in[f++]&255)<<e;e+=8}this.blens[INFBLOCKS_BORDER[this.index++]]=
d&7;d>>>=3;e-=3}for(;19>this.index;)this.blens[INFBLOCKS_BORDER[this.index++]]=0;this.bb[0]=7;c=this.inftree.inflate_trees_bits(this.blens,this.bb,this.tb,this.hufts,a);if(c!=Z_OK)return b=c,b==Z_DATA_ERROR&&(this.blens=null,this.mode=IB_BAD),this.bitb=d,this.bitk=e,a.avail_in=h,a.total_in+=f-a.next_in_index,a.next_in_index=f,write=g,this.inflate_flush(a,b);this.index=0;this.mode=IB_DTREE;case IB_DTREE:for(;;){c=this.table;if(!(this.index<258+(c&31)+(c>>5&31)))break;for(c=this.bb[0];e<c;){if(0!=h)b=
Z_OK;else return this.bitb=d,this.bitk=e,a.avail_in=h,a.total_in+=f-a.next_in_index,a.next_in_index=f,this.write=g,this.inflate_flush(a,b);h--;d|=(a.next_in[f++]&255)<<e;e+=8}c=this.hufts[3*(this.tb[0]+(d&inflate_mask[c]))+1];v=this.hufts[3*(this.tb[0]+(d&inflate_mask[c]))+2];if(16>v)d>>>=c,e-=c,this.blens[this.index++]=v;else{m=18==v?7:v-14;for(p=18==v?11:3;e<c+m;){if(0!=h)b=Z_OK;else return this.bitb=d,this.bitk=e,a.avail_in=h,a.total_in+=f-a.next_in_index,a.next_in_index=f,this.write=g,this.inflate_flush(a,
b);h--;d|=(a.next_in[f++]&255)<<e;e+=8}d>>>=c;e-=c;p+=d&inflate_mask[m];d>>>=m;e-=m;m=this.index;c=this.table;if(m+p>258+(c&31)+(c>>5&31)||16==v&&1>m)return this.blens=null,this.mode=IB_BAD,a.msg="invalid bit length repeat",b=Z_DATA_ERROR,this.bitb=d,this.bitk=e,a.avail_in=h,a.total_in+=f-a.next_in_index,a.next_in_index=f,this.write=g,this.inflate_flush(a,b);v=16==v?this.blens[m-1]:0;do this.blens[m++]=v;while(0!=--p);this.index=m}}this.tb[0]=-1;p=new Int32Array(1);v=new Int32Array(1);u=new Int32Array(1);
q=new Int32Array(1);p[0]=9;v[0]=6;c=this.table;c=this.inftree.inflate_trees_dynamic(257+(c&31),1+(c>>5&31),this.blens,p,v,u,q,this.hufts,a);if(c!=Z_OK)return c==Z_DATA_ERROR&&(this.blens=null,this.mode=BAD),b=c,this.bitb=d,this.bitk=e,a.avail_in=h,a.total_in+=f-a.next_in_index,a.next_in_index=f,this.write=g,this.inflate_flush(a,b);this.codes.init(p[0],v[0],this.hufts,u[0],this.hufts,q[0],a);this.mode=IB_CODES;case IB_CODES:this.bitb=d;this.bitk=e;a.avail_in=h;a.total_in+=f-a.next_in_index;a.next_in_index=
f;this.write=g;if((b=this.codes.proc(this,a,b))!=Z_STREAM_END)return this.inflate_flush(a,b);b=Z_OK;this.codes.free(a);f=a.next_in_index;h=a.avail_in;d=this.bitb;e=this.bitk;g=this.write;m=g<this.read?this.read-g-1:this.end-g;if(0==this.last){this.mode=IB_TYPE;break}this.mode=IB_DRY;case IB_DRY:this.write=g;b=this.inflate_flush(a,b);g=this.write;if(this.read!=this.write)return this.bitb=d,this.bitk=e,a.avail_in=h,a.total_in+=f-a.next_in_index,a.next_in_index=f,this.write=g,this.inflate_flush(a,b);
mode=DONE;case IB_DONE:return b=Z_STREAM_END,this.bitb=d,this.bitk=e,a.avail_in=h,a.total_in+=f-a.next_in_index,a.next_in_index=f,this.write=g,this.inflate_flush(a,b);case IB_BAD:return b=Z_DATA_ERROR,this.bitb=d,this.bitk=e,a.avail_in=h,a.total_in+=f-a.next_in_index,a.next_in_index=f,this.write=g,this.inflate_flush(a,b);default:return b=Z_STREAM_ERROR,this.bitb=d,this.bitk=e,a.avail_in=h,a.total_in+=f-a.next_in_index,a.next_in_index=f,this.write=g,this.inflate_flush(a,b)}};
InfBlocks.prototype.free=function(a){this.reset(a,null);this.hufts=this.window=null};InfBlocks.prototype.set_dictionary=function(a,b,c){arrayCopy(a,b,window,0,c);this.read=this.write=c};InfBlocks.prototype.sync_point=function(){return this.mode==IB_LENS};
InfBlocks.prototype.inflate_flush=function(a,b){var c,d,e;d=a.next_out_index;e=this.read;c=(e<=this.write?this.write:this.end)-e;c>a.avail_out&&(c=a.avail_out);0!=c&&b==Z_BUF_ERROR&&(b=Z_OK);a.avail_out-=c;a.total_out+=c;null!=this.checkfn&&(a.adler=this.check=a._adler.adler32(this.check,this.window,e,c));arrayCopy(this.window,e,a.next_out,d,c);d+=c;e+=c;e==this.end&&(e=0,this.write==this.end&&(this.write=0),c=this.write-e,c>a.avail_out&&(c=a.avail_out),0!=c&&b==Z_BUF_ERROR&&(b=Z_OK),a.avail_out-=
c,a.total_out+=c,null!=this.checkfn&&(a.adler=this.check=a._adler.adler32(this.check,this.window,e,c)),arrayCopy(this.window,e,a.next_out,d,c),d+=c,e+=c);a.next_out_index=d;this.read=e;return b};var IC_START=0,IC_LEN=1,IC_LENEXT=2,IC_DIST=3,IC_DISTEXT=4,IC_COPY=5,IC_LIT=6,IC_WASH=7,IC_END=8,IC_BADCODE=9;function InfCodes(){}InfCodes.prototype.init=function(a,b,c,d,e,f,h){this.mode=IC_START;this.lbits=a;this.dbits=b;this.ltree=c;this.ltree_index=d;this.dtree=e;this.dtree_index=f;this.tree=null};
InfCodes.prototype.proc=function(a,b,c){var d,e,f=0,h=0,g=0,m,p,v,g=b.next_in_index;m=b.avail_in;f=a.bitb;h=a.bitk;p=a.write;for(v=p<a.read?a.read-p-1:a.end-p;;)switch(this.mode){case IC_START:if(258<=v&&10<=m&&(a.bitb=f,a.bitk=h,b.avail_in=m,b.total_in+=g-b.next_in_index,b.next_in_index=g,a.write=p,c=this.inflate_fast(this.lbits,this.dbits,this.ltree,this.ltree_index,this.dtree,this.dtree_index,a,b),g=b.next_in_index,m=b.avail_in,f=a.bitb,h=a.bitk,p=a.write,v=p<a.read?a.read-p-1:a.end-p,c!=Z_OK)){this.mode=
c==Z_STREAM_END?IC_WASH:IC_BADCODE;break}this.need=this.lbits;this.tree=this.ltree;this.tree_index=this.ltree_index;this.mode=IC_LEN;case IC_LEN:for(d=this.need;h<d;){if(0!=m)c=Z_OK;else return a.bitb=f,a.bitk=h,b.avail_in=m,b.total_in+=g-b.next_in_index,b.next_in_index=g,a.write=p,a.inflate_flush(b,c);m--;f|=(b.next_in[g++]&255)<<h;h+=8}d=3*(this.tree_index+(f&inflate_mask[d]));f>>>=this.tree[d+1];h-=this.tree[d+1];e=this.tree[d];if(0==e){this.lit=this.tree[d+2];this.mode=IC_LIT;break}if(0!=(e&16)){this.get=
e&15;this.len=this.tree[d+2];this.mode=IC_LENEXT;break}if(0==(e&64)){this.need=e;this.tree_index=d/3+this.tree[d+2];break}if(0!=(e&32)){this.mode=IC_WASH;break}this.mode=IC_BADCODE;b.msg="invalid literal/length code";c=Z_DATA_ERROR;a.bitb=f;a.bitk=h;b.avail_in=m;b.total_in+=g-b.next_in_index;b.next_in_index=g;a.write=p;return a.inflate_flush(b,c);case IC_LENEXT:for(d=this.get;h<d;){if(0!=m)c=Z_OK;else return a.bitb=f,a.bitk=h,b.avail_in=m,b.total_in+=g-b.next_in_index,b.next_in_index=g,a.write=p,
a.inflate_flush(b,c);m--;f|=(b.next_in[g++]&255)<<h;h+=8}this.len+=f&inflate_mask[d];f>>=d;h-=d;this.need=this.dbits;this.tree=this.dtree;this.tree_index=this.dtree_index;this.mode=IC_DIST;case IC_DIST:for(d=this.need;h<d;){if(0!=m)c=Z_OK;else return a.bitb=f,a.bitk=h,b.avail_in=m,b.total_in+=g-b.next_in_index,b.next_in_index=g,a.write=p,a.inflate_flush(b,c);m--;f|=(b.next_in[g++]&255)<<h;h+=8}d=3*(this.tree_index+(f&inflate_mask[d]));f>>=this.tree[d+1];h-=this.tree[d+1];e=this.tree[d];if(0!=(e&16)){this.get=
e&15;this.dist=this.tree[d+2];this.mode=IC_DISTEXT;break}if(0==(e&64)){this.need=e;this.tree_index=d/3+this.tree[d+2];break}this.mode=IC_BADCODE;b.msg="invalid distance code";c=Z_DATA_ERROR;a.bitb=f;a.bitk=h;b.avail_in=m;b.total_in+=g-b.next_in_index;b.next_in_index=g;a.write=p;return a.inflate_flush(b,c);case IC_DISTEXT:for(d=this.get;h<d;){if(0!=m)c=Z_OK;else return a.bitb=f,a.bitk=h,b.avail_in=m,b.total_in+=g-b.next_in_index,b.next_in_index=g,a.write=p,a.inflate_flush(b,c);m--;f|=(b.next_in[g++]&
255)<<h;h+=8}this.dist+=f&inflate_mask[d];f>>=d;h-=d;this.mode=IC_COPY;case IC_COPY:for(d=p-this.dist;0>d;)d+=a.end;for(;0!=this.len;){if(0==v&&(p==a.end&&0!=a.read&&(p=0,v=p<a.read?a.read-p-1:a.end-p),0==v&&(a.write=p,c=a.inflate_flush(b,c),p=a.write,v=p<a.read?a.read-p-1:a.end-p,p==a.end&&0!=a.read&&(p=0,v=p<a.read?a.read-p-1:a.end-p),0==v)))return a.bitb=f,a.bitk=h,b.avail_in=m,b.total_in+=g-b.next_in_index,b.next_in_index=g,a.write=p,a.inflate_flush(b,c);a.window[p++]=a.window[d++];v--;d==a.end&&
(d=0);this.len--}this.mode=IC_START;break;case IC_LIT:if(0==v&&(p==a.end&&0!=a.read&&(p=0,v=p<a.read?a.read-p-1:a.end-p),0==v&&(a.write=p,c=a.inflate_flush(b,c),p=a.write,v=p<a.read?a.read-p-1:a.end-p,p==a.end&&0!=a.read&&(p=0,v=p<a.read?a.read-p-1:a.end-p),0==v)))return a.bitb=f,a.bitk=h,b.avail_in=m,b.total_in+=g-b.next_in_index,b.next_in_index=g,a.write=p,a.inflate_flush(b,c);c=Z_OK;a.window[p++]=this.lit;v--;this.mode=IC_START;break;case IC_WASH:7<h&&(h-=8,m++,g--);a.write=p;c=a.inflate_flush(b,
c);p=a.write;if(a.read!=a.write)return a.bitb=f,a.bitk=h,b.avail_in=m,b.total_in+=g-b.next_in_index,b.next_in_index=g,a.write=p,a.inflate_flush(b,c);this.mode=IC_END;case IC_END:return c=Z_STREAM_END,a.bitb=f,a.bitk=h,b.avail_in=m,b.total_in+=g-b.next_in_index,b.next_in_index=g,a.write=p,a.inflate_flush(b,c);case IC_BADCODE:return c=Z_DATA_ERROR,a.bitb=f,a.bitk=h,b.avail_in=m,b.total_in+=g-b.next_in_index,b.next_in_index=g,a.write=p,a.inflate_flush(b,c);default:return c=Z_STREAM_ERROR,a.bitb=f,a.bitk=
h,b.avail_in=m,b.total_in+=g-b.next_in_index,b.next_in_index=g,a.write=p,a.inflate_flush(b,c)}};InfCodes.prototype.free=function(a){};
InfCodes.prototype.inflate_fast=function(a,b,c,d,e,f,h,g){var m,p,v,u,q,r,t,y,x,w,s,z;r=g.next_in_index;t=g.avail_in;u=h.bitb;q=h.bitk;y=h.write;x=y<h.read?h.read-y-1:h.end-y;a=inflate_mask[a];w=inflate_mask[b];do{for(;20>q;)t--,u|=(g.next_in[r++]&255)<<q,q+=8;m=u&a;p=c;v=d;z=3*(v+m);if(0==(b=p[z]))u>>=p[z+1],q-=p[z+1],h.window[y++]=p[z+2],x--;else{do{u>>=p[z+1];q-=p[z+1];if(0!=(b&16)){b&=15;s=p[z+2]+(u&inflate_mask[b]);u>>=b;for(q-=b;15>q;)t--,u|=(g.next_in[r++]&255)<<q,q+=8;m=u&w;p=e;v=f;z=3*(v+
m);b=p[z];do if(u>>=p[z+1],q-=p[z+1],0!=(b&16)){for(b&=15;q<b;)t--,u|=(g.next_in[r++]&255)<<q,q+=8;m=p[z+2]+(u&inflate_mask[b]);u>>=b;q-=b;x-=s;if(y>=m)m=y-m,h.window[y++]=h.window[m++],h.window[y++]=h.window[m++],s-=2;else{m=y-m;do m+=h.end;while(0>m);b=h.end-m;if(s>b){s-=b;if(0<y-m&&b>y-m){do h.window[y++]=h.window[m++];while(0!=--b)}else arrayCopy(h.window,m,h.window,y,b),y+=b;m=0}}do h.window[y++]=h.window[m++];while(0!=--s);break}else if(0==(b&64))m+=p[z+2],m+=u&inflate_mask[b],z=3*(v+m),b=p[z];
else return g.msg="invalid distance code",s=g.avail_in-t,s=q>>3<s?q>>3:s,t+=s,r-=s,q-=s<<3,h.bitb=u,h.bitk=q,g.avail_in=t,g.total_in+=r-g.next_in_index,g.next_in_index=r,h.write=y,Z_DATA_ERROR;while(1);break}if(0==(b&64)){if(m+=p[z+2],m+=u&inflate_mask[b],z=3*(v+m),0==(b=p[z])){u>>=p[z+1];q-=p[z+1];h.window[y++]=p[z+2];x--;break}}else{if(0!=(b&32))return s=g.avail_in-t,s=q>>3<s?q>>3:s,t+=s,r-=s,q-=s<<3,h.bitb=u,h.bitk=q,g.avail_in=t,g.total_in+=r-g.next_in_index,g.next_in_index=r,h.write=y,Z_STREAM_END;
g.msg="invalid literal/length code";s=g.avail_in-t;s=q>>3<s?q>>3:s;t+=s;r-=s;q-=s<<3;h.bitb=u;h.bitk=q;g.avail_in=t;g.total_in+=r-g.next_in_index;g.next_in_index=r;h.write=y;return Z_DATA_ERROR}}while(1)}}while(258<=x&&10<=t);s=g.avail_in-t;s=q>>3<s?q>>3:s;r-=s;h.bitb=u;h.bitk=q-(s<<3);g.avail_in=t+s;g.total_in+=r-g.next_in_index;g.next_in_index=r;h.write=y;return Z_OK};function InfTree(){}
InfTree.prototype.huft_build=function(a,b,c,d,e,f,h,g,m,p,v){var u,q,r,t,y,x,w,s,z;x=0;q=c;do this.c[a[b+x]]++,x++,q--;while(0!=q);if(this.c[0]==c)return h[0]=-1,g[0]=0,Z_OK;y=g[0];for(r=1;r<=BMAX&&0==this.c[r];r++);t=r;y<r&&(y=r);for(q=BMAX;0!=q&&0==this.c[q];q--);p=q;y>q&&(y=q);g[0]=y;for(g=1<<r;r<q;r++,g<<=1)if(0>(g-=this.c[r]))return Z_DATA_ERROR;if(0>(g-=this.c[q]))return Z_DATA_ERROR;this.c[q]+=g;this.x[1]=r=0;x=1;for(w=2;0!=--q;)this.x[w]=r+=this.c[x],w++,x++;x=q=0;do{if(0!=(r=a[b+x]))this.v[this.x[r]++]=
q;x++}while(++q<c);c=this.x[p];x=this.x[0]=q=0;b=-1;s=-y;for(z=w=this.u[0]=0;t<=p;t++)for(a=this.c[t];0!=a--;){for(;t>s+y;){b++;s+=y;z=p-s;z=z>y?y:z;if((u=1<<(r=t-s))>a+1)if(u-=a+1,w=t,r<z)for(;++r<z&&!((u<<=1)<=this.c[++w]);)u-=this.c[w];z=1<<r;if(this.hn[0]+z>MANY)return Z_DATA_ERROR;this.u[b]=w=this.hn[0];this.hn[0]+=z;0!=b?(this.x[b]=q,this.r[0]=r,this.r[1]=y,r=q>>>s-y,this.r[2]=w-this.u[b-1]-r,arrayCopy(this.r,0,m,3*(this.u[b-1]+r),3)):h[0]=w}this.r[1]=t-s;x>=c?this.r[0]=192:v[x]<d?(this.r[0]=
256>this.v[x]?0:96,this.r[2]=this.v[x++]):(this.r[0]=f[this.v[x]-d]+16+64,this.r[2]=e[this.v[x++]-d]);u=1<<t-s;for(r=q>>>s;r<z;r+=u)arrayCopy(this.r,0,m,3*(w+r),3);for(r=1<<t-1;0!=(q&r);r>>>=1)q^=r;q^=r;for(r=(1<<s)-1;(q&r)!=this.x[b];)b--,s-=y,r=(1<<s)-1}return 0!=g&&1!=p?Z_BUF_ERROR:Z_OK};
InfTree.prototype.inflate_trees_bits=function(a,b,c,d,e){this.initWorkArea(19);this.hn[0]=0;a=this.huft_build(a,0,19,19,null,null,c,b,d,this.hn,this.v);if(a==Z_DATA_ERROR)e.msg="oversubscribed dynamic bit lengths tree";else if(a==Z_BUF_ERROR||0==b[0])e.msg="incomplete dynamic bit lengths tree",a=Z_DATA_ERROR;return a};
InfTree.prototype.inflate_trees_dynamic=function(a,b,c,d,e,f,h,g,m){this.initWorkArea(288);this.hn[0]=0;f=this.huft_build(c,0,a,257,cplens,cplext,f,d,g,this.hn,this.v);if(f!=Z_OK||0==d[0])return f==Z_DATA_ERROR?m.msg="oversubscribed literal/length tree":f!=Z_MEM_ERROR&&(m.msg="incomplete literal/length tree",f=Z_DATA_ERROR),f;this.initWorkArea(288);f=this.huft_build(c,a,b,0,cpdist,cpdext,h,e,g,this.hn,this.v);return f!=Z_OK||0==e[0]&&257<a?(f==Z_DATA_ERROR?m.msg="oversubscribed distance tree":f==
Z_BUF_ERROR?(m.msg="incomplete distance tree",f=Z_DATA_ERROR):f!=Z_MEM_ERROR&&(m.msg="empty distance tree with lengths",f=Z_DATA_ERROR),f):Z_OK};function inflate_trees_fixed(a,b,c,d,e){a[0]=fixed_bl;b[0]=fixed_bd;c[0]=fixed_tl;d[0]=fixed_td;return Z_OK}
InfTree.prototype.initWorkArea=function(a){null==this.hn&&(this.hn=new Int32Array(1),this.v=new Int32Array(a),this.c=new Int32Array(BMAX+1),this.r=new Int32Array(3),this.u=new Int32Array(BMAX),this.x=new Int32Array(BMAX+1));this.v.length<a&&(this.v=new Int32Array(a));for(var b=0;b<a;b++)this.v[b]=0;for(b=0;b<BMAX+1;b++)this.c[b]=0;for(b=0;3>b;b++)this.r[b]=0;arrayCopy(this.c,0,this.u,0,BMAX);arrayCopy(this.c,0,this.x,0,BMAX+1)};
var testArray=new Uint8Array(1),hasSubarray="function"===typeof testArray.subarray,hasSlice=!1;function arrayCopy(a,b,c,d,e){if(0!=e){if(a){if(!c)throw"Undef dest";}else throw"Undef src";0==b&&e==a.length?arrayCopy_fast(a,c,d):hasSubarray?arrayCopy_fast(a.subarray(b,b+e),c,d):1==a.BYTES_PER_ELEMENT&&100<e?arrayCopy_fast(new Uint8Array(a.buffer,a.byteOffset+b,e),c,d):arrayCopy_slow(a,b,c,d,e)}}function arrayCopy_slow(a,b,c,d,e){for(var f=0;f<e;++f)c[d+f]=a[b+f]}
function arrayCopy_fast(a,b,c){b.set(a,c)}var ADLER_BASE=65521,ADLER_NMAX=5552;
function adler32(a,b,c,d){if(null==b)return 1;var e=a&65535;a=a>>16&65535;for(var f;0<d;){f=d<ADLER_NMAX?d:ADLER_NMAX;for(d-=f;16<=f;)e+=b[c++]&255,a+=e,e+=b[c++]&255,a+=e,e+=b[c++]&255,a+=e,e+=b[c++]&255,a+=e,e+=b[c++]&255,a+=e,e+=b[c++]&255,a+=e,e+=b[c++]&255,a+=e,e+=b[c++]&255,a+=e,e+=b[c++]&255,a+=e,e+=b[c++]&255,a+=e,e+=b[c++]&255,a+=e,e+=b[c++]&255,a+=e,e+=b[c++]&255,a+=e,e+=b[c++]&255,a+=e,e+=b[c++]&255,a+=e,e+=b[c++]&255,a+=e,f-=16;if(0!=f){do e+=b[c++]&255,a+=e;while(0!=--f)}e%=ADLER_BASE;
a%=ADLER_BASE}return a<<16|e}
function jszlib_inflate_buffer(a,b,c,d){a=b?new Uint8Array(a,b,c):new Uint8Array(a);c=new ZStream;c.inflateInit(DEF_WBITS,!0);c.next_in=a;c.next_in_index=0;c.avail_in=a.length;a=[];for(var e=0;;){var f=new Uint8Array(32E3);c.next_out=f;c.next_out_index=0;c.avail_out=f.length;var h=c.inflate(Z_NO_FLUSH);if(h!=Z_OK&&h!=Z_STREAM_END)throw c.msg;if(0!=c.avail_out){var g=new Uint8Array(f.length-c.avail_out);arrayCopy(f,0,g,0,f.length-c.avail_out);f=g}a.push(f);e+=f.length;if(h==Z_STREAM_END)break}d&&(d[0]=
(b||0)+c.next_in_index);if(1==a.length)return a[0].buffer;b=new Uint8Array(e);for(c=d=0;c<a.length;++c)e=a[c],arrayCopy(e,0,b,d,e.length),d+=e.length;return b.buffer};
